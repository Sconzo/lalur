# Story 3.5: CRUD de Conta da Parte B (Manual)

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** criar, listar, visualizar, editar e inativar Contas da Parte B manualmente,
**so that** eu possa cadastrar os códigos da Parte B do LALUR de uma empresa.

---

## Acceptance Criteria

1. Controller `ContaDaParteBController` criado com endpoints:
   - `POST /api/v1/conta-parte-b` - criar conta (CONTADOR com header X-Company-Id)
   - `GET /api/v1/conta-parte-b` - listar contas com paginação (CONTADOR com header)
   - `GET /api/v1/conta-parte-b/{id}` - visualizar conta (CONTADOR com header)
   - `PUT /api/v1/conta-parte-b/{id}` - editar conta (CONTADOR com header)
   - `PATCH /api/v1/conta-parte-b/{id}/status` - alternar status (ativar/inativar, CONTADOR com header)

2. DTOs criados: `CreateContaDaParteBRequest`, `UpdateContaDaParteBRequest`, `ContaDaParteBResponse`

3. `CreateContaDaParteBRequest`:
   - `codigoDaContaB` (obrigatório, String)
   - `descricao` (obrigatório, String, max 1000 chars)
   - `fiscalYear` (obrigatório, Integer)

4. `ContaDaParteBResponse`:
   - `id`, `codigoDaContaB`, `descricao`, `fiscalYear`, `status`, `createdAt`, `updatedAt`

5. Use cases implementados:
   - `CreateContaDaParteBUseCase`: valida company via `CompanyContext`, verifica unicidade, salva
   - `ListContaDaParteBUseCase`: retorna contas da empresa no contexto
   - `GetContaDaParteBUseCase`: retorna conta por ID
   - `UpdateContaDaParteBUseCase`: permite editar (exceto codigoDaContaB e fiscalYear)
   - `ToggleContaDaParteBStatusUseCase`: alterna status entre ACTIVE e INACTIVE

6. Validações:
   - codigoDaContaB não pode ser vazio ou conter apenas espaços
   - descricao não pode ser vazia
   - fiscalYear deve ser >= 2000 e <= ano atual + 1
   - Combinação (company + codigoDaContaB + fiscalYear) deve ser única

7. Listagem suporta:
   - Paginação: `?page=0&size=100&sort=codigoDaContaB,asc`
   - Filtro por ano: `?fiscalYear=2024`
   - Busca: `?search=texto` (busca em codigoDaContaB e descricao)
   - Filtro por status: `?include_inactive=true` (padrão: apenas ACTIVE)

8. DTOs adicionais: `ToggleStatusRequest`, `ToggleStatusResponse` (reutilizados dos stories anteriores)

9. Teste valida:
   - CONTADOR consegue criar conta da Parte B
   - Código duplicado para mesma empresa/ano retorna 400
   - CONTADOR sem header X-Company-Id recebe 400
   - Edição não permite mudar codigoDaContaB ou fiscalYear
   - Toggle status funciona corretamente
   - Listagem com filtros funciona

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3, 4, 8)
  - [ ] CreateContaDaParteBRequest
  - [ ] UpdateContaDaParteBRequest
  - [ ] ContaDaParteBResponse
  - [ ] Reutilizar ToggleStatusRequest/Response

- [ ] Criar use cases (AC: 5, 6)
  - [ ] CreateContaDaParteBUseCase com validações
  - [ ] ListContaDaParteBUseCase com filtros
  - [ ] GetContaDaParteBUseCase
  - [ ] UpdateContaDaParteBUseCase (não permite editar codigo/fiscalYear)
  - [ ] ToggleContaDaParteBStatusUseCase

- [ ] Criar controller (AC: 1)
  - [ ] POST /api/v1/conta-parte-b
  - [ ] GET /api/v1/conta-parte-b (paginação + filtros)
  - [ ] GET /api/v1/conta-parte-b/{id}
  - [ ] PUT /api/v1/conta-parte-b/{id}
  - [ ] PATCH /api/v1/conta-parte-b/{id}/status

- [ ] Implementar contexto de empresa
  - [ ] Validar header X-Company-Id
  - [ ] CompanyContext para CONTADOR

- [ ] Criar testes de integração (AC: 9)
  - [ ] Teste: CONTADOR cria conta da Parte B
  - [ ] Teste: código duplicado retorna 400
  - [ ] Teste: CONTADOR sem header recebe 400
  - [ ] Teste: edição não permite mudar codigo/fiscalYear
  - [ ] Teste: toggle status funciona
  - [ ] Teste: listagem com filtros

---

## Dev Notes

### Endpoints REST

**POST /api/v1/conta-parte-b**
```json
{
  "codigoDaContaB": "B-001",
  "descricao": "Adições - Despesas não dedutíveis",
  "fiscalYear": 2024
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "codigoDaContaB": "B-001",
  "descricao": "Adições - Despesas não dedutíveis",
  "fiscalYear": 2024,
  "status": "ACTIVE",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

**GET /api/v1/conta-parte-b?fiscalYear=2024&page=0&size=20**
```json
{
  "content": [
    {
      "id": 1,
      "codigoDaContaB": "B-001",
      "descricao": "Adições - Despesas não dedutíveis",
      "fiscalYear": 2024,
      "status": "ACTIVE"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

### Validações de Negócio

- **codigoDaContaB**: não vazio, sem apenas espaços
- **descricao**: não vazia, max 1000 chars
- **fiscalYear**: >= 2000 e <= (ano atual + 1)
- **Unicidade**: (company_id + codigoDaContaB + fiscalYear) deve ser única
- **Contexto**: CONTADOR precisa de header X-Company-Id

### Filtros Suportados

- `?fiscalYear=2024` - filtrar por ano fiscal
- `?search=Adições` - buscar em codigoDaContaB e descricao
- `?include_inactive=true` - incluir contas inativas
- `?page=0&size=100&sort=codigoDaContaB,asc` - paginação

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
