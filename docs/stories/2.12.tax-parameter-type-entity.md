# Story 2.12: Entidade TaxParameterType e Refatoração de TaxParameter

## Status

**Approved**

---

## Story

**As a** ADMIN,
**I want** que os tipos de parâmetros tributários sejam entidades próprias gerenciáveis,
**so that** eu possa criar tipos customizados de parâmetros e cada tipo já contenha sua natureza (GLOBAL, MENSAL, TRIMESTRAL) definida.

**Contexto:** Atualmente `TaxParameter` possui campos `type` (String livre) e `nature` (enum). Esta story extrai o conceito de "tipo" para uma entidade própria `TaxParameterType` que:
1. Permite criar e listar tipos pelo ADMIN
2. Encapsula a `nature` no tipo (não mais no parâmetro)
3. Estabelece relacionamento FK entre `TaxParameter` → `TaxParameterType`

---

## Acceptance Criteria

### AC1: Criar Entidade TaxParameterType

1. **Domain Model** `TaxParameterType.java` em `domain/model/`:
   ```java
   public class TaxParameterType {
       private Long id;
       private String description;
       private ParameterNature nature; // GLOBAL, MONTHLY, QUARTERLY
       private Status status;
       // auditing fields
   }
   ```

2. **JPA Entity** `TaxParameterTypeEntity.java` em `infrastructure/adapter/out/persistence/entity/`:
   - Tabela: `tb_tipos_parametros_tributarios`
   - Coluna `descricao` (VARCHAR 255, NOT NULL, UNIQUE)
   - Coluna `natureza` (VARCHAR 20, NOT NULL, CHECK IN ('GLOBAL', 'MONTHLY', 'QUARTERLY'))
   - Colunas de auditoria padrão (status, criado_em, atualizado_em, criado_por, atualizado_por)

3. **Migration** `V009__create_tax_parameter_type.sql`:
   - Criar tabela `tb_tipos_parametros_tributarios`
   - Migrar dados: criar tipos únicos a partir de valores existentes em `tb_parametros_tributarios.tipo`
   - Adicionar coluna `tipo_parametro_id` (FK) em `tb_parametros_tributarios`
   - Popular FK com base no mapeamento tipo → tipo_parametro_id
   - Remover coluna `tipo` de `tb_parametros_tributarios`
   - Remover coluna `natureza` de `tb_parametros_tributarios` (agora está em TaxParameterType)

### AC2: Repository e Port para TaxParameterType

4. **Port** `TaxParameterTypeRepositoryPort.java` em `application/port/out/`:
   - `Optional<TaxParameterType> findById(Long id)`
   - `TaxParameterType save(TaxParameterType type)`
   - `List<TaxParameterType> findAll()`
   - `boolean existsByDescription(String description)`

5. **JPA Repository** `TaxParameterTypeJpaRepository.java`:
   - `Optional<TaxParameterTypeEntity> findByDescricao(String descricao)`
   - `List<TaxParameterTypeEntity> findAllByStatusOrderByDescricaoAsc(Status status)`

6. **Adapter** `TaxParameterTypeRepositoryAdapter.java` implementa o port

7. **Mapper** `TaxParameterTypeMapper.java` (MapStruct)

### AC3: Endpoints de TaxParameterType (ADMIN only) - Apenas LIST e CREATE

8. **Controller** `TaxParameterTypeController.java`:
   - `POST /api/v1/tax-parameter-types` - criar tipo
   - `GET /api/v1/tax-parameter-types` - listar todos os tipos ativos

9. **DTOs**:
   - `CreateTaxParameterTypeRequest`: `description` (obrigatório), `nature` (obrigatório)
   - `TaxParameterTypeResponse`: `id`, `description`, `nature`, `status`, `createdAt`, `updatedAt`

10. **Service** `TaxParameterTypeService.java`:
    - Implementar `CreateTaxParameterTypeUseCase`
    - Implementar `ListTaxParameterTypesUseCase`
    - Validar: description não pode duplicar (unique)

### AC4: Refatorar TaxParameter

11. **Domain Model** `TaxParameter.java`:
    - Remover campo `type` (String)
    - Remover campo `nature` (ParameterNature)
    - Adicionar campo `typeId` (Long)

12. **JPA Entity** `TaxParameterEntity.java`:
    - Remover coluna `tipo`
    - Remover coluna `natureza`
    - Adicionar `@ManyToOne` para `TaxParameterTypeEntity`
    - Coluna FK: `tipo_parametro_id`

13. **DTOs de TaxParameter**:
    - `CreateTaxParameterRequest`: substituir `type`/`nature` por `typeId` (obrigatório)
    - `UpdateTaxParameterRequest`: substituir `type`/`nature` por `typeId` (obrigatório)
    - `TaxParameterResponse`: incluir objeto `type` (TaxParameterTypeResponse) ao invés de strings

14. **Service** `TaxParameterService.java`:
    - Atualizar criação para usar typeId
    - Remover filtro por `type` (String), adicionar filtro por `typeId`
    - Atualizar endpoint `/grouped` para buscar nature via TaxParameterType
    - Remover endpoint `/filter-options/types` (substituído por GET /tax-parameter-types)

### AC5: Atualizar Validação de Valores Temporais

15. **CompanyService** - validação ao criar valores temporais:
    - Buscar TaxParameter → TaxParameterType → nature
    - Validar conforme nature do TIPO (não mais do parâmetro)

### AC6: Testes de Integração

16. Testes para TaxParameterType:
    - Criar tipo com cada nature (GLOBAL, MONTHLY, QUARTERLY)
    - Listar todos tipos
    - Erro ao criar tipo com description duplicada
    - CONTADOR recebe 403 em todos endpoints

17. Testes para TaxParameter refatorado:
    - Criar parâmetro com typeId válido
    - Erro ao criar parâmetro com typeId inválido
    - Response inclui type object
    - Validação de valores temporais usa nature do tipo

---

## Tasks / Subtasks

- [ ] **Task 1: Criar Migration** (AC: 1.3)
  - [ ] Criar `V009__create_tax_parameter_type.sql`
  - [ ] DDL para `tb_tipos_parametros_tributarios`
  - [ ] Script de migração de dados existentes
  - [ ] Adicionar FK em `tb_parametros_tributarios`
  - [ ] Remover colunas `tipo` e `natureza` de `tb_parametros_tributarios`

- [ ] **Task 2: Criar Domain Model TaxParameterType** (AC: 1.1)
  - [ ] POJO puro em `domain/model/`
  - [ ] Sem dependências de Spring/JPA

- [ ] **Task 3: Criar JPA Entity TaxParameterTypeEntity** (AC: 1.2)
  - [ ] Estender BaseEntity
  - [ ] Mapear tabela `tb_tipos_parametros_tributarios`
  - [ ] Configurar @Enumerated para natureza

- [ ] **Task 4: Criar Port e Repository** (AC: 2)
  - [ ] TaxParameterTypeRepositoryPort
  - [ ] TaxParameterTypeJpaRepository
  - [ ] TaxParameterTypeRepositoryAdapter
  - [ ] TaxParameterTypeMapper

- [ ] **Task 5: Criar Service TaxParameterType** (AC: 3.10)
  - [ ] Implementar CreateTaxParameterTypeUseCase
  - [ ] Implementar ListTaxParameterTypesUseCase
  - [ ] Validação: description única

- [ ] **Task 6: Criar Controller e DTOs** (AC: 3.8, 3.9)
  - [ ] CreateTaxParameterTypeRequest
  - [ ] TaxParameterTypeResponse
  - [ ] TaxParameterTypeController (apenas POST e GET)

- [ ] **Task 7: Refatorar TaxParameter Domain/Entity** (AC: 4.11, 4.12)
  - [ ] Atualizar TaxParameter.java (domain)
  - [ ] Atualizar TaxParameterEntity.java (adicionar @ManyToOne)
  - [ ] Atualizar TaxParameterMapper

- [ ] **Task 8: Refatorar TaxParameter DTOs e Service** (AC: 4.13, 4.14)
  - [ ] Atualizar CreateTaxParameterRequest (typeId)
  - [ ] Atualizar UpdateTaxParameterRequest (typeId)
  - [ ] Atualizar TaxParameterResponse (incluir type object)
  - [ ] Atualizar TaxParameterService
  - [ ] Atualizar TaxParameterController (remover /filter-options/types)

- [ ] **Task 9: Atualizar Validação de Valores Temporais** (AC: 5)
  - [ ] Refatorar CompanyService.createTemporalValue()
  - [ ] Buscar nature via TaxParameter → TaxParameterType

- [ ] **Task 10: Testes de Integração** (AC: 6)
  - [ ] TaxParameterTypeRepositoryAdapterTest
  - [ ] TaxParameterTypeControllerTest
  - [ ] Atualizar TaxParameterControllerTest
  - [ ] Atualizar TaxParameterRepositoryAdapterTest

---

## Dev Notes

### Source Tree - Novos Arquivos

```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       └── TaxParameterType.java  (NOVO)
├── application/
│   ├── port/
│   │   ├── in/
│   │   │   └── taxparametertype/
│   │   │       ├── CreateTaxParameterTypeUseCase.java  (NOVO)
│   │   │       └── ListTaxParameterTypesUseCase.java   (NOVO)
│   │   └── out/
│   │       └── TaxParameterTypeRepositoryPort.java     (NOVO)
│   └── service/
│       └── TaxParameterTypeService.java                (NOVO)
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── TaxParameterTypeController.java     (NOVO)
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── TaxParameterTypeEntity.java     (NOVO)
    │           ├── repository/
    │           │   └── TaxParameterTypeJpaRepository.java (NOVO)
    │           ├── adapter/
    │           │   └── TaxParameterTypeRepositoryAdapter.java (NOVO)
    │           └── mapper/
    │               └── TaxParameterTypeMapper.java     (NOVO)
    └── dto/
        └── taxparametertype/
            ├── CreateTaxParameterTypeRequest.java      (NOVO)
            └── TaxParameterTypeResponse.java           (NOVO)

src/main/resources/db/migration/
└── V009__create_tax_parameter_type.sql                 (NOVO)
```

### Source Tree - Arquivos Modificados

```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       └── TaxParameter.java                           (MODIFICADO - remover type/nature, adicionar typeId)
├── application/
│   ├── port/
│   │   └── in/
│   │       └── taxparameter/
│   │           └── GetTaxParameterTypesUseCase.java    (REMOVER - substituído por ListTaxParameterTypesUseCase)
│   └── service/
│       ├── TaxParameterService.java                    (MODIFICADO)
│       └── CompanyService.java                         (MODIFICADO - validação temporal)
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── TaxParameterController.java         (MODIFICADO - remover /filter-options/types)
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── TaxParameterEntity.java         (MODIFICADO - FK para TaxParameterType)
    │           └── mapper/
    │               └── TaxParameterMapper.java         (MODIFICADO)
    └── dto/
        └── taxparameter/
            ├── CreateTaxParameterRequest.java          (MODIFICADO - typeId)
            ├── UpdateTaxParameterRequest.java          (MODIFICADO - typeId)
            └── TaxParameterResponse.java               (MODIFICADO - incluir type object)
```

### Migration SQL - V009

```sql
-- ============================================================================
-- V009: Criar tabela TaxParameterType e refatorar TaxParameter
-- ============================================================================

-- 1. Criar tabela tb_tipos_parametros_tributarios
CREATE TABLE tb_tipos_parametros_tributarios (
    id BIGSERIAL PRIMARY KEY,
    descricao VARCHAR(255) NOT NULL UNIQUE,
    natureza VARCHAR(20) NOT NULL CHECK (natureza IN ('GLOBAL', 'MONTHLY', 'QUARTERLY')),
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'INACTIVE')),
    criado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    atualizado_em TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    criado_por BIGINT REFERENCES tb_usuario(id),
    atualizado_por BIGINT REFERENCES tb_usuario(id)
);

CREATE INDEX idx_tipo_param_natureza ON tb_tipos_parametros_tributarios(natureza);
CREATE INDEX idx_tipo_param_status ON tb_tipos_parametros_tributarios(status);

-- 2. Migrar dados: criar tipos únicos a partir de valores existentes
INSERT INTO tb_tipos_parametros_tributarios (descricao, natureza, status)
SELECT DISTINCT
    tipo as descricao,
    COALESCE(natureza, 'GLOBAL') as natureza,
    'ACTIVE' as status
FROM tb_parametros_tributarios
WHERE tipo IS NOT NULL;

-- 3. Adicionar coluna FK em tb_parametros_tributarios
ALTER TABLE tb_parametros_tributarios
ADD COLUMN tipo_parametro_id BIGINT REFERENCES tb_tipos_parametros_tributarios(id);

-- 4. Popular FK com base no mapeamento tipo → tipo_parametro_id
UPDATE tb_parametros_tributarios p
SET tipo_parametro_id = t.id
FROM tb_tipos_parametros_tributarios t
WHERE p.tipo = t.descricao;

-- 5. Tornar FK obrigatória (após migração de dados)
ALTER TABLE tb_parametros_tributarios
ALTER COLUMN tipo_parametro_id SET NOT NULL;

-- 6. Remover colunas antigas
ALTER TABLE tb_parametros_tributarios DROP COLUMN IF EXISTS tipo;

-- 6.1 Remover constraint e índice de natureza (criados em V007)
DROP INDEX IF EXISTS idx_parametros_tributarios_natureza;
ALTER TABLE tb_parametros_tributarios DROP CONSTRAINT IF EXISTS chk_natureza;
ALTER TABLE tb_parametros_tributarios DROP COLUMN IF EXISTS natureza;

-- 7. Criar índice na FK
CREATE INDEX idx_param_tipo_id ON tb_parametros_tributarios(tipo_parametro_id);

-- 8. Trigger de auditoria para nova tabela
CREATE TRIGGER trg_tipo_param_atualizado_em
    BEFORE UPDATE ON tb_tipos_parametros_tributarios
    FOR EACH ROW
    EXECUTE FUNCTION atualizar_timestamp_modificacao();
```

### Estrutura de Banco - Antes vs Depois

**Antes (tb_parametros_tributarios):**
| Coluna | Tipo |
|--------|------|
| id | BIGSERIAL |
| codigo | VARCHAR(100) |
| tipo | VARCHAR(50) |
| descricao | TEXT |
| natureza | VARCHAR(20) |
| status | VARCHAR(20) |
| ... auditoria |

**Depois (tb_parametros_tributarios):**
| Coluna | Tipo |
|--------|------|
| id | BIGSERIAL |
| codigo | VARCHAR(100) |
| tipo_parametro_id | BIGINT FK |
| descricao | TEXT |
| status | VARCHAR(20) |
| ... auditoria |

**Nova (tb_tipos_parametros_tributarios):**
| Coluna | Tipo |
|--------|------|
| id | BIGSERIAL |
| descricao | VARCHAR(255) UNIQUE |
| natureza | VARCHAR(20) |
| status | VARCHAR(20) |
| ... auditoria |

### Endpoints da API

**TaxParameterType (NOVO):**
| Método | Endpoint | Descrição |
|--------|----------|-----------|
| POST | `/api/v1/tax-parameter-types` | Criar novo tipo |
| GET | `/api/v1/tax-parameter-types` | Listar todos tipos ativos |

**TaxParameter (MODIFICADO):**
- Request agora usa `typeId` ao invés de `type` e `nature`
- Response agora inclui objeto `type` completo
- Remover endpoint `GET /tax-parameters/filter-options/types`

### Endpoint /grouped - Comportamento Atualizado

O endpoint `GET /tax-parameters/grouped` continua funcionando, mas agora:
- Agrupa por `TaxParameterType.description` (antes era `TaxParameter.type`)
- Busca `nature` via `TaxParameterType.nature` (antes era `TaxParameter.nature`)

### Testing

**Test Location:**
```
src/test/java/br/com/lalurecf/
└── infrastructure/
    └── adapter/
        ├── in/
        │   └── rest/
        │       └── TaxParameterTypeControllerTest.java  (NOVO)
        └── out/
            └── persistence/
                └── adapter/
                    └── TaxParameterTypeRepositoryAdapterTest.java (NOVO)
```

**Cenários de Teste - TaxParameterType:**
1. ADMIN cria tipo com nature GLOBAL - 201 Created
2. ADMIN cria tipo com nature MONTHLY - 201 Created
3. ADMIN cria tipo com nature QUARTERLY - 201 Created
4. Erro ao criar tipo com description duplicada - 400 Bad Request
5. ADMIN lista todos tipos - 200 OK
6. CONTADOR recebe 403 em POST
7. CONTADOR recebe 403 em GET

**Cenários de Teste - TaxParameter Refatorado:**
1. Criar parâmetro com typeId válido - 201 Created
2. Erro ao criar parâmetro com typeId inválido - 400 Bad Request
3. Response inclui objeto type completo
4. Atualizar parâmetro com novo typeId
5. Endpoint /grouped funciona com nova estrutura

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-02 | 1.0 | Story criada - refatoração de TaxParameter para usar TaxParameterType | James (Dev) |
| 2026-02-02 | 1.1 | Simplificada - apenas LIST e CREATE para TaxParameterType | James (Dev) |

---

## Dev Agent Record

### Agent Model Used

*A ser preenchido durante implementação*

### Debug Log References

*A ser preenchido durante implementação*

### Completion Notes List

*A ser preenchido durante implementação*

### File List

*A ser preenchido durante implementação*

---

## QA Results

*A ser preenchido após revisão de QA*
