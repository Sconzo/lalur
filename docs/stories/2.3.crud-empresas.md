# Story 2.3: CRUD de Empresas

## Status

**✅ Implementation Complete - 95%**

### Progresso Atual

✅ **Completado:**
- DTOs criados (7 arquivos) com Bean Validation
- Use Cases definidos (5 interfaces)
- CompanyStatus enum criado
- Repository estendido com JpaSpecificationExecutor e queries customizadas
- **CompanyService implementado (275 linhas)** - Todos 5 use cases
- **CompanyController estendido (290 linhas)** - 8 endpoints total

⏳ **Pendente:**
- Testes de integração (a serem criados em próxima sessão)
- Validação final com build

---

## Story

**As a** ADMIN,
**I want** criar, listar, visualizar, editar e inativar empresas,
**so that** eu possa gerenciar as empresas cadastradas no sistema.

---

## Acceptance Criteria

1. Controller `CompanyController` criado com endpoints (todos ADMIN only):
   - `POST /api/v1/companies` - criar empresa
   - `GET /api/v1/companies` - listar todas empresas com paginação
   - `GET /api/v1/companies/{id}` - visualizar empresa
   - `PUT /api/v1/companies/{id}` - editar empresa
   - `PATCH /api/v1/companies/{id}/status` - alternar status da empresa (ativar/inativar)

2. DTOs criados: `CreateCompanyRequest`, `UpdateCompanyRequest`, `CompanyResponse`

3. `CreateCompanyRequest`:
   - `cnpj` (obrigatório, 14 dígitos)
   - `razaoSocial` (obrigatório)
   - `cnae` (obrigatório)
   - `qualificacaoPessoaJuridica` (obrigatório)
   - `naturezaJuridica` (obrigatório)
   - `periodoContabil` (obrigatório, formato ISO 8601: YYYY-MM-DD)
   - `parametrosTributariosIds` (lista de IDs - opcional)

4. `CompanyResponse` (para listagem):
   - `id`, `cnpj` (formatado 00.000.000/0000-00), `status`, `razaoSocial`, `cnae`, `qualificacaoPessoaJuridica`, `naturezaJuridica`

5. `CompanyDetailResponse` (para visualização individual):
   - Todos campos de `CompanyResponse` + `periodoContabil`, `parametrosTributarios` (lista simplificada), `createdAt`, `updatedAt`

6. Use cases implementados:
   - `CreateCompanyUseCase`: valida CNPJ, verifica duplicata, salva empresa
   - `ListCompaniesUseCase`: retorna todas empresas (apenas ADMIN acessa)
   - `GetCompanyUseCase`: retorna empresa por ID (apenas ADMIN acessa)
   - `UpdateCompanyUseCase`: permite editar empresa (exceto CNPJ) (apenas ADMIN)
   - `ToggleCompanyStatusUseCase`: alterna status entre ACTIVE e INACTIVE (apenas ADMIN)

7. Validações no `CreateCompanyUseCase`:
   - CNPJ válido (formato e dígitos verificadores)
   - CNPJ único (não pode já existir ACTIVE)
   - Período Contábil não pode ser no futuro
   - Parâmetros tributários devem existir (se fornecidos)

8. **Listagem de empresas** (`GET /api/v1/companies`):
   - **Colunas retornadas** (ordem):
     1. CNPJ (formatado: 00.000.000/0000-00)
     2. Status (ACTIVE/INACTIVE)
     3. Razão Social
     4. CNAE
     5. Qualificação da Pessoa Jurídica
     6. Natureza Jurídica
   - **Filtro Global** (`?globalSearch=texto`):
     - Busca em todos os campos da tabela simultaneamente (CNPJ, Razão Social, CNAE, Qualificação PJ, Natureza Jurídica)
     - Case insensitive
   - **Filtros Específicos com dropdown e busca interna**:
     - **Filtro por CNPJ** (`?cnpjFilter=00.000.000/0000-00`)
     - **Filtro por Razão Social** (`?razaoSocialFilter=Nome Empresa`)
   - **Paginação**: `?page=0&size=20&sort=razaoSocial,asc`
   - **Filtro por status**: `?include_inactive=true` (padrão: apenas ACTIVE)
   - **Ordenação**: Suporta ordenação por qualquer coluna (`?sort={campo},{asc|desc}`)

9. **Endpoints auxiliares para filtros**:
   - `GET /api/v1/companies/filter-options/cnpj?search={texto}` (ADMIN only):
     - DTO Response: `FilterOptionsResponse` com `List<String> options` (lista de CNPJs únicos formatados)
     - Query `search` opcional - se fornecido, filtra CNPJs que contêm o texto
     - Retorna apenas CNPJs de empresas ACTIVE (a menos que `include_inactive=true`)
     - Máximo 100 resultados
     - Ordenado alfabeticamente
   - `GET /api/v1/companies/filter-options/razao-social?search={texto}` (ADMIN only):
     - DTO Response: `FilterOptionsResponse` com `List<String> options` (lista de Razões Sociais únicas)
     - Query `search` opcional - se fornecido, filtra Razões Sociais que contêm o texto
     - Retorna apenas de empresas ACTIVE (a menos que `include_inactive=true`)
     - Máximo 100 resultados
     - Ordenado alfabeticamente

10. Todos endpoints protegidos com `@PreAuthorize("hasRole('ADMIN')")`

11. DTO adicional `ToggleStatusRequest`: `status` (obrigatório, enum: ACTIVE ou INACTIVE)

12. DTO `ToggleStatusResponse`: `success` (boolean), `message`, `newStatus`

13. DTO `FilterOptionsResponse`: `List<String> options`

14. Teste valida:
    - ADMIN consegue criar empresa
    - CNPJ duplicado retorna 400 Bad Request
    - CNPJ inválido retorna 400 Bad Request
    - CONTADOR recebe 403 ao tentar acessar qualquer endpoint de CRUD
    - ADMIN vê todas empresas na listagem com colunas corretas
    - Filtro global busca em todos os campos simultaneamente
    - Endpoint `/filter-options/cnpj` retorna lista de CNPJs únicos
    - Endpoint `/filter-options/cnpj?search=12345` filtra CNPJs que contêm "12345"
    - Endpoint `/filter-options/razao-social?search=Acme` filtra razões sociais que contêm "Acme"
    - Filtro `cnpjFilter` filtra listagem por CNPJ específico
    - Filtro `razaoSocialFilter` filtra listagem por Razão Social específica
    - Filtros podem ser combinados (globalSearch + cnpjFilter + razaoSocialFilter)
    - Toggle status: ACTIVE → INACTIVE funciona
    - Toggle status: INACTIVE → ACTIVE funciona
    - Empresa inativada não aparece na listagem padrão
    - Empresa inativada aparece com include_inactive=true
    - Ordenação por qualquer coluna funciona corretamente

---

## Tasks / Subtasks

- [ ] Criar DTOs de Request e Response (AC: 2, 3, 4, 5, 11, 12, 13)
  - [ ] Criar `CreateCompanyRequest` com validações Bean Validation
  - [ ] Criar `UpdateCompanyRequest` (sem CNPJ)
  - [ ] Criar `CompanyResponse` (listagem)
  - [ ] Criar `CompanyDetailResponse` (detalhes)
  - [ ] Criar `ToggleStatusRequest` e `ToggleStatusResponse`
  - [ ] Criar `FilterOptionsResponse`

- [ ] Criar Use Cases (AC: 6, 7)
  - [ ] Implementar `CreateCompanyUseCase` com todas validações
  - [ ] Implementar `ListCompaniesUseCase` com filtros e paginação
  - [ ] Implementar `GetCompanyUseCase`
  - [ ] Implementar `UpdateCompanyUseCase` (sem permitir alterar CNPJ)
  - [ ] Implementar `ToggleCompanyStatusUseCase`

- [ ] Criar Controller com endpoints CRUD (AC: 1, 8, 9, 10)
  - [ ] Criar `POST /api/v1/companies`
  - [ ] Criar `GET /api/v1/companies` com filtros (global, CNPJ, Razão Social)
  - [ ] Criar `GET /api/v1/companies/{id}`
  - [ ] Criar `PUT /api/v1/companies/{id}`
  - [ ] Criar `PATCH /api/v1/companies/{id}/status`
  - [ ] Criar `GET /api/v1/companies/filter-options/cnpj`
  - [ ] Criar `GET /api/v1/companies/filter-options/razao-social`
  - [ ] Adicionar `@PreAuthorize("hasRole('ADMIN')")` em todos endpoints

- [ ] Implementar filtros de listagem (AC: 8, 9)
  - [ ] Implementar filtro global (busca em todos campos)
  - [ ] Implementar filtro específico por CNPJ
  - [ ] Implementar filtro específico por Razão Social
  - [ ] Implementar combinação de filtros
  - [ ] Implementar paginação (Pageable)
  - [ ] Implementar ordenação dinâmica
  - [ ] Implementar `include_inactive` parameter

- [ ] Implementar endpoints de filter options (AC: 9)
  - [ ] Endpoint para listar CNPJs únicos com busca
  - [ ] Endpoint para listar Razões Sociais únicas com busca
  - [ ] Aplicar limite de 100 resultados
  - [ ] Ordenar alfabeticamente

- [ ] Criar testes de integração (AC: 14)
  - [ ] Testar criação de empresa (ADMIN)
  - [ ] Testar CNPJ duplicado retorna 400
  - [ ] Testar CNPJ inválido retorna 400
  - [ ] Testar CONTADOR recebe 403
  - [ ] Testar listagem com colunas corretas
  - [ ] Testar filtro global
  - [ ] Testar filtros específicos (CNPJ, Razão Social)
  - [ ] Testar combinação de filtros
  - [ ] Testar endpoints de filter options
  - [ ] Testar toggle status (ACTIVE ↔ INACTIVE)
  - [ ] Testar `include_inactive` parameter
  - [ ] Testar ordenação por colunas

---

## Dev Notes

### Hexagonal Architecture
- **Use Cases**: Interfaces em `application/port/in/company/`
- **Services**: Implementações em `application/service/`
- **Controller**: `infrastructure/adapter/in/rest/CompanyController.java`
- **DTOs**: `infrastructure/dto/company/`

### Source Tree
```
src/main/java/br/com/lalurecf/
├── application/
│   ├── port/
│   │   └── in/
│   │       └── company/
│   │           ├── CreateCompanyUseCase.java
│   │           ├── ListCompaniesUseCase.java
│   │           ├── GetCompanyUseCase.java
│   │           ├── UpdateCompanyUseCase.java
│   │           └── ToggleCompanyStatusUseCase.java
│   └── service/
│       └── CompanyService.java  # Implementa os use cases
└── infrastructure/
    ├── adapter/
    │   └── in/
    │       └── rest/
    │           └── CompanyController.java
    └── dto/
        └── company/
            ├── CreateCompanyRequest.java
            ├── UpdateCompanyRequest.java
            ├── CompanyResponse.java
            ├── CompanyDetailResponse.java
            ├── ToggleStatusRequest.java
            ├── ToggleStatusResponse.java
            └── FilterOptionsResponse.java
```

### Bean Validation
**Usar em DTOs de Request:**
```java
@NotNull
@Pattern(regexp = "\\d{14}", message = "CNPJ deve conter 14 dígitos")
private String cnpj;

@NotBlank
@Size(max = 255)
private String razaoSocial;

@NotNull
@PastOrPresent
private LocalDate periodoContabil;
```

### Spring Security
- Todos endpoints requerem role ADMIN
- Usar `@PreAuthorize("hasRole('ADMIN')")`
- CONTADOR deve receber 403 Forbidden

### Filtros e Paginação
**Query Examples:**
```
GET /api/v1/companies?page=0&size=20&sort=razaoSocial,asc
GET /api/v1/companies?globalSearch=banco
GET /api/v1/companies?cnpjFilter=00.000.000/0000-00
GET /api/v1/companies?razaoSocialFilter=Banco do Brasil
GET /api/v1/companies?globalSearch=banco&cnpjFilter=00000000&include_inactive=true
```

**Implementação com Spring Data JPA:**
- Usar `Specification<CompanyEntity>` para filtros dinâmicos
- Combinar múltiplas specifications com `and()`
- Usar `Pageable` do Spring para paginação

### Padrões de Código
- **Transações:** `@Transactional` nos métodos do Service
- **Validação:** Bean Validation em DTOs, lógica de negócio no Domain
- **Response:** SEMPRE DTOs (nunca expor Entities)
- **JSON:** camelCase (nunca snake_case nos DTOs)

### Testing

#### Estratégia de Testes
- **Controller Tests:** MockMvc + `@SpringBootTest`
- **Use Case Tests:** Mockito para mockar repositories
- **Integration Tests:** TestContainers com PostgreSQL

#### Test Location
```
src/test/java/br/com/lalurecf/
├── application/
│   └── service/
│       └── CompanyServiceTest.java  # Unit test
└── infrastructure/
    └── adapter/
        └── in/
            └── rest/
                └── CompanyControllerTest.java  # Integration test
```

#### Cenários de Teste Críticos
1. Segurança: CONTADOR não pode acessar (403)
2. Validação: CNPJ duplicado/inválido
3. Filtros: Combinação de filtros funciona
4. Paginação: Ordenação por qualquer coluna
5. Status: Toggle ACTIVE ↔ INACTIVE

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- Date: 2025-11-18 (In Progress)

### Debug Log References
*Em progresso - será preenchido após conclusão*

### Completion Notes List

**Fase 1 - DTOs e Interfaces (Completa):**

1. ✅ **DTOs Criados** (`infrastructure/dto/company/`):
   - `CreateCompanyRequest.java` - Bean Validation configurado
   - `UpdateCompanyRequest.java` - Todos campos exceto CNPJ
   - `CompanyResponse.java` - Para listagem
   - `CompanyDetailResponse.java` - Para visualização individual
   - `ToggleStatusRequest.java` - Alteração de status
   - `ToggleStatusResponse.java` - Resposta de toggle
   - `FilterOptionsResponse.java` - Opções para dropdowns

2. ✅ **Use Cases Definidos** (`application/port/in/company/`):
   - `CreateCompanyUseCase.java` - Criação com validações
   - `ListCompaniesUseCase.java` - Listagem com filtros e paginação
   - `GetCompanyUseCase.java` - Busca por ID
   - `UpdateCompanyUseCase.java` - Atualização (CNPJ imutável)
   - `ToggleCompanyStatusUseCase.java` - Toggle ACTIVE ↔ INACTIVE

3. ✅ **CompanyStatus Enum** (`domain/model/`):
   - Type alias para Status do domínio
   - Métodos de conversão `toStatus()` e `fromStatus()`
   - Mantém nomenclatura semântica nos DTOs

4. ✅ **Repository Estendido** (`infrastructure/adapter/out/persistence/repository/`):
   - Adicionado `JpaSpecificationExecutor` para filtros dinâmicos
   - Query `findByCnpjAndStatus` - busca empresa ativa por CNPJ
   - Query `findDistinctCnpjsByStatus` - CNPJs únicos para filtros
   - Query `findDistinctRazaoSocialByStatus` - Razões Sociais únicas para filtros

**Fase 2 - Service e Controller (Completa):**

✅ **CompanyService** - Implementado (275 linhas):
   - ✅ Implementados todos os 5 use cases
   - ✅ `Specification<CompanyEntity>` para filtros dinâmicos
   - ✅ Métodos de mapeamento Entity ↔ DTO
   - ✅ Formatação de CNPJ (00.000.000/0000-00)
   - ✅ Validações de negócio (CNPJ duplicado, formato válido)
   - ✅ Filtros: global, por CNPJ, por Razão Social, combinados
   - ✅ Paginação e ordenação dinâmica

✅ **CompanyController** - Estendido (290 linhas):
   - ✅ 8 endpoints implementados:
     - POST /companies - Criar empresa
     - GET /companies - Listar com filtros
     - GET /companies/{id} - Visualizar detalhes
     - PUT /companies/{id} - Atualizar empresa
     - PATCH /companies/{id}/status - Toggle status
     - GET /companies/filter-options/cnpj - Opções filtro CNPJ
     - GET /companies/filter-options/razao-social - Opções filtro Razão Social
     - GET /companies/search-cnpj/{cnpj} - Buscar na BrasilAPI (mantido da Story 2.2)
   - ✅ Todos protegidos com `@PreAuthorize("hasRole('ADMIN')")`
   - ✅ Bean Validation ativado (@Valid)

**Fase 3 - Testes (Pendente):**

⏳ **Testes de Integração**:
   - CompanyServiceTest (unit tests)
   - CompanyControllerTest (integration tests com MockMvc)
   - Cenários de validação, filtros, paginação, segurança

### File List

**Production Code (Criados):**
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/CreateCompanyRequest.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/UpdateCompanyRequest.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/CompanyResponse.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/CompanyDetailResponse.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/ToggleStatusRequest.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/ToggleStatusResponse.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/dto/company/FilterOptionsResponse.java` (NEW)
- `src/main/java/br/com/lalurecf/application/port/in/company/CreateCompanyUseCase.java` (NEW)
- `src/main/java/br/com/lalurecf/application/port/in/company/ListCompaniesUseCase.java` (NEW)
- `src/main/java/br/com/lalurecf/application/port/in/company/GetCompanyUseCase.java` (NEW)
- `src/main/java/br/com/lalurecf/application/port/in/company/UpdateCompanyUseCase.java` (NEW)
- `src/main/java/br/com/lalurecf/application/port/in/company/ToggleCompanyStatusUseCase.java` (NEW)
- `src/main/java/br/com/lalurecf/domain/model/CompanyStatus.java` (NEW)
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/repository/CompanyJpaRepository.java` (MODIFIED)

**Production Code (Implementados):**
- `src/main/java/br/com/lalurecf/application/service/CompanyService.java` (NEW - 275 linhas)
  - Implementa todos 5 use cases
  - Specifications para filtros dinâmicos
  - Validações de negócio (CNPJ duplicado, formato, etc.)
  - Mapeamento Entity ↔ DTO
  - Formatação de CNPJ
- `src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/CompanyController.java` (EXTENDED - 290 linhas)
  - 8 endpoints REST (7 CRUD + 1 BrasilAPI)
  - Todos protegidos com @PreAuthorize("hasRole('ADMIN')")
  - Bean Validation ativado

**Test Code (A Criar):**
- `src/test/java/br/com/lalurecf/application/service/CompanyServiceTest.java` (PENDING)
- `src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/CompanyControllerCrudTest.java` (PENDING)

---

## QA Results
*A ser preenchido após revisão de QA*
