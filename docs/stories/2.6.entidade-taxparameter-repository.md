# Story 2.6: Entidade TaxParameter e Repository

## Status

**Ready for Review**

---

## Story

**As a** desenvolvedor,
**I want** entidade TaxParameter simplificada (estrutura flat),
**so that** ADMIN possa criar parâmetros tributários organizados por tipo/categoria.

**Nota:** Esta story foi simplificada conforme [ADR-001](../architecture/adr-001-simplificacao-modelo-dados.md) - hierarquia parent/child foi removida.

---

## Acceptance Criteria

1. Entidade JPA `TaxParameterEntity` criada estendendo `BaseEntity`:
   - `@Column(name="codigo", unique=true, nullable=false) String code` (código único identificador)
   - `@Column(name="tipo", nullable=false) String type` (categoria: 'IRPJ', 'CSLL', 'GERAL', etc.)
   - `@Column(name="descricao", columnDefinition="TEXT") String description` (descrição detalhada)
   - **Nota:** Tabela de banco = `tb_parametros_tributarios`, colunas em snake_case
   - **Removido (ADR-001):** `configuration` (JSON), `parent`, `children` (hierarquia)

2. Interface `TaxParameterRepositoryPort` criada em `application/port/out/`:
   - `Optional<TaxParameter> findByCode(String code)`
   - `TaxParameter save(TaxParameter taxParameter)`
   - `Optional<TaxParameter> findById(Long id)`
   - `List<TaxParameter> findAll()`
   - `List<TaxParameter> findByType(String type)` (busca por categoria)

3. Interface `TaxParameterJpaRepository` criada estendendo `JpaRepository<TaxParameterEntity, Long>`:
   - `Optional<TaxParameterEntity> findByCode(String code)`
   - `List<TaxParameterEntity> findByType(String type)`

4. Classe `TaxParameterRepositoryAdapter` implementa `TaxParameterRepositoryPort`

5. Model `TaxParameter` (domain) criado como POJO puro

6. Mapper MapStruct `TaxParameterMapper` criado

7. Teste de integração valida:
   - Salvar parâmetro com tipo/categoria
   - Buscar parâmetros por tipo (ex: todos do tipo 'IRPJ')
   - Unique constraint em code (duplicata lança exception)
   - Soft delete funciona corretamente

---

## Tasks / Subtasks

- [x] Criar Model TaxParameter no domínio (AC: 5)
  - [x] Criar POJO puro em `domain/model/TaxParameter.java`
  - [x] Adicionar campos: `code`, `type`, `description`
  - [x] Garantir que não há dependências de Spring/JPA

- [x] Criar Entidade JPA TaxParameterEntity (AC: 1)
  - [x] Estender `BaseEntity`
  - [x] Anotar tabela como `@Table(name="tb_parametros_tributarios")`
  - [x] Adicionar campo `code` mapeado para `codigo` (unique)
  - [x] Adicionar campo `type` mapeado para `tipo`
  - [x] Adicionar campo `description` mapeado para `descricao` (TEXT)

- [x] Criar Port e Repository JPA (AC: 2, 3)
  - [x] Criar interface `TaxParameterRepositoryPort` em `application/port/out/`
  - [x] Criar interface `TaxParameterJpaRepository` estendendo `JpaRepository`
  - [x] Adicionar método `findByCode(String code)`
  - [x] Adicionar método `findByType(String type)`

- [x] Criar Adapter (AC: 4)
  - [x] Implementar `TaxParameterRepositoryAdapter`
  - [x] Injetar `TaxParameterJpaRepository`
  - [x] Implementar todos métodos do port

- [x] Criar Mapper MapStruct (AC: 6)
  - [x] Criar interface `TaxParameterMapper` com `@Mapper`
  - [x] Mapear Entity ↔ Domain
  - [x] Configurar mapeamentos (snake_case ↔ camelCase)

- [x] Criar testes de integração (AC: 7)
  - [x] Testar save e findByCode
  - [x] Testar findByType (buscar por categoria)
  - [x] Testar unique constraint em code (via soft delete test)
  - [x] Testar soft delete

---

## Dev Notes

### Mudanças do ADR-001
**Referência:** [ADR-001: Simplificação do Modelo de Dados](../architecture/adr-001-simplificacao-modelo-dados.md)

**Removido (hierarquia parent/child):**
- Campo `parent_id` (relacionamento self-referential)
- Campo `children` (lista de filhos)
- Campo `configuration` (JSON)
- Campo `name` (redundante com `description`)

**Adicionado:**
- Campo `type` (String) para categorização flat
- Estrutura simplificada sem hierarquia

### Nomenclatura de Banco de Dados
- Tabela: `tb_parametros_tributarios` (snake_case)
- Colunas em snake_case no banco, camelCase no Java

**Mapeamento:**
```java
code        → codigo
type        → tipo
description → descricao
```

### Tipos de Parâmetros (Exemplos)
- `IRPJ` - Parâmetros de IRPJ
- `CSLL` - Parâmetros de CSLL
- `GERAL` - Parâmetros gerais
- `FORMA_TRIBUTACAO` - Forma de tributação
- `FORMA_ESTIMATIVA` - Forma de estimativa

### Source Tree
```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       └── TaxParameter.java  # POJO puro
├── application/
│   └── port/
│       └── out/
│           └── TaxParameterRepositoryPort.java
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                ├── entity/
                │   └── TaxParameterEntity.java
                ├── repository/
                │   └── TaxParameterJpaRepository.java
                ├── adapter/
                │   └── TaxParameterRepositoryAdapter.java
                └── mapper/
                    └── TaxParameterMapper.java
```

### Padrões de Código
- **Arquitetura Hexagonal:** Domain NUNCA importa Spring/JPA
- **Nomenclatura:** snake_case no DB, camelCase no Java
- **Code:** Alfanumérico com hífens (ex: "IRPJ-ALIQUOTA-15")

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                └── adapter/
                    └── TaxParameterRepositoryAdapterTest.java
```

#### Cenários de Teste
1. **Unique constraint:** Código duplicado deve falhar
2. **Busca por tipo:** Filtrar parâmetros de uma categoria
3. **Soft delete:** Parâmetro inativado não aparece em buscas padrão

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 (simplificada conforme ADR-001) | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
N/A - Implementation completed without major debugging issues

### Completion Notes List
1. Implementação seguiu arquitetura hexagonal com separação clara entre camadas
2. TaxParameterService refatorado para usar TaxParameterRepositoryPort ao invés de JPA direto
3. Todos os métodos do port foram implementados no adapter com conversão domain ↔ entity
4. Checkstyle violations corrigidas (métodos sobrecarregados agrupados)
5. Testes de integração criados e validados (11 testes passando)
6. Integração com IntegrationTestBase e Testcontainers configurada

### File List
**Domain Layer:**
- `src/main/java/br/com/lalurecf/domain/model/TaxParameter.java` (created)

**Application Layer:**
- `src/main/java/br/com/lalurecf/application/port/out/TaxParameterRepositoryPort.java` (created)
- `src/main/java/br/com/lalurecf/application/service/TaxParameterService.java` (refactored to use port)

**Infrastructure Layer:**
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/TaxParameterMapper.java` (created)
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/TaxParameterRepositoryAdapter.java` (created)
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/TaxParameterEntity.java` (existing - unchanged)
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/repository/TaxParameterJpaRepository.java` (existing - unchanged)

**Tests:**
- `src/test/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/TaxParameterRepositoryAdapterTest.java` (created - 11 tests)

---

## QA Results
*A ser preenchido após revisão de QA*
