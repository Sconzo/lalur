# Story 2.6: Entidade TaxParameter e Repository

## Status

**Draft**

---

## Story

**As a** desenvolvedor,
**I want** entidade TaxParameter simplificada (estrutura flat),
**so that** ADMIN possa criar parâmetros tributários organizados por tipo/categoria.

**Nota:** Esta story foi simplificada conforme [ADR-001](../architecture/adr-001-simplificacao-modelo-dados.md) - hierarquia parent/child foi removida.

---

## Acceptance Criteria

1. Entidade JPA `TaxParameterEntity` criada estendendo `BaseEntity`:
   - `@Column(name="codigo", unique=true, nullable=false) String code` (código único identificador)
   - `@Column(name="tipo", nullable=false) String type` (categoria: 'IRPJ', 'CSLL', 'GERAL', etc.)
   - `@Column(name="descricao", columnDefinition="TEXT") String description` (descrição detalhada)
   - **Nota:** Tabela de banco = `tb_parametros_tributarios`, colunas em snake_case
   - **Removido (ADR-001):** `configuration` (JSON), `parent`, `children` (hierarquia)

2. Interface `TaxParameterRepositoryPort` criada em `application/port/out/`:
   - `Optional<TaxParameter> findByCode(String code)`
   - `TaxParameter save(TaxParameter taxParameter)`
   - `Optional<TaxParameter> findById(Long id)`
   - `List<TaxParameter> findAll()`
   - `List<TaxParameter> findByType(String type)` (busca por categoria)

3. Interface `TaxParameterJpaRepository` criada estendendo `JpaRepository<TaxParameterEntity, Long>`:
   - `Optional<TaxParameterEntity> findByCode(String code)`
   - `List<TaxParameterEntity> findByType(String type)`

4. Classe `TaxParameterRepositoryAdapter` implementa `TaxParameterRepositoryPort`

5. Model `TaxParameter` (domain) criado como POJO puro

6. Mapper MapStruct `TaxParameterMapper` criado

7. Teste de integração valida:
   - Salvar parâmetro com tipo/categoria
   - Buscar parâmetros por tipo (ex: todos do tipo 'IRPJ')
   - Unique constraint em code (duplicata lança exception)
   - Soft delete funciona corretamente

---

## Tasks / Subtasks

- [ ] Criar Model TaxParameter no domínio (AC: 5)
  - [ ] Criar POJO puro em `domain/model/TaxParameter.java`
  - [ ] Adicionar campos: `code`, `type`, `description`
  - [ ] Garantir que não há dependências de Spring/JPA

- [ ] Criar Entidade JPA TaxParameterEntity (AC: 1)
  - [ ] Estender `BaseEntity`
  - [ ] Anotar tabela como `@Table(name="tb_parametros_tributarios")`
  - [ ] Adicionar campo `code` mapeado para `codigo` (unique)
  - [ ] Adicionar campo `type` mapeado para `tipo`
  - [ ] Adicionar campo `description` mapeado para `descricao` (TEXT)

- [ ] Criar Port e Repository JPA (AC: 2, 3)
  - [ ] Criar interface `TaxParameterRepositoryPort` em `application/port/out/`
  - [ ] Criar interface `TaxParameterJpaRepository` estendendo `JpaRepository`
  - [ ] Adicionar método `findByCode(String code)`
  - [ ] Adicionar método `findByType(String type)`

- [ ] Criar Adapter (AC: 4)
  - [ ] Implementar `TaxParameterRepositoryAdapter`
  - [ ] Injetar `TaxParameterJpaRepository`
  - [ ] Implementar todos métodos do port

- [ ] Criar Mapper MapStruct (AC: 6)
  - [ ] Criar interface `TaxParameterMapper` com `@Mapper`
  - [ ] Mapear Entity ↔ Domain
  - [ ] Configurar mapeamentos (snake_case ↔ camelCase)

- [ ] Criar testes de integração (AC: 7)
  - [ ] Testar save e findByCode
  - [ ] Testar findByType (buscar por categoria)
  - [ ] Testar unique constraint em code
  - [ ] Testar soft delete

---

## Dev Notes

### Mudanças do ADR-001
**Referência:** [ADR-001: Simplificação do Modelo de Dados](../architecture/adr-001-simplificacao-modelo-dados.md)

**Removido (hierarquia parent/child):**
- Campo `parent_id` (relacionamento self-referential)
- Campo `children` (lista de filhos)
- Campo `configuration` (JSON)
- Campo `name` (redundante com `description`)

**Adicionado:**
- Campo `type` (String) para categorização flat
- Estrutura simplificada sem hierarquia

### Nomenclatura de Banco de Dados
- Tabela: `tb_parametros_tributarios` (snake_case)
- Colunas em snake_case no banco, camelCase no Java

**Mapeamento:**
```java
code        → codigo
type        → tipo
description → descricao
```

### Tipos de Parâmetros (Exemplos)
- `IRPJ` - Parâmetros de IRPJ
- `CSLL` - Parâmetros de CSLL
- `GERAL` - Parâmetros gerais
- `FORMA_TRIBUTACAO` - Forma de tributação
- `FORMA_ESTIMATIVA` - Forma de estimativa

### Source Tree
```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       └── TaxParameter.java  # POJO puro
├── application/
│   └── port/
│       └── out/
│           └── TaxParameterRepositoryPort.java
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                ├── entity/
                │   └── TaxParameterEntity.java
                ├── repository/
                │   └── TaxParameterJpaRepository.java
                ├── adapter/
                │   └── TaxParameterRepositoryAdapter.java
                └── mapper/
                    └── TaxParameterMapper.java
```

### Padrões de Código
- **Arquitetura Hexagonal:** Domain NUNCA importa Spring/JPA
- **Nomenclatura:** snake_case no DB, camelCase no Java
- **Code:** Alfanumérico com hífens (ex: "IRPJ-ALIQUOTA-15")

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                └── adapter/
                    └── TaxParameterRepositoryAdapterTest.java
```

#### Cenários de Teste
1. **Unique constraint:** Código duplicado deve falhar
2. **Busca por tipo:** Filtrar parâmetros de uma categoria
3. **Soft delete:** Parâmetro inativado não aparece em buscas padrão

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 (simplificada conforme ADR-001) | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante implementação*

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
*A ser preenchido durante implementação*

### File List
*A ser preenchido durante implementação*

---

## QA Results
*A ser preenchido após revisão de QA*
