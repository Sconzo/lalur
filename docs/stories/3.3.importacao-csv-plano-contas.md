# Story 3.3: Importação de Plano de Contas via CSV/TXT

**Como** CONTADOR,
**Eu quero** importar plano de contas via CSV com campos ECF-specific,
**Para que** eu possa carregar rapidamente centenas de contas vinculadas a Contas Referenciais RFB.

## Acceptance Criteria

Ver Epic 3 Story 3.3 para critérios completos. Principais pontos:

1. **Endpoint** `POST /api/v1/chart-of-accounts/import`
2. **Formato CSV**: `code;name;accountType;contaReferencialCodigo;classe;nivel;natureza;afetaResultado;dedutivel`
3. **Separador**: `;` ou `,` (detectado automaticamente)
4. **Validação** de contaReferencialCodigo EXISTS e ACTIVE
5. **Use case** busca ContaReferencial por codigoRfb
6. **Dry-run mode** para preview sem persistir
7. **Max file size**: 10MB

## Definition of Done

- [x] Endpoint POST /api/v1/chart-of-accounts/import implementado
- [x] DTO ImportChartOfAccountResponse criado
- [x] Use case port ImportChartOfAccountUseCase criado
- [x] Service ImportChartOfAccountService implementado
- [x] Auto-detecção de separador (; ou ,)
- [x] Validações de contaReferencialCodigo, nivel (1-5), enums
- [x] Dry-run mode funcional
- [x] Testes passando (9/9)
- [ ] Code review
- [ ] Merge em develop

**Referência detalhada**: docs/epics/epic-03-plano-contas-dados-contabeis.md - Story 3.3

---

## Dev Agent Record

### Status
**Ready for Review** - Implementação completa de importação CSV com auto-detecção de separador, validações de vinculação RFB e dry-run (9/9 testes passando)

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- DTO `ImportChartOfAccountResponse` criado com preview e relatório de erros
- Use case port `ImportChartOfAccountUseCase` criado
- Service `ImportChartOfAccountService` implementado com:
  * Auto-detecção de separador (; ou ,)
  * Parse linha por linha usando Apache Commons CSV
  * Busca de ContaReferencial por codigoRfb
  * Validações completas: campos obrigatórios, enums (AccountType, ClasseContabil, NaturezaConta), nivel (1-5), booleans (true/false/yes/no/sim/não)
  * Tratamento de duplicatas (dentro do arquivo e no banco)
  * Dry-run mode para preview sem persistir
  * Encoding UTF-8
  * Max file size: 10MB
- Controller `ChartOfAccountController` atualizado com endpoint POST /import
  * Header Content-Type: multipart/form-data
  * Query params: fiscalYear (obrigatório), dryRun (opcional, default false)
  * Validação de company context (X-Company-Id)
- 9 testes de integração criados cobrindo:
  * Importação bem-sucedida com múltiplas contas
  * Dry-run funciona sem persistir
  * Campo obrigatório faltando registra erro
  * accountType inválido registra erro
  * contaReferencialCodigo inexistente registra erro
  * nivel fora do range (1-5) registra erro
  * Duplicatas dentro do arquivo são ignoradas
  * Detecção automática de separador vírgula
  * Encoding UTF-8 com caracteres acentuados
- Build e testes executaram com sucesso (9/9 passando)

### File List

**DTOs:**
- src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/ImportChartOfAccountResponse.java

**Use case port:**
- src/main/java/br/com/lalurecf/application/port/in/chartofaccount/ImportChartOfAccountUseCase.java

**Service:**
- src/main/java/br/com/lalurecf/application/service/ImportChartOfAccountService.java

**Controller (atualizado):**
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/ChartOfAccountController.java

**Testes:**
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/ChartOfAccountControllerTest.java

### Change Log
- 2026-01-08: Story 3.3 implementada - Importação de Plano de Contas via CSV com auto-detecção de separador, validações RFB e 9 testes de integração (9/9 passando)
