# Story 3.3: Importação de Plano de Contas via CSV/TXT

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** importar plano de contas via arquivo CSV ou TXT,
**so that** eu possa carregar rapidamente centenas de contas de sistemas ERP externos.

---

## Acceptance Criteria

1. Endpoint `POST /api/v1/chart-of-accounts/import` criado (CONTADOR com header X-Company-Id):
   - Aceita `multipart/form-data` com arquivo CSV/TXT
   - Query param obrigatório: `?fiscalYear=2024`
   - Query param opcional: `?dryRun=true` (preview sem persistir)

2. DTO `ImportChartOfAccountRequest`:
   - `file` (MultipartFile, obrigatório)
   - `fiscalYear` (Integer, obrigatório)
   - `dryRun` (Boolean, default false)

3. DTO `ImportChartOfAccountResponse`:
   - `success` (boolean)
   - `message` (string)
   - `totalLines` (int - total de linhas no arquivo)
   - `processedLines` (int - linhas processadas com sucesso)
   - `skippedLines` (int - linhas puladas por erro)
   - `errors` (lista de objetos: `{lineNumber, error}`)
   - `preview` (lista de contas que seriam criadas - apenas se dryRun=true)

4. Formato do arquivo CSV/TXT esperado:
   - **Separador**: `;` (ponto e vírgula) ou `,` (vírgula) - detectado automaticamente
   - **Encoding**: UTF-8
   - **Header obrigatório** (primeira linha): `accountCode;accountName;accountType;openingBalance`
   - **Exemplo**:
     ```
     accountCode;accountName;accountType;openingBalance
     1.1.01.001;Caixa;ATIVO;5000.00
     1.1.02.001;Bancos Conta Movimento;ATIVO;100000.50
     2.1.01.001;Fornecedores;PASSIVO;25000.00
     ```

5. Use case `ImportChartOfAccountUseCase` implementado:
   - Valida que arquivo não está vazio (max 10MB)
   - Valida encoding UTF-8
   - Parse linha por linha usando biblioteca CSV (Apache Commons CSV ou OpenCSV)
   - Valida cada linha: campos obrigatórios, formato de accountType, formato de openingBalance
   - Se dryRun=false: persiste contas (transação atômica - falha em uma linha não impede as outras)
   - Se dryRun=true: retorna preview sem persistir
   - Ignora linhas duplicadas (mesmo accountCode para mesma empresa/ano)
   - Retorna relatório detalhado

6. Validações por linha:
   - accountCode não vazio
   - accountName não vazio
   - accountType deve ser um dos valores válidos do enum (case insensitive)
   - openingBalance opcional, se presente deve ser número válido (formato: 1000.00 ou 1000,00)

7. Tratamento de erros:
   - Linha com campos faltando: registra erro e continua próxima linha
   - accountType inválido: registra erro e continua
   - Duplicata dentro do arquivo: registra warning e ignora duplicata
   - Duplicata com dados já existentes no DB: registra warning e ignora

8. Response:
   - 200 OK com relatório completo (mesmo se houve erros em linhas individuais)
   - 400 Bad Request se arquivo vazio, formato inválido, ou fiscalYear ausente
   - 413 Payload Too Large se arquivo > 10MB

9. Teste valida:
   - Importação com arquivo válido processa todas linhas
   - Dry run retorna preview sem persistir
   - Linha com campo faltando é registrada como erro
   - accountType inválido é registrado como erro
   - Duplicatas são ignoradas com warning
   - Encoding UTF-8 é respeitado (caracteres acentuados)
   - Arquivo > 10MB retorna 413

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3)
  - [ ] ImportChartOfAccountRequest
  - [ ] ImportChartOfAccountResponse
  - [ ] ErrorDetail (lineNumber, error)
  - [ ] PreviewItem

- [ ] Adicionar dependência Apache Commons CSV ou OpenCSV (AC: 5)
  - [ ] Adicionar no pom.xml
  - [ ] Configurar versão estável

- [ ] Criar use case ImportChartOfAccountUseCase (AC: 5, 6, 7)
  - [ ] Validar tamanho do arquivo (max 10MB)
  - [ ] Validar encoding UTF-8
  - [ ] Detectar separador automaticamente (';' ou ',')
  - [ ] Parse CSV linha por linha
  - [ ] Validar campos obrigatórios por linha
  - [ ] Validar accountType (enum, case insensitive)
  - [ ] Validar openingBalance (formato numérico)
  - [ ] Implementar lógica de duplicatas
  - [ ] Implementar dry run mode
  - [ ] Retornar relatório detalhado

- [ ] Criar endpoint no controller (AC: 1)
  - [ ] POST /api/v1/chart-of-accounts/import
  - [ ] Aceitar multipart/form-data
  - [ ] Query params: fiscalYear (obrigatório), dryRun (opcional)
  - [ ] Validar header X-Company-Id

- [ ] Implementar tratamento de erros (AC: 7, 8)
  - [ ] Campos faltando → registrar erro e continuar
  - [ ] accountType inválido → registrar erro e continuar
  - [ ] Duplicata → registrar warning e ignorar
  - [ ] Arquivo vazio → 400
  - [ ] Arquivo > 10MB → 413

- [ ] Criar testes de integração (AC: 9)
  - [ ] Teste: arquivo válido processa todas linhas
  - [ ] Teste: dry run não persiste dados
  - [ ] Teste: campo faltando registra erro
  - [ ] Teste: accountType inválido registra erro
  - [ ] Teste: duplicatas são ignoradas
  - [ ] Teste: encoding UTF-8 funciona (caracteres acentuados)
  - [ ] Teste: arquivo > 10MB retorna 413

---

## Dev Notes

### Formato do Arquivo CSV

**Header obrigatório:**
```
accountCode;accountName;accountType;openingBalance
```

**Exemplo de arquivo válido:**
```csv
accountCode;accountName;accountType;openingBalance
1.1.01.001;Caixa;ATIVO;5000.00
1.1.02.001;Bancos Conta Movimento;ATIVO;100000.50
1.1.03.001;Aplicações Financeiras;ATIVO;200000.00
2.1.01.001;Fornecedores;PASSIVO;25000.00
2.1.02.001;Impostos a Pagar;PASSIVO;15000.00
3.1.01.001;Receita de Vendas;RECEITA;
4.1.01.001;Custo das Mercadorias Vendidas;DESPESA;
```

### Dependência Maven

```xml
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-csv</artifactId>
    <version>1.10.0</version>
</dependency>
```

### Exemplo de Parse CSV

```java
try (Reader reader = new InputStreamReader(file.getInputStream(), StandardCharsets.UTF_8)) {
    CSVParser csvParser = new CSVParser(reader, CSVFormat.DEFAULT
        .withFirstRecordAsHeader()
        .withDelimiter(detectDelimiter(file))
        .withIgnoreEmptyLines()
        .withTrim());

    for (CSVRecord record : csvParser) {
        String accountCode = record.get("accountCode");
        String accountName = record.get("accountName");
        String accountType = record.get("accountType");
        String openingBalance = record.get("openingBalance");

        // Processar linha...
    }
}
```

### Response de Exemplo

**Sucesso completo:**
```json
{
  "success": true,
  "message": "Import completed successfully",
  "totalLines": 100,
  "processedLines": 100,
  "skippedLines": 0,
  "errors": []
}
```

**Com erros parciais:**
```json
{
  "success": true,
  "message": "Import completed with errors",
  "totalLines": 100,
  "processedLines": 95,
  "skippedLines": 5,
  "errors": [
    {"lineNumber": 12, "error": "Invalid accountType: 'INVALIDO'"},
    {"lineNumber": 25, "error": "Missing required field: accountName"},
    {"lineNumber": 50, "error": "Duplicate accountCode: '1.1.01.001'"}
  ]
}
```

**Dry run:**
```json
{
  "success": true,
  "message": "Dry run completed - no data persisted",
  "totalLines": 10,
  "processedLines": 10,
  "skippedLines": 0,
  "errors": [],
  "preview": [
    {
      "accountCode": "1.1.01.001",
      "accountName": "Caixa",
      "accountType": "ATIVO",
      "openingBalance": 5000.00
    }
  ]
}
```

### Validações

- **Tamanho**: max 10MB
- **Encoding**: UTF-8 obrigatório
- **Separador**: `;` ou `,` (detectado automaticamente)
- **accountType**: case insensitive, validar contra enum AccountType
- **openingBalance**: aceitar formatos `1000.00` ou `1000,00`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
