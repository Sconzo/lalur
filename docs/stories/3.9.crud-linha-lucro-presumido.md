# Story 3.9: CRUD de Linha para Cadastro de Lucro Presumido (Manual)

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** criar, listar, visualizar, editar e inativar Linhas para Cadastro de Lucro Presumido manualmente,
**so that** eu possa cadastrar as linhas de apuração de lucro presumido com suas respectivas contas contábeis.

---

## Acceptance Criteria

1. Controller `LinhaLucroPresumidoController` criado com endpoints:
   - `POST /api/v1/linha-lucro-presumido` - criar linha (CONTADOR com header X-Company-Id)
   - `GET /api/v1/linha-lucro-presumido` - listar linhas com paginação (CONTADOR com header)
   - `GET /api/v1/linha-lucro-presumido/{id}` - visualizar linha (CONTADOR com header)
   - `PUT /api/v1/linha-lucro-presumido/{id}` - editar linha (CONTADOR com header)
   - `PATCH /api/v1/linha-lucro-presumido/{id}/status` - alternar status (ativar/inativar, CONTADOR com header)

2. DTOs criados: `CreateLinhaLucroPresumidoRequest`, `UpdateLinhaLucroPresumidoRequest`, `LinhaLucroPresumidoResponse`

3. `CreateLinhaLucroPresumidoRequest`:
   - `codigo` (obrigatório, Integer)
   - `descricao` (obrigatório, String, max 1000 chars)
   - `fiscalYear` (obrigatório, Integer)
   - `chartOfAccountIds` (obrigatório, List<Long>, não pode ser vazia)

4. `LinhaLucroPresumidoResponse`:
   - `id`, `codigo`, `descricao`, `fiscalYear`, `status`, `createdAt`, `updatedAt`
   - `contas` (lista de objetos: `{chartOfAccountId, accountCode, accountName}` - na ordem inserida)

5. Use cases implementados:
   - `CreateLinhaLucroPresumidoUseCase`:
     - Valida company via `CompanyContext`
     - Verifica unicidade (company + codigo + fiscalYear)
     - Valida que todas contas em `chartOfAccountIds` existem e pertencem à empresa + fiscalYear
     - Salva linha preservando ordem das contas via `orderIndex`
   - `ListLinhaLucroPresumidoUseCase`: retorna linhas da empresa no contexto
   - `GetLinhaLucroPresumidoUseCase`: retorna linha por ID com contas ordenadas
   - `UpdateLinhaLucroPresumidoUseCase`:
     - Permite editar descricao e chartOfAccountIds
     - Não permite editar codigo ou fiscalYear
     - Remove contas antigas e adiciona novas (orphan removal automático)
   - `ToggleLinhaLucroPresumidoStatusUseCase`: alterna status entre ACTIVE e INACTIVE

6. Validações:
   - codigo deve ser >= 1
   - descricao não pode ser vazia
   - fiscalYear deve ser >= 2000 e <= ano atual + 1
   - chartOfAccountIds não pode ser vazia (mínimo 1 conta)
   - Todas contas devem existir, pertencer à empresa, e ter fiscalYear compatível
   - Combinação (company + codigo + fiscalYear) deve ser única

7. Listagem suporta:
   - Paginação: `?page=0&size=100&sort=codigo,asc`
   - Filtro por ano: `?fiscalYear=2024`
   - Busca: `?search=texto` (busca em descricao)
   - Filtro por status: `?include_inactive=true` (padrão: apenas ACTIVE)

8. DTOs adicionais: `ToggleStatusRequest`, `ToggleStatusResponse` (reutilizados)

9. Teste valida:
   - CONTADOR consegue criar linha com lista de contas
   - Ordem das contas é preservada
   - Código duplicado para mesma empresa/ano retorna 400
   - Conta inexistente em chartOfAccountIds retorna 400
   - Conta de outra empresa retorna 400
   - Edição permite adicionar/remover contas
   - Edição não permite mudar codigo ou fiscalYear
   - Toggle status funciona corretamente
   - Listagem com filtros funciona
   - Contas órfãs são removidas ao editar linha

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3, 4, 8)
  - [ ] CreateLinhaLucroPresumidoRequest
  - [ ] UpdateLinhaLucroPresumidoRequest
  - [ ] LinhaLucroPresumidoResponse
  - [ ] ContaAssociada (chartOfAccountId, accountCode, accountName)

- [ ] Criar use cases (AC: 5, 6)
  - [ ] CreateLinhaLucroPresumidoUseCase com todas validações
  - [ ] ListLinhaLucroPresumidoUseCase
  - [ ] GetLinhaLucroPresumidoUseCase
  - [ ] UpdateLinhaLucroPresumidoUseCase com orphan removal
  - [ ] ToggleLinhaLucroPresumidoStatusUseCase

- [ ] Criar controller (AC: 1)
  - [ ] Implementar todos endpoints
  - [ ] Validar header X-Company-Id

- [ ] Criar testes de integração (AC: 9)
  - [ ] Teste: criar linha com lista de contas
  - [ ] Teste: ordem preservada
  - [ ] Teste: código duplicado retorna 400
  - [ ] Teste: conta inexistente retorna 400
  - [ ] Teste: conta de outra empresa retorna 400
  - [ ] Teste: edição add/remove contas
  - [ ] Teste: edição não permite mudar codigo/fiscalYear
  - [ ] Teste: toggle status
  - [ ] Teste: orphan removal

---

## Dev Notes

### Endpoints REST

**POST /api/v1/linha-lucro-presumido**
```json
{
  "codigo": 1,
  "descricao": "Receita Bruta de Vendas",
  "fiscalYear": 2024,
  "chartOfAccountIds": [101, 102, 103]
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "codigo": 1,
  "descricao": "Receita Bruta de Vendas",
  "fiscalYear": 2024,
  "status": "ACTIVE",
  "contas": [
    {
      "chartOfAccountId": 101,
      "accountCode": "3.1.01.001",
      "accountName": "Receita de Vendas - Mercado Interno"
    },
    {
      "chartOfAccountId": 102,
      "accountCode": "3.1.01.002",
      "accountName": "Receita de Vendas - Mercado Externo"
    },
    {
      "chartOfAccountId": 103,
      "accountCode": "3.1.02.001",
      "accountName": "Receita de Serviços"
    }
  ],
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

**PUT /api/v1/linha-lucro-presumido/1** (adicionar nova conta)
```json
{
  "descricao": "Receita Bruta de Vendas e Serviços",
  "chartOfAccountIds": [101, 102, 103, 104]
}
```

### Validações de Negócio

- **codigo**: >= 1
- **descricao**: não vazia, max 1000 chars
- **fiscalYear**: >= 2000 e <= (ano atual + 1)
- **chartOfAccountIds**: não vazia, todas contas devem existir e pertencer à empresa
- **Unicidade**: (company_id + codigo + fiscalYear)
- **Ordem**: preservada via orderIndex

### Lógica de Orphan Removal

Ao editar a lista de contas:
- Contas removidas da lista são automaticamente deletadas do banco (orphanRemoval=true)
- Novas contas são inseridas com orderIndex correto
- Ordem é sempre preservada

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
