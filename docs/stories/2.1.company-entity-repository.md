# Story 2.1: Entidade Company e Repository

## Status

**Ready for Review**

---

## Story

**As a** desenvolvedor,
**I want** entidade Company com repository JPA implementando port,
**so that** possamos persistir empresas no banco de dados com todos os campos obrigatórios.

---

## Acceptance Criteria

1. Entidade JPA `CompanyEntity` criada em `infrastructure/adapter/out/persistence/entity/` estendendo `BaseEntity`:
   - `@Column(nullable=false, unique=true, length=14) String cnpj` (apenas números, 14 dígitos)
   - `@Column(name="razao_social", nullable=false) String razaoSocial`
   - `@Column(nullable=false, length=7) String cnae` (formato: 0000-0/00)
   - `@Column(name="qualificacao_pessoa_juridica", nullable=false) String qualificacaoPessoaJuridica`
   - `@Column(name="natureza_juridica", nullable=false) String naturezaJuridica`
   - `@Column(name="periodo_contabil", nullable=false) LocalDate periodoContabil` (data de corte para edições)
   - **Nota:** Tabela de banco = `tb_empresa`, colunas em snake_case conforme ADR-001
   - **Nota:** Relacionamento com TaxParameter gerenciado via tabela explícita `tb_empresa_parametros_tributarios` (ver Story 2.8)

2. Value Object `CNPJ` criado em `domain/model/valueobject/`:
   - Validação de formato (14 dígitos)
   - Validação de dígitos verificadores
   - Método `format()` retornando string formatada (00.000.000/0000-00)

3. Interface `CompanyRepositoryPort` criada em `application/port/out/`:
   - `Optional<Company> findByCnpj(String cnpj)`
   - `Company save(Company company)`
   - `Optional<Company> findById(Long id)`
   - `Page<Company> findAll(Pageable pageable)`

4. Interface `CompanyJpaRepository` criada estendendo `JpaRepository<CompanyEntity, Long>`:
   - `Optional<CompanyEntity> findByCnpj(String cnpj)`

5. Classe `CompanyRepositoryAdapter` implementa `CompanyRepositoryPort`

6. Model `Company` (domain) criado em `domain/model/` como POJO puro

7. Mapper MapStruct `CompanyMapper` criado para conversão `CompanyEntity` ↔ `Company`

8. Teste de integração (TestContainers) valida:
   - Salvar empresa e recuperar por CNPJ
   - Unique constraint em CNPJ (tentativa de duplicata lança exception)
   - Validação de CNPJ (CNPJ inválido lança exception)
   - Soft delete funciona corretamente
   - Período Contábil é persistido corretamente

---

## Tasks / Subtasks

- [x] Criar Value Object CNPJ (AC: 2)
  - [x] Implementar validação de formato (14 dígitos numéricos)
  - [x] Implementar validação de dígitos verificadores
  - [x] Implementar método `format()` para formatação visual
  - [x] Adicionar testes unitários para CNPJ

- [x] Criar Model Company no domínio (AC: 6)
  - [x] Criar POJO puro em `domain/model/Company.java`
  - [x] Adicionar todos os campos necessários
  - [x] Garantir que não há dependências de Spring/JPA

- [x] Criar Entidade JPA CompanyEntity (AC: 1)
  - [x] Estender `BaseEntity`
  - [x] Anotar tabela como `@Table(name="tb_empresa")`
  - [x] Adicionar campo `cnpj` com constraint unique
  - [x] Adicionar campo `razaoSocial` mapeado para `razao_social`
  - [x] Adicionar campo `cnae`
  - [x] Adicionar campo `qualificacaoPessoaJuridica` mapeado para `qualificacao_pessoa_juridica`
  - [x] Adicionar campo `naturezaJuridica` mapeado para `natureza_juridica`
  - [x] Adicionar campo `periodoContabil` mapeado para `periodo_contabil`

- [x] Criar Port e Repository JPA (AC: 3, 4)
  - [x] Criar interface `CompanyRepositoryPort` em `application/port/out/`
  - [x] Criar interface `CompanyJpaRepository` estendendo `JpaRepository`
  - [x] Adicionar método customizado `findByCnpj`

- [x] Criar Adapter (AC: 5)
  - [x] Implementar `CompanyRepositoryAdapter`
  - [x] Injetar `CompanyJpaRepository`
  - [x] Implementar todos os métodos do port

- [x] Criar Mapper MapStruct (AC: 7)
  - [x] Criar interface `CompanyMapper` com `@Mapper`
  - [x] Mapear Entity ↔ Domain
  - [x] Configurar mapeamentos de campos (snake_case ↔ camelCase)

- [x] Criar testes de integração (AC: 8)
  - [x] Configurar TestContainers com PostgreSQL
  - [x] Testar save e findByCnpj
  - [x] Testar unique constraint em CNPJ
  - [x] Testar validação de CNPJ
  - [x] Testar soft delete
  - [x] Testar persistência de periodoContabil

---

## Dev Notes

### Arquitetura Hexagonal
- **Domain Model** (`Company`): POJO puro, SEM anotações Spring/JPA
- **Entity** (`CompanyEntity`): JPA entity na camada de infraestrutura
- **Port** (`CompanyRepositoryPort`): Interface no application layer
- **Adapter** (`CompanyRepositoryAdapter`): Implementação na infraestrutura

### Nomenclatura de Banco de Dados (ADR-001)
**Referência:** [ADR-001: Simplificação do Modelo de Dados](../architecture/adr-001-simplificacao-modelo-dados.md)

- Tabela: `tb_empresa` (snake_case)
- Colunas em snake_case no banco, mas camelCase no Java
- Usar `@Column(name="...")` para mapear

**Mapeamento:**
```java
razaoSocial          → razao_social
periodoContabil      → periodo_contabil
qualificacaoPessoaJuridica → qualificacao_pessoa_juridica
naturezaJuridica     → natureza_juridica
```

### Source Tree
```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       ├── Company.java              # POJO puro
│       └── valueobject/
│           └── CNPJ.java             # Value Object
├── application/
│   └── port/
│       └── out/
│           └── CompanyRepositoryPort.java
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                ├── entity/
                │   └── CompanyEntity.java
                ├── repository/
                │   └── CompanyJpaRepository.java
                ├── adapter/
                │   └── CompanyRepositoryAdapter.java
                └── mapper/
                    └── CompanyMapper.java
```

### Padrões de Código
- **Indentação:** 4 espaços (nunca tabs)
- **Line length:** Máximo 120 caracteres
- **Null Safety:** Usar `Optional<T>` para retornos que podem ser null
- **NUNCA** importar wildcard (`import java.util.*`)

### Testing

#### Estratégia de Testes
- **Unit Tests:** Para CNPJ value object (validações)
- **Integration Tests:** Para repository (TestContainers + PostgreSQL real)
- **Padrão AAA:** Arrange-Act-Assert em todos os testes

#### Test Location
```
src/test/java/br/com/lalurecf/
├── domain/
│   └── model/
│       └── valueobject/
│           └── CnpjTest.java         # Unit test
└── infrastructure/
    └── adapter/
        └── out/
            └── persistence/
                └── adapter/
                    └── CompanyRepositoryAdapterTest.java  # Integration test
```

#### TestContainers Setup
- PostgreSQL 15.5 em container
- `@SpringBootTest` + `@Testcontainers`
- Cleanup automático com `@BeforeEach` + rollback

#### Coverage Target
- Geral: ≥70%
- Domain: ≥75%

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
- All 7 tasks completed successfully
- CNPJ value object implements Brazilian CNPJ validation (format + check digits)
- Domain model (Company) is pure POJO without framework dependencies
- Hexagonal architecture properly implemented with ports and adapters
- MapStruct mapper includes `updateEntity()` method to handle updates correctly
- Fixed mapper issue: Added `updateEntity()` to preserve BaseEntity fields (id, audit fields) during updates
- All 9 integration tests passing with TestContainers + PostgreSQL 15.5
- Checkstyle: 0 violations
- Coverage: Jacoco report generated successfully

### File List
**Created:**
- `src/main/java/br/com/lalurecf/domain/model/valueobject/CNPJ.java`
- `src/test/java/br/com/lalurecf/domain/model/valueobject/CnpjTest.java`
- `src/main/java/br/com/lalurecf/domain/model/Company.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/CompanyEntity.java`
- `src/main/java/br/com/lalurecf/application/port/out/CompanyRepositoryPort.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/repository/CompanyJpaRepository.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/CompanyMapper.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/CompanyRepositoryAdapter.java`
- `src/test/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/CompanyRepositoryAdapterTest.java`

---

## QA Results
*A ser preenchido após revisão de QA*
