# Story 2.10: Testes de Integração End-to-End do Epic 2

## Status

**Draft**

---

## Story

**As a** desenvolvedor,
**I want** testes de integração que validem fluxos completos do Epic 2,
**so that** tenhamos confiança de que todas funcionalidades estão integradas corretamente.

---

## Acceptance Criteria

1. **Teste de integração: Fluxo completo CONTADOR**
   - Login como CONTADOR
   - Listar todas empresas disponíveis via `/my-companies`
   - Selecionar qualquer empresa (`select-company`)
   - Enviar requisições com header `X-Company-Id`
   - Validar que contexto está correto
   - Tentar acessar CRUD de empresas → recebe 403
   - Tentar acessar recurso de empresa sem header → recebe 400

2. **Teste de integração: Fluxo completo ADMIN com dropdown**
   - Login como ADMIN
   - Listar todas empresas via `/my-companies`
   - Selecionar qualquer empresa (`select-company`)
   - Enviar requisições com header `X-Company-Id`
   - Validar que contexto está correto
   - Acessar dados contábeis da empresa selecionada via contexto

3. **Teste de integração: Fluxo completo ADMIN - Parâmetros Tributários**
   - Login como ADMIN
   - Criar parâmetro de IRPJ (tipo: "IRPJ")
   - Criar parâmetro de CSLL (tipo: "CSLL")
   - Criar parâmetro geral (tipo: "GERAL")
   - Listar parâmetros com filtro por tipo
   - Validar que filtros funcionam corretamente

4. **Teste de integração: Associação Empresa + Parâmetros**
   - ADMIN cria empresa
   - ADMIN cria 3 parâmetros tributários
   - ADMIN associa parâmetros à empresa
   - Buscar empresa e validar que parâmetros estão associados
   - Atualizar parâmetros (substituir lista)
   - Validar que lista foi substituída corretamente

5. **Teste de integração: Período Contábil e Bloqueio**
   - Criar empresa com Período Contábil = 2024-01-01
   - Criar dado contábil com competência 2023-12-31 (anterior)
   - Tentar editar dado antigo → deve falhar (400)
   - Ler dado antigo → deve funcionar
   - Atualizar Período Contábil para 2023-12-01
   - Tentar editar dado antigo novamente → deve funcionar
   - Validar que histórico de auditoria foi registrado

6. **Teste de integração: Row-level Security via X-Company-Id**
   - ADMIN cria empresa1 e empresa2
   - Login como CONTADOR
   - Listar empresas → deve ver empresa1 e empresa2
   - Selecionar empresa1 e enviar header X-Company-Id
   - Acessar recursos da empresa1 → sucesso
   - Tentar acessar recursos sem header → recebe 400

7. **Teste de integração: Consulta CNPJ com fallback**
   - Chamar endpoint `/search-cnpj` com CNPJ válido
   - Mock da API retorna dados → validar response 200
   - Mock da API retorna 404 → validar response 404
   - Mock da API timeout → validar response 404
   - Segunda chamada com mesmo CNPJ → validar que usou cache (não chamou API)

8. Todos testes usam TestContainers com PostgreSQL real

9. Todos testes limpam dados após execução (`@Transactional` com rollback)

---

## Tasks / Subtasks

- [ ] Configurar TestContainers para E2E (AC: 8)
  - [ ] Configurar PostgreSQL TestContainer
  - [ ] Configurar cleanup automático

- [ ] Criar teste: Fluxo CONTADOR (AC: 1)
  - [ ] Login como CONTADOR
  - [ ] Listar empresas disponíveis
  - [ ] Selecionar empresa
  - [ ] Enviar requisições com header
  - [ ] Validar contexto
  - [ ] Testar bloqueio CRUD (403)
  - [ ] Testar bloqueio sem header (400)

- [ ] Criar teste: Fluxo ADMIN com dropdown (AC: 2)
  - [ ] Login como ADMIN
  - [ ] Listar empresas
  - [ ] Selecionar empresa
  - [ ] Acessar dados via contexto

- [ ] Criar teste: Parâmetros Tributários (AC: 3)
  - [ ] Criar parâmetros de tipos diferentes
  - [ ] Listar com filtro por tipo
  - [ ] Validar filtros

- [ ] Criar teste: Associação Empresa + Parâmetros (AC: 4)
  - [ ] Criar empresa
  - [ ] Criar parâmetros
  - [ ] Associar parâmetros
  - [ ] Validar associação
  - [ ] Substituir lista
  - [ ] Validar substituição

- [ ] Criar teste: Período Contábil e Bloqueio (AC: 5)
  - [ ] Criar empresa com período contábil
  - [ ] Criar dado com competência antiga
  - [ ] Testar bloqueio de edição
  - [ ] Testar leitura permitida
  - [ ] Atualizar período contábil
  - [ ] Validar auditoria

- [ ] Criar teste: Row-level Security (AC: 6)
  - [ ] Criar múltiplas empresas
  - [ ] Login como CONTADOR
  - [ ] Testar acesso com header
  - [ ] Testar bloqueio sem header

- [ ] Criar teste: Consulta CNPJ (AC: 7)
  - [ ] Mockar API externa (WireMock)
  - [ ] Testar consulta bem-sucedida
  - [ ] Testar CNPJ não encontrado
  - [ ] Testar timeout
  - [ ] Testar cache

- [ ] Configurar cleanup (AC: 9)
  - [ ] `@Transactional` com rollback
  - [ ] Validar isolamento entre testes

---

## Dev Notes

### TestContainers Setup
**PostgreSQL real em container Docker:**
```java
@Testcontainers
@SpringBootTest
class Epic02IntegrationTest {

    @Container
    static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15.5")
        .withDatabaseName("ecf_test_db")
        .withUsername("test_user")
        .withPassword("test_pass");

    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
        registry.add("spring.datasource.username", postgres::getUsername);
        registry.add("spring.datasource.password", postgres::getPassword);
    }
}
```

### Test Location
```
src/test/java/br/com/lalurecf/
└── integration/
    ├── Epic02IntegrationTest.java
    ├── ContadorWorkflowIntegrationTest.java
    ├── AdminWorkflowIntegrationTest.java
    ├── TaxParameterAssociationIntegrationTest.java
    ├── PeriodoContabilIntegrationTest.java
    ├── RowLevelSecurityIntegrationTest.java
    └── CnpjSearchIntegrationTest.java
```

### Mock API Externa (WireMock)
```java
@WireMockTest
class CnpjSearchIntegrationTest {

    @Test
    void deveConsultarCnpjComSucesso() {
        stubFor(get(urlEqualTo("/api/cnpj/v1/00000000000191"))
            .willReturn(aResponse()
                .withStatus(200)
                .withHeader("Content-Type", "application/json")
                .withBody("{\"cnpj\":\"00000000000191\",\"razao_social\":\"BANCO DO BRASIL S.A.\"}")));

        // Chamar endpoint e validar
    }
}
```

### Padrões de Teste E2E
1. **Arrange:** Criar dados necessários (empresas, parâmetros, usuários)
2. **Act:** Executar fluxo completo
3. **Assert:** Validar estado final + efeitos colaterais
4. **Cleanup:** Rollback automático com `@Transactional`

### Fluxos Críticos a Testar
1. **CONTADOR workflow:** Login → Listar → Selecionar → Trabalhar
2. **ADMIN workflow:** Login → CRUD → Associar parâmetros
3. **Segurança:** Validar que CONTADOR não acessa CRUD
4. **Contexto:** Header X-Company-Id funciona corretamente
5. **Bloqueio temporal:** Período Contábil bloqueia edições antigas
6. **Cache:** Segunda consulta CNPJ não chama API

### TestData Builder
```java
public class TestDataBuilder {

    public static User createAdminUser() {
        return User.builder()
            .email("admin@test.com")
            .role(UserRole.ADMIN)
            .build();
    }

    public static Company createTestCompany() {
        return Company.builder()
            .cnpj("00000000000191")
            .razaoSocial("Test Company")
            .periodoContabil(LocalDate.of(2024, 1, 1))
            .build();
    }

    public static TaxParameter createTestTaxParameter(String type) {
        return TaxParameter.builder()
            .code("TEST-" + type)
            .type(type)
            .description("Test parameter")
            .build();
    }
}
```

### Cleanup Strategy
- **`@Transactional` em test class:** Rollback automático após cada teste
- **TestContainers:** Container é recriado entre execuções
- **Isolamento:** Cada teste independente dos demais

### Coverage Target
- **Epic 2:** ≥75% coverage
- **Fluxos críticos:** 100% cobertos

### Padrões de Código
- **Nomenclatura:** `shouldDoSomethingWhenCondition()`
- **AAA Pattern:** Arrange-Act-Assert claro
- **Assertions:** Usar AssertJ para fluency

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante implementação*

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
*A ser preenchido durante implementação*

### File List
*A ser preenchido durante implementação*

---

## QA Results
*A ser preenchido após revisão de QA*
