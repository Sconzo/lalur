# Story 3.4: Entidade ContaReferencial (Tabela Mestra RFB) e Repository

## Status

**✅ COMPLETED** (2026-01-07)

---

**Como** desenvolvedor,
**Eu quero** entidade ContaReferencial global (não vinculada a empresa),
**Para que** possamos persistir Contas Referenciais oficiais da Receita Federal Brasil que serão referenciadas por ChartOfAccount.

## Acceptance Criteria

1. Entidade JPA `ContaReferencialEntity` criada estendendo `BaseEntity`:
   - `@Column(nullable=false, unique=true) String codigoRfb` (código oficial RFB, ex: "1.01.01", "3.01")
   - `@Column(nullable=false, length=1000) String descricao` (descrição oficial da conta referencial)
   - `@Column Integer anoValidade` (ano de validade - nullable, null = válido para todos anos)
2. Constraint de unicidade: `@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"codigo_rfb", "ano_validade"}))`
   - Garante que não existam códigos duplicados por ano (suporta mudanças anuais no layout ECF)
3. Interface `ContaReferencialRepositoryPort` criada em `application/port/out/`:
   - `ContaReferencial save(ContaReferencial conta)`
   - `Optional<ContaReferencial> findById(Long id)`
   - `Optional<ContaReferencial> findByCodigoRfb(String codigoRfb)`
   - `List<ContaReferencial> findByAnoValidade(Integer anoValidade)`
   - `List<ContaReferencial> findAll()`
   - `Page<ContaReferencial> findAll(Pageable pageable)`
4. Interface `ContaReferencialJpaRepository` criada estendendo `JpaRepository<ContaReferencialEntity, Long>`:
   - `Optional<ContaReferencialEntity> findByCodigoRfb(String codigoRfb)`
   - `List<ContaReferencialEntity> findByAnoValidade(Integer anoValidade)`
5. Classe `ContaReferencialRepositoryAdapter` implementa `ContaReferencialRepositoryPort`
6. Model `ContaReferencial` (domain) criado em `domain/model/` como POJO puro
7. Mapper MapStruct `ContaReferencialMapper` criado
8. Teste de integração valida:
   - Salvar conta referencial e recuperar por codigoRfb
   - Unique constraint funciona (duplicata com mesmo codigo + ano lança exception)
   - Buscar por anoValidade
   - Conta com anoValidade=null pode coexistir com conta de mesmo código mas anoValidade específico
   - Soft delete funciona
   - Listagem paginada

## Technical Notes

- **Tabela global**: Não vinculada a empresas específicas - todas empresas usam mesma referência RFB
- **Versionamento anual**: anoValidade permite contas com mesmo código mas anos diferentes (mudanças no layout ECF)
- **ON DELETE RESTRICT**: Implícito via FK em ChartOfAccount - não pode deletar conta referencial se em uso

## Tasks / Subtasks

- [x] **Task 1: Criar Domain Model ContaReferencial** (AC: 6)
  - [x] POJO puro sem dependências JPA/Spring
  - [x] Campos: id, codigoRfb, descricao, anoValidade, status, campos auditoria

- [x] **Task 2: Criar ContaReferencialEntity** (AC: 1, 2)
  - [x] Estende BaseEntity
  - [x] Campos JPA: codigoRfb (nullable=false), descricao (length=1000), anoValidade (nullable)
  - [x] Unique constraint: (codigo_rfb, ano_validade)

- [x] **Task 3: Criar ContaReferencialRepositoryPort** (AC: 3)
  - [x] Métodos: save, findById, findByCodigoRfb, findByAnoValidade, findAll
  - [x] Métodos adicionais: search, filtros por status

- [x] **Task 4: Criar ContaReferencialJpaRepository** (AC: 4)
  - [x] Estende JpaRepository
  - [x] Query methods customizados

- [x] **Task 5: Criar ContaReferencialRepositoryAdapter** (AC: 5)
  - [x] Implementa ContaReferencialRepositoryPort
  - [x] Usa mapper para conversões
  - [x] Delega ao JpaRepository

- [x] **Task 6: Criar ContaReferencialMapper** (AC: 7)
  - [x] MapStruct mapper
  - [x] Métodos: toDomain, toEntity, updateEntity

- [x] **Task 7: Criar testes de integração** (AC: 8)
  - [x] 11 testes criados cobrindo todos AC
  - [x] TestContainers configurado
  - [x] Testes executados com sucesso (11 passed, 0 failed, 0 errors)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log
- N/A - Implementação sem erros

### Completion Notes
- ✅ Todos arquivos criados conforme padrões hexagonais
- ✅ Compilação bem-sucedida (0 erros)
- ✅ Checkstyle passou (0 violações)
- ✅ 11 testes de integração criados e executados
- ✅ **TESTES PASSARAM:** 11 passed, 0 failed, 0 errors (24.15s)
  - Validado: save, findById, findByCodigoRfb, findByAnoValidade
  - Validado: Unique constraint funciona (duplicata rejeitada)
  - Validado: Versionamento anual (mesmo código, anos diferentes)
  - Validado: anoValidade=null permitido
  - Validado: Paginação e soft delete (status INACTIVE)

### File List
**Criados:**
- `src/main/java/br/com/lalurecf/domain/model/ContaReferencial.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/ContaReferencialEntity.java`
- `src/main/java/br/com/lalurecf/application/port/out/ContaReferencialRepositoryPort.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/repository/ContaReferencialJpaRepository.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/ContaReferencialRepositoryAdapter.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/ContaReferencialMapper.java`
- `src/test/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/ContaReferencialRepositoryAdapterTest.java`

### Change Log
- 2026-01-07: Implementação completa da entidade ContaReferencial e repository pattern
  - Domain model, Entity, Port, Adapter, Mapper criados
  - 11 testes de integração implementados e executados com sucesso
  - Compilação e checkstyle validados (0 erros, 0 violações)
  - Testes de integração: ✅ 11 passed, 0 failed (TestContainers PostgreSQL 15.5)

---

## Definition of Done

- [x] Entidade JPA criada e mapeada corretamente
- [x] Repository port e adapter implementados
- [x] Domain model criado
- [x] Mapper MapStruct funcionando
- [x] Testes de integração passando (TestContainers) - ✅ 11/11 passed
- [ ] Code review aprovado
- [ ] Merge em develop
