# Story 3.4: Entidade ContaReferencial (Tabela Mestra RFB) e Repository

**Como** desenvolvedor,
**Eu quero** entidade ContaReferencial global (não vinculada a empresa),
**Para que** possamos persistir Contas Referenciais oficiais da Receita Federal Brasil que serão referenciadas por ChartOfAccount.

## Acceptance Criteria

1. Entidade JPA `ContaReferencialEntity` criada estendendo `BaseEntity`:
   - `@Column(nullable=false, unique=true) String codigoRfb` (código oficial RFB, ex: "1.01.01", "3.01")
   - `@Column(nullable=false, length=1000) String descricao` (descrição oficial da conta referencial)
   - `@Column Integer anoValidade` (ano de validade - nullable, null = válido para todos anos)
2. Constraint de unicidade: `@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"codigo_rfb", "ano_validade"}))`
   - Garante que não existam códigos duplicados por ano (suporta mudanças anuais no layout ECF)
3. Interface `ContaReferencialRepositoryPort` criada em `application/port/out/`:
   - `ContaReferencial save(ContaReferencial conta)`
   - `Optional<ContaReferencial> findById(Long id)`
   - `Optional<ContaReferencial> findByCodigoRfb(String codigoRfb)`
   - `List<ContaReferencial> findByAnoValidade(Integer anoValidade)`
   - `List<ContaReferencial> findAll()`
   - `Page<ContaReferencial> findAll(Pageable pageable)`
4. Interface `ContaReferencialJpaRepository` criada estendendo `JpaRepository<ContaReferencialEntity, Long>`:
   - `Optional<ContaReferencialEntity> findByCodigoRfb(String codigoRfb)`
   - `List<ContaReferencialEntity> findByAnoValidade(Integer anoValidade)`
5. Classe `ContaReferencialRepositoryAdapter` implementa `ContaReferencialRepositoryPort`
6. Model `ContaReferencial` (domain) criado em `domain/model/` como POJO puro
7. Mapper MapStruct `ContaReferencialMapper` criado
8. Teste de integração valida:
   - Salvar conta referencial e recuperar por codigoRfb
   - Unique constraint funciona (duplicata com mesmo codigo + ano lança exception)
   - Buscar por anoValidade
   - Conta com anoValidade=null pode coexistir com conta de mesmo código mas anoValidade específico
   - Soft delete funciona
   - Listagem paginada

## Technical Notes

- **Tabela global**: Não vinculada a empresas específicas - todas empresas usam mesma referência RFB
- **Versionamento anual**: anoValidade permite contas com mesmo código mas anos diferentes (mudanças no layout ECF)
- **ON DELETE RESTRICT**: Implícito via FK em ChartOfAccount - não pode deletar conta referencial se em uso

## Definition of Done

- [ ] Entidade JPA criada e mapeada corretamente
- [ ] Repository port e adapter implementados
- [ ] Domain model criado
- [ ] Mapper MapStruct funcionando
- [ ] Testes de integração passando (TestContainers)
- [ ] Code review aprovado
- [ ] Merge em develop
