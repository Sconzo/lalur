# Story 3.11: Importação de Lançamentos Contábeis via CSV/TXT

**Como** CONTADOR,
**Eu quero** importar lançamentos contábeis via arquivo CSV ou TXT com partidas dobradas,
**Para que** eu possa carregar rapidamente milhares de lançamentos de sistemas ERP externos.

## Acceptance Criteria

Ver Epic 3 Story 3.11 para critérios completos. Principais pontos:

1. **Endpoint** `POST /api/v1/lancamento-contabil/import` (multipart/form-data)
2. **Query params**: `fiscalYear` (obrigatório), `dryRun` (opcional, default false)
3. **Formato CSV**: Auto-detecção de separador (; ou ,), encoding UTF-8
4. **Header**: `contaDebitoCode;contaCreditoCode;data;valor;historico;numeroDocumento`
5. **Validações por linha**:
   - Contas devem existir no plano de contas da empresa/ano
   - Débito != Crédito
   - Data >= Período Contábil
   - Valor > 0
6. **Limite**: 50MB
7. **Performance**: 10k linhas < 30s

## Definition of Done

- [x] Endpoint POST /api/v1/lancamento-contabil/import implementado
- [x] DTOs criados (ImportLancamentoContabilResponse)
- [x] Use case port criado
- [x] Service com parsing CSV e validações
- [x] Auto-detecção de separador (; ou ,)
- [x] Modo dry-run implementado
- [x] Testes passando (8/8)
- [ ] Code review
- [ ] Merge em develop

**Referência detalhada**: docs/epics/epic-03-plano-contas-dados-contabeis.md - Story 3.11

---

## Dev Agent Record

### Status
**Ready for Review** - Implementação completa de importação CSV com auto-detecção de separador, validações de partidas dobradas e dry-run (8/8 testes passando)

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- Controller `LancamentoContabilController` criado com endpoint POST /import
- DTO `ImportLancamentoContabilResponse` com classes internas (ImportError, LancamentoContabilPreview)
- Use case port `ImportLancamentoContabilUseCase` criado
- Service `ImportLancamentoContabilService` implementado com:
  * Parsing CSV usando Apache Commons CSV
  * Auto-detecção de separador (; ou ,)
  * Validação de tamanho máximo (50MB)
  * Validação por linha: contas existem, débito != crédito, data >= período contábil, valor > 0
  * Modo dry-run para preview sem persistir
  * Relatório detalhado com erros por linha
- 8 testes de integração implementados cobrindo:
  * Importação bem-sucedida de lançamentos
  * Auto-detecção de separador vírgula
  * Erro quando conta não existe
  * Erro quando débito = crédito
  * Erro quando data < Período Contábil
  * Erro quando valor <= 0
  * Dry-run retorna preview sem persistir
  * Validação de fiscalYear obrigatório
- Build e testes executaram com sucesso (8/8 passando)

### File List

**Controller:**
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoContabilController.java

**DTOs:**
- src/main/java/br/com/lalurecf/infrastructure/dto/lancamentocontabil/ImportLancamentoContabilResponse.java

**Use case port:**
- src/main/java/br/com/lalurecf/application/port/in/ImportLancamentoContabilUseCase.java

**Service:**
- src/main/java/br/com/lalurecf/application/service/ImportLancamentoContabilService.java

**Testes:**
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoContabilControllerTest.java

### Change Log
- 2026-01-08: Story 3.11 implementada - Importação de Lançamentos Contábeis via CSV/TXT com auto-detecção de separador, validações de partidas dobradas, modo dry-run e 8 testes de integração
