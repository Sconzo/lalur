# Story 3.11: Importação de Dados Contábeis Genéricos via CSV/TXT

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** importar dados contábeis genéricos via arquivo CSV ou TXT,
**so that** eu possa carregar saldos e movimentações de sistemas ERP externos.

---

## Acceptance Criteria

1. Endpoint `POST /api/v1/accounting-data/import` criado (CONTADOR com header X-Company-Id):
   - Aceita `multipart/form-data` com arquivo CSV/TXT
   - Query param obrigatório: `?fiscalYear=2024`
   - Query param opcional: `?dryRun=true`

2. DTO `ImportAccountingDataRequest`:
   - `file` (MultipartFile, obrigatório)
   - `fiscalYear` (Integer, obrigatório)
   - `dryRun` (Boolean, default false)

3. DTO `ImportAccountingDataResponse`:
   - `success`, `message`, `totalLines`, `processedLines`, `skippedLines`, `errors`, `preview`

4. Formato do arquivo CSV/TXT esperado:
   - **Separador**: `;` ou `,` (detectado automaticamente)
   - **Header obrigatório**: `accountCode;competencia;debitAmount;creditAmount;balance;description`
   - **Exemplo**:
     ```
     accountCode;competencia;debitAmount;creditAmount;balance;description
     1.1.01.001;2024-01-31;1000.00;500.00;5500.00;Lançamento Janeiro
     1.1.02.001;2024-01-31;50000.00;25000.00;125000.50;Movimentação Bancária
     ```

5. Use case `ImportAccountingDataUseCase` implementado:
   - Valida arquivo (max 50MB - maior que plano de contas pois pode ter muito mais linhas)
   - Parse linha por linha
   - Para cada linha:
     - Busca ChartOfAccount por accountCode + companyId + fiscalYear
     - Se conta não existe: registra erro e pula linha
     - Valida formato de competencia (ISO 8601: YYYY-MM-DD)
     - Valida valores numéricos (debitAmount, creditAmount, balance)
     - Cria AccountingData e persiste
   - Validação de Período Contábil:
     - Verifica se competencia >= company.periodoContabil
     - Se competencia < periodoContabil: registra erro e pula linha
   - Se dryRun=true: retorna preview sem persistir

6. Validações por linha:
   - accountCode deve existir no plano de contas da empresa/ano
   - competencia obrigatória, formato válido
   - debitAmount, creditAmount, balance opcionais, mas se presentes devem ser números válidos
   - competencia não pode ser anterior ao Período Contábil

7. Tratamento de erros:
   - Conta não encontrada: `Account code '{code}' not found for company/year`
   - Competência anterior a Período Contábil: `Competência {date} is before Período Contábil {date}`
   - Formato de data inválido: `Invalid date format: {value}`
   - Valor numérico inválido: `Invalid numeric value: {field}`

8. Response:
   - 200 OK com relatório completo
   - 400 Bad Request se arquivo vazio ou fiscalYear ausente
   - 413 Payload Too Large se arquivo > 50MB

9. Teste valida:
   - Importação bem-sucedida processa todas linhas
   - Conta inexistente registra erro e continua
   - Competência anterior a Período Contábil registra erro
   - Dry run retorna preview
   - Arquivo com 10.000 linhas é processado em < 30s

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3)
  - [ ] ImportAccountingDataRequest
  - [ ] ImportAccountingDataResponse

- [ ] Criar use case ImportAccountingDataUseCase (AC: 5, 6, 7)
  - [ ] Validar tamanho (max 50MB)
  - [ ] Parse CSV linha por linha
  - [ ] Buscar ChartOfAccount por accountCode
  - [ ] Validar competencia (formato + Período Contábil)
  - [ ] Validar valores numéricos
  - [ ] Implementar dry run
  - [ ] Retornar relatório detalhado

- [ ] Criar endpoint (AC: 1)
  - [ ] POST /api/v1/accounting-data/import
  - [ ] Validar header X-Company-Id

- [ ] Implementar tratamento de erros (AC: 7, 8)
  - [ ] Conta não encontrada
  - [ ] Competência anterior a Período Contábil
  - [ ] Formato de data inválido
  - [ ] Arquivo > 50MB → 413

- [ ] Criar testes de integração (AC: 9)
  - [ ] Arquivo válido processa linhas
  - [ ] Conta inexistente registra erro
  - [ ] Competência antiga registra erro
  - [ ] Dry run funciona
  - [ ] Performance: 10.000 linhas em < 30s

---

## Dev Notes

### Formato do Arquivo CSV

**Header obrigatório:**
```
accountCode;competencia;debitAmount;creditAmount;balance;description
```

**Exemplo de arquivo válido:**
```csv
accountCode;competencia;debitAmount;creditAmount;balance;description
1.1.01.001;2024-01-31;1000.00;500.00;5500.00;Lançamento Janeiro
1.1.02.001;2024-01-31;50000.00;25000.00;125000.50;Movimentação Bancária
2.1.01.001;2024-01-31;0.00;15000.00;40000.00;Fornecedores Janeiro
1.1.01.001;2024-02-28;2000.00;1500.00;6000.00;Lançamento Fevereiro
```

### Validação de Período Contábil

```java
// Exemplo de validação
LocalDate competencia = LocalDate.parse(record.get("competencia"));
LocalDate periodoContabil = company.getPeriodoContabil();

if (competencia.isBefore(periodoContabil)) {
    errors.add(new ErrorDetail(
        lineNumber,
        String.format("Competência %s is before Período Contábil %s",
            competencia, periodoContabil)
    ));
    skippedLines++;
    continue;
}
```

### Response de Exemplo

**Sucesso completo:**
```json
{
  "success": true,
  "message": "Import completed successfully",
  "totalLines": 500,
  "processedLines": 500,
  "skippedLines": 0,
  "errors": []
}
```

**Com erros parciais:**
```json
{
  "success": true,
  "message": "Import completed with errors",
  "totalLines": 500,
  "processedLines": 495,
  "skippedLines": 5,
  "errors": [
    {"lineNumber": 12, "error": "Account code '9.9.99.999' not found for company/year"},
    {"lineNumber": 25, "error": "Competência 2023-12-31 is before Período Contábil 2024-01-01"},
    {"lineNumber": 50, "error": "Invalid date format: '31/01/2024'"}
  ]
}
```

### Performance

- Arquivo grande (50MB) pode conter ~500.000 linhas
- Processar em batches para evitar memory overflow
- Target: 10.000 linhas em < 30s (~333 linhas/segundo)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
