# Story 3.8: Entidade LinhaLucroPresumido e Repository

## Status

**Draft** (2025-12-27)

---

## Story

**As a** desenvolvedor,
**I want** entidade LinhaLucroPresumido relacionada a Company e ChartOfAccount,
**so that** possamos persistir Linhas para Cadastro de Lucro Presumido com seus códigos, descrições e contas contábeis associadas.

---

## Acceptance Criteria

1. Entidade JPA `LinhaLucroPresumidoEntity` criada estendendo `BaseEntity`:
   - `@ManyToOne @JoinColumn(nullable=false) CompanyEntity company` (empresa dona do cadastro)
   - `@Column(nullable=false) Integer codigo` (código numérico da linha - obrigatório)
   - `@Column(nullable=false, length=1000) String descricao` (descrição da linha - obrigatório)
   - `@Column(nullable=false) Integer fiscalYear` (ano fiscal, ex: 2024)

2. Entidade de associação `LinhaLucroPresumidoContaEntity` criada (ManyToMany explícito):
   - `@Id @GeneratedValue(strategy = IDENTITY) Long id`
   - `@ManyToOne @JoinColumn(nullable=false) LinhaLucroPresumidoEntity linhaLucroPresumido`
   - `@ManyToOne @JoinColumn(nullable=false) ChartOfAccountEntity chartOfAccount`
   - `@Column(nullable=false) Integer orderIndex` (ordem das contas na lista - para preservar ordem de inserção)

3. Relacionamento em `LinhaLucroPresumidoEntity`:
   - `@OneToMany(mappedBy="linhaLucroPresumido", cascade=ALL, orphanRemoval=true) List<LinhaLucroPresumidoContaEntity> contas`

4. Constraint de unicidade em `LinhaLucroPresumidoEntity`: `@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"company_id", "codigo", "fiscal_year"}))`

5. Interface `LinhaLucroPresumidoRepositoryPort` criada em `application/port/out/`:
   - `LinhaLucroPresumido save(LinhaLucroPresumido linha)`
   - `Optional<LinhaLucroPresumido> findById(Long id)`
   - `List<LinhaLucroPresumido> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<LinhaLucroPresumido> findByCompanyIdAndCodigoAndFiscalYear(Long companyId, Integer codigo, Integer fiscalYear)`
   - `Page<LinhaLucroPresumido> findByCompanyId(Long companyId, Pageable pageable)`

6. Interface `LinhaLucroPresumidoJpaRepository` criada estendendo `JpaRepository<LinhaLucroPresumidoEntity, Long>`:
   - `List<LinhaLucroPresumidoEntity> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<LinhaLucroPresumidoEntity> findByCompanyIdAndCodigoAndFiscalYear(Long companyId, Integer codigo, Integer fiscalYear)`

7. Classe `LinhaLucroPresumidoRepositoryAdapter` implementa `LinhaLucroPresumidoRepositoryPort`

8. Model `LinhaLucroPresumido` (domain) criado em `domain/model/` como POJO puro:
   - Contém campo `List<Long> chartOfAccountIds` (IDs das contas na ordem)

9. Mapper MapStruct `LinhaLucroPresumidoMapper` criado:
   - Mapeia `List<LinhaLucroPresumidoContaEntity>` para `List<Long>` (IDs ordenados)
   - Mapeia `List<Long>` para `List<LinhaLucroPresumidoContaEntity>` (ordem preservada via orderIndex)

10. Teste de integração valida:
    - Salvar linha com 3 contas associadas
    - Recuperar linha e validar que ordem das contas é preservada
    - Unique constraint funciona
    - Atualizar linha (adicionar/remover contas) funciona
    - Soft delete funciona
    - Orphan removal funciona (remover conta da lista remove associação)

---

## Tasks / Subtasks

- [ ] Criar entidade LinhaLucroPresumidoEntity (AC: 1, 3, 4)
  - [ ] Criar entity estendendo BaseEntity
  - [ ] Adicionar relacionamento ManyToOne com CompanyEntity
  - [ ] Adicionar campos: codigo, descricao, fiscalYear
  - [ ] Adicionar relacionamento OneToMany com LinhaLucroPresumidoContaEntity
  - [ ] Adicionar unique constraint

- [ ] Criar entidade LinhaLucroPresumidoContaEntity (AC: 2)
  - [ ] Criar entity de associação
  - [ ] ManyToOne com LinhaLucroPresumidoEntity
  - [ ] ManyToOne com ChartOfAccountEntity
  - [ ] Campo orderIndex para preservar ordem

- [ ] Criar domain model LinhaLucroPresumido (AC: 8)
  - [ ] POJO puro em `domain/model/`
  - [ ] Campo List<Long> chartOfAccountIds

- [ ] Criar LinhaLucroPresumidoRepositoryPort (AC: 5)
  - [ ] Interface em `application/port/out/`
  - [ ] Métodos: save, findById, etc.

- [ ] Criar LinhaLucroPresumidoJpaRepository (AC: 6)
  - [ ] Estender JpaRepository
  - [ ] Query methods

- [ ] Criar LinhaLucroPresumidoRepositoryAdapter (AC: 7)
  - [ ] Implementar port
  - [ ] Mapear entity/domain

- [ ] Criar LinhaLucroPresumidoMapper (AC: 9)
  - [ ] Interface MapStruct
  - [ ] Lógica de mapeamento com preservação de ordem

- [ ] Criar testes de integração (AC: 10)
  - [ ] Salvar linha com 3 contas
  - [ ] Validar ordem preservada
  - [ ] Testar unique constraint
  - [ ] Testar atualização (add/remove contas)
  - [ ] Testar soft delete
  - [ ] Testar orphan removal

---

## Dev Notes

### Exemplo de Código

**LinhaLucroPresumidoEntity.java:**
```java
@Entity
@Table(
    name = "linha_lucro_presumido",
    uniqueConstraints = @UniqueConstraint(columnNames = {"company_id", "codigo", "fiscal_year"})
)
public class LinhaLucroPresumidoEntity extends BaseEntity {

    @ManyToOne
    @JoinColumn(name = "company_id", nullable = false)
    private CompanyEntity company;

    @Column(name = "codigo", nullable = false)
    private Integer codigo;

    @Column(name = "descricao", nullable = false, length = 1000)
    private String descricao;

    @Column(name = "fiscal_year", nullable = false)
    private Integer fiscalYear;

    @OneToMany(mappedBy = "linhaLucroPresumido", cascade = CascadeType.ALL, orphanRemoval = true)
    @OrderBy("orderIndex ASC")
    private List<LinhaLucroPresumidoContaEntity> contas = new ArrayList<>();

    // Getters and setters
}
```

**LinhaLucroPresumidoContaEntity.java:**
```java
@Entity
@Table(name = "linha_lucro_presumido_conta")
public class LinhaLucroPresumidoContaEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "linha_lucro_presumido_id", nullable = false)
    private LinhaLucroPresumidoEntity linhaLucroPresumido;

    @ManyToOne
    @JoinColumn(name = "chart_of_account_id", nullable = false)
    private ChartOfAccountEntity chartOfAccount;

    @Column(name = "order_index", nullable = false)
    private Integer orderIndex;

    // Getters and setters
}
```

### Contexto de Negócio

**Linha de Lucro Presumido:**
- Representa uma linha da apuração de lucro presumido
- Cada linha pode ter múltiplas contas contábeis associadas
- A ordem das contas é importante e deve ser preservada
- Contas órfãs devem ser automaticamente removidas ao editar linha

### Mapeamento de Ordem

```java
// Exemplo de preservação de ordem
public LinhaLucroPresumidoEntity toEntity(LinhaLucroPresumido domain) {
    LinhaLucroPresumidoEntity entity = new LinhaLucroPresumidoEntity();
    // ... mapear campos básicos

    List<LinhaLucroPresumidoContaEntity> contas = new ArrayList<>();
    for (int i = 0; i < domain.getChartOfAccountIds().size(); i++) {
        Long accountId = domain.getChartOfAccountIds().get(i);
        LinhaLucroPresumidoContaEntity conta = new LinhaLucroPresumidoContaEntity();
        conta.setChartOfAccount(chartOfAccountRepository.findById(accountId).orElseThrow());
        conta.setOrderIndex(i);
        conta.setLinhaLucroPresumido(entity);
        contas.add(conta);
    }
    entity.setContas(contas);
    return entity;
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
