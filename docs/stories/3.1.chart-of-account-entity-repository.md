# Story 3.1: Entidade ChartOfAccount (Plano de Contas Contábil) e Repository

## Status

**✅ COMPLETED** (2026-01-07)

---

**Como** desenvolvedor,
**Eu quero** entidade ChartOfAccount com repository JPA incluindo campos ECF-specific e FK obrigatória para ContaReferencial,
**Para que** possamos persistir contas contábeis de cada empresa por ano fiscal vinculadas à tabela mestra RFB.

## Acceptance Criteria

Ver Epic 3 Story 3.1 para critérios completos. Principais pontos:

1. **Entidade JPA** `ChartOfAccountEntity` com campos:
   - Campos básicos: company, code, name, fiscalYear, accountType
   - **NOVOS campos ECF**: classe, nivel, natureza, afetaResultado, dedutivel
   - **NOVA FK obrigatória**: contaReferencialId → ContaReferencial
2. **Enums criados**: AccountType, ClasseContabil, NaturezaConta
3. **Constraint**: UNIQUE (company_id, code, fiscal_year)
4. **Repository Port/Adapter/Mapper** completo
5. **Testes**: Validar FK constraint, campos ECF persistência

## Tasks / Subtasks

- [x] **Task 1: Criar/validar enums** (AC: 2)
  - [x] AccountType (10 valores)
  - [x] ClasseContabil (12 valores)
  - [x] NaturezaConta (2 valores)

- [x] **Task 2: Criar Domain Model ChartOfAccount** (AC: 7)
  - [x] POJO puro sem dependências
  - [x] Campos: companyId, contaReferencialId, code, name, fiscalYear
  - [x] Campos ECF: accountType, classe, nivel, natureza, afetaResultado, dedutivel

- [x] **Task 3: Criar ChartOfAccountEntity** (AC: 1, 3)
  - [x] Estende BaseEntity
  - [x] FK Company (ManyToOne)
  - [x] FK ContaReferencial (ManyToOne, nullable=false)
  - [x] Unique constraint (company_id, code, fiscal_year)
  - [x] Todos campos ECF-specific

- [x] **Task 4: Criar ChartOfAccountRepositoryPort** (AC: 4)
  - [x] Métodos: save, findById, findByCompanyIdAndFiscalYear
  - [x] findByCompanyIdAndCodeAndFiscalYear, deleteById
  - [x] findByCompanyId com paginação

- [x] **Task 5: Criar ChartOfAccountJpaRepository** (AC: 5)
  - [x] Estende JpaRepository
  - [x] Query methods customizados

- [x] **Task 6: Criar ChartOfAccountRepositoryAdapter** (AC: 6)
  - [x] Implementa ChartOfAccountRepositoryPort
  - [x] Usa mapper para conversões
  - [x] Delega ao JpaRepository

- [x] **Task 7: Criar ChartOfAccountMapper** (AC: 8)
  - [x] MapStruct mapper
  - [x] Métodos: toDomain, toEntity, updateEntity
  - [x] Mapeamento correto FKs (company.id, contaReferencial.id)

- [x] **Task 8: Criar testes de integração** (AC: 9)
  - [x] 9 testes criados cobrindo todos AC
  - [x] TestContainers configurado
  - [x] Testes executados com sucesso (9 passed, 0 failed)

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log
- N/A - Arquivos já existiam e estavam corretos

### Completion Notes
- ✅ Todos arquivos já criados e validados
- ✅ Compilação bem-sucedida (0 erros)
- ✅ Checkstyle passou (0 violações)
- ✅ 9 testes de integração executados com sucesso
- ✅ **TESTES PASSARAM:** 9 passed, 0 failed, 0 errors (21.71s)
  - Validado: save com FK ContaReferencial, findById
  - Validado: Unique constraint (company+code+fiscalYear)
  - Validado: Versionamento por ano fiscal (mesmo código, anos diferentes)
  - Validado: findByCompanyIdAndFiscalYear
  - Validado: findByCompanyIdAndCodeAndFiscalYear
  - Validado: deleteById
  - Validado: Paginação por empresa
  - Validado: Campos ECF-specific (classe, nivel, natureza, afetaResultado, dedutivel)
  - Validado: Update preservando ID

### File List
**Existentes (validados):**
- `src/main/java/br/com/lalurecf/domain/enums/AccountType.java`
- `src/main/java/br/com/lalurecf/domain/enums/ClasseContabil.java`
- `src/main/java/br/com/lalurecf/domain/enums/NaturezaConta.java`
- `src/main/java/br/com/lalurecf/domain/model/ChartOfAccount.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/ChartOfAccountEntity.java`
- `src/main/java/br/com/lalurecf/application/port/out/ChartOfAccountRepositoryPort.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/repository/ChartOfAccountJpaRepository.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/ChartOfAccountRepositoryAdapter.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/ChartOfAccountMapper.java`
- `src/test/java/br/com/lalurecf/infrastructure/adapter/out/persistence/adapter/ChartOfAccountRepositoryAdapterTest.java`

### Change Log
- 2026-01-07: Validação completa da entidade ChartOfAccount e repository pattern
  - Verificação de arquivos existentes (todos corretos)
  - Execução de 9 testes de integração (100% sucesso)
  - Compilação e checkstyle validados (0 erros, 0 violações)
  - Testes de integração: ✅ 9 passed, 0 failed (TestContainers PostgreSQL 15.5)

---

## Definition of Done

- [x] Entidade com todos campos ECF + FK ContaReferencial
- [x] Enums criados
- [x] Repository completo
- [x] Testes passando - ✅ 9/9 passed
- [ ] Code review aprovado
- [ ] Merge em develop

**Referência detalhada**: docs/epics/epic-03-plano-contas-dados-contabeis.md - Story 3.1
