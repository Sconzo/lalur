# Story 2.11: Enum de Natureza do Parâmetro Tributário - Brownfield Addition

## Status

**Completed** (2025-01-24)

---

## Story

**As a** ADMIN,
**I want** que cada parâmetro tributário tenha uma natureza explícita (GLOBAL, MONTHLY, QUARTERLY),
**so that** o sistema saiba automaticamente como tratar cada parâmetro (se precisa de valores temporais ou não) e a interface possa se adaptar adequadamente.

**Contexto:** Atualmente a distinção entre parâmetros normais e temporais é implícita - descoberta apenas pela presença ou ausência de registros em `tb_valores_parametros_temporais`. Isso gera ambiguidade e dificulta validações. Esta story adiciona um campo explícito `nature` no `TaxParameter` para declarar a natureza do parâmetro no momento do cadastro.

---

## Story Context

**Existing System Integration:**
- Integrates with: `TaxParameter` (domain), `TaxParameterEntity` (JPA), `TaxParameterController` (REST)
- Technology: Java 21, Spring Boot, JPA/Hibernate, PostgreSQL
- Follows pattern: Enum como campo de entidade (similar a `Status`)
- Touch points: CRUD de parâmetros tributários, associação empresa-parâmetro, validação de valores temporais

---

## Acceptance Criteria

### Functional Requirements

1. **Criar enum `ParameterNature`:**
   ```java
   public enum ParameterNature {
       GLOBAL,      // Valor único para o ano todo (não aceita valores temporais)
       MONTHLY,     // Valor por mês (12 valores/ano)
       QUARTERLY    // Valor por trimestre (4 valores/ano)
   }
   ```

2. **Adicionar campo `nature` na entidade `TaxParameter`:**
   - Domain model: `TaxParameter.java` - adicionar `private ParameterNature nature;`
   - JPA entity: `TaxParameterEntity.java` - adicionar coluna `natureza` (VARCHAR 20)
   - Mapper: `TaxParameterMapper.java` - mapear `nature` ↔ `natureza`

3. **Migration de banco de dados:**
   - Adicionar coluna `natureza` na tabela `tb_parametros_tributarios`
   - Coluna NOT NULL com default `'GLOBAL'` para registros existentes
   - Constraint CHECK para valores válidos: `('GLOBAL', 'MONTHLY', 'QUARTERLY')`

4. **Atualizar DTOs:**
   - `CreateTaxParameterRequest`: adicionar campo `nature` (obrigatório)
   - `UpdateTaxParameterRequest`: adicionar campo `nature` (obrigatório)
   - `TaxParameterResponse`: adicionar campo `nature`

5. **Atualizar endpoints:**
   - `POST /tax-parameters`: aceitar e persistir `nature`
   - `PUT /tax-parameters/{id}`: aceitar e atualizar `nature`
   - `GET /tax-parameters`: retornar `nature` no response
   - `GET /tax-parameters/{id}`: retornar `nature` no response

6. **Validação de negócio ao criar valores temporais:**
   - Se `nature = GLOBAL`: não permitir criar valores temporais (retornar 400 Bad Request)
   - Se `nature = MONTHLY`: valores temporais devem ter `mes` preenchido
   - Se `nature = QUARTERLY`: valores temporais devem ter `trimestre` preenchido

7. **Endpoint para listar parâmetros por natureza:**
   - `GET /tax-parameters?nature=MONTHLY` - filtrar por natureza
   - Query parameter opcional

### Integration Requirements

8. Existing CRUD de parâmetros tributários continua funcionando
9. Associação empresa-parâmetro (`tb_empresa_parametros_tributarios`) não é afetada
10. Valores temporais existentes continuam válidos (migração define default GLOBAL)

### Quality Requirements

11. Testes de integração cobrem:
    - Criação de parâmetro com cada natureza
    - Atualização de natureza
    - Filtro por natureza
    - Validação: GLOBAL não aceita valores temporais
    - Validação: MONTHLY exige campo `mes`
    - Validação: QUARTERLY exige campo `trimestre`

12. Migration é reversível (rollback)

---

## Technical Notes

### Integration Approach
- Adicionar campo ao modelo existente (não cria novas entidades)
- Seguir padrão já usado para campo `Status`
- Validações adicionadas no `CompanyService` ao criar valores temporais

### Existing Pattern Reference
- Enum `Status` em `br.com.lalurecf.domain.model.Status`
- Mapeamento de enum em `TaxParameterEntity` (campo `status`)

### Key Constraints
- Parâmetros existentes receberão `GLOBAL` como default
- Mudança de natureza não deve invalidar valores temporais existentes (apenas log warning)
- Campo é obrigatório em criação, mas atualizável

---

## Definition of Done

- [ ] Enum `ParameterNature` criado
- [ ] Campo `nature` adicionado ao domain model e JPA entity
- [ ] Migration criada e testada (up/down)
- [ ] DTOs atualizados (request e response)
- [ ] Endpoints atualizados para aceitar/retornar `nature`
- [ ] Filtro por natureza implementado
- [ ] Validação de valores temporais implementada
- [ ] Testes de integração passando
- [ ] Código segue padrões existentes

---

## Risk and Compatibility Check

### Minimal Risk Assessment

| Risk | Mitigation | Rollback |
|------|------------|----------|
| Migration falha | Testar em ambiente de dev primeiro | Migration reversível com ALTER TABLE DROP COLUMN |
| Parâmetros existentes quebram | Default GLOBAL mantém comportamento atual | N/A |
| Frontend quebra | Campo nature é aditivo, não remove nada | Versionar API se necessário |

### Compatibility Verification

- [x] No breaking changes to existing APIs (campo é aditivo)
- [x] Database changes are additive only (nova coluna com default)
- [x] UI changes follow existing design patterns
- [x] Performance impact is negligible

---

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session
- [x] Integration approach is straightforward
- [x] Follows existing patterns exactly (Status enum)
- [x] No design or architecture work required

### Clarity Check

- [x] Story requirements are unambiguous
- [x] Integration points are clearly specified
- [x] Success criteria are testable
- [x] Rollback approach is simple

---

## Tasks / Subtasks

- [x] Criar Enum ParameterNature (AC: 1)
  - [x] Criar `ParameterNature.java` em `br.com.lalurecf.domain.enums`

- [x] Atualizar Domain Model (AC: 2)
  - [x] Adicionar campo `nature` em `TaxParameter.java`
  - [x] Adicionar campo `natureza` em `TaxParameterEntity.java`
  - [x] Atualizar `TaxParameterMapper.java`

- [x] Criar Migration (AC: 3)
  - [x] Criar migration V007 para adicionar coluna `natureza`
  - [x] Adicionar CHECK constraint
  - [x] Criar índice para performance

- [x] Atualizar DTOs (AC: 4)
  - [x] Adicionar `nature` em `CreateTaxParameterRequest`
  - [x] Adicionar `nature` em `UpdateTaxParameterRequest`
  - [x] Adicionar `nature` em `TaxParameterResponse`

- [x] Atualizar Service (AC: 5)
  - [x] Atualizar `TaxParameterService.create()` para persistir nature
  - [x] Atualizar `TaxParameterService.update()` para atualizar nature

- [x] Implementar Filtro por Natureza (AC: 7)
  - [x] Adicionar query parameter `nature` no endpoint de listagem
  - [x] Atualizar Specification para filtrar por natureza
  - [x] Atualizar ListTaxParametersUseCase interface

- [x] Implementar Validação de Valores Temporais (AC: 6)
  - [x] Validar no `CompanyService` ao criar valor temporal
  - [x] GLOBAL: rejeitar com 400
  - [x] MONTHLY: exigir campo `mes`
  - [x] QUARTERLY: exigir campo `trimestre`

- [x] Criar/Atualizar Testes de Integração (AC: 11)
  - [x] Testar CRUD com nature
  - [x] Testar filtro por nature
  - [x] Atualizar testes existentes para incluir nature

---

## Dev Notes

### Source Tree

```
src/main/java/br/com/lalurecf/
├── domain/
│   └── model/
│       ├── ParameterNature.java  (NOVO)
│       └── TaxParameter.java     (modificado)
├── application/
│   └── service/
│       ├── TaxParameterService.java  (modificado)
│       └── CompanyService.java       (modificado - validação)
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── TaxParameterController.java  (modificado)
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── TaxParameterEntity.java  (modificado)
    │           └── mapper/
    │               └── TaxParameterMapper.java  (modificado)
    └── dto/
        └── taxparameter/
            ├── CreateTaxParameterRequest.java  (modificado)
            ├── UpdateTaxParameterRequest.java  (modificado)
            └── TaxParameterResponse.java       (modificado)
```

### Migration SQL

```sql
-- Up
ALTER TABLE tb_parametros_tributarios
ADD COLUMN natureza VARCHAR(20) NOT NULL DEFAULT 'GLOBAL';

ALTER TABLE tb_parametros_tributarios
ADD CONSTRAINT chk_natureza CHECK (natureza IN ('GLOBAL', 'MONTHLY', 'QUARTERLY'));

-- Down
ALTER TABLE tb_parametros_tributarios DROP CONSTRAINT chk_natureza;
ALTER TABLE tb_parametros_tributarios DROP COLUMN natureza;
```

### Enum Implementation

```java
package br.com.lalurecf.domain.model;

public enum ParameterNature {
    GLOBAL,      // Valor único - não aceita valores temporais
    MONTHLY,     // Requer valores por mês (1-12)
    QUARTERLY    // Requer valores por trimestre (1-4)
}
```

### Validação ao Criar Valor Temporal

```java
// Em CompanyService.createTemporalValue()
TaxParameter param = taxParameterRepository.findById(taxParameterId)
    .orElseThrow(() -> new EntityNotFoundException("Parâmetro não encontrado"));

switch (param.getNature()) {
    case GLOBAL -> throw new IllegalArgumentException(
        "Parâmetro GLOBAL não aceita valores temporais");
    case MONTHLY -> {
        if (request.mes() == null) {
            throw new IllegalArgumentException(
                "Parâmetro MONTHLY requer campo 'mes'");
        }
    }
    case QUARTERLY -> {
        if (request.trimestre() == null) {
            throw new IllegalArgumentException(
                "Parâmetro QUARTERLY requer campo 'trimestre'");
        }
    }
}
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-24 | 1.0 | Story criada (brownfield) | John (PM) |

---

## QA Results

*A ser preenchido após revisão de QA*

---

## Dev Agent Record

### Agent Model Used
- **Claude Opus 4.5** (claude-opus-4-5-20251101)

### Completion Notes List
1. **Enum ParameterNature**: Criado em `domain.enums` com valores GLOBAL, MONTHLY, QUARTERLY
2. **Domain Model**: Adicionado campo `nature` em TaxParameter.java
3. **JPA Entity**: Adicionado campo `natureza` com @Enumerated(EnumType.STRING) e @Builder.Default
4. **Mapper**: Atualizado TaxParameterMapper com mapeamento nature ↔ natureza
5. **Migration V007**: Criada com coluna, CHECK constraint e índice
6. **DTOs**: Atualizados CreateTaxParameterRequest, UpdateTaxParameterRequest e TaxParameterResponse
7. **Service**: TaxParameterService atualizado para criar/atualizar/filtrar por nature
8. **Controller**: Adicionado query parameter `nature` no endpoint de listagem
9. **Validação**: CompanyService valida nature ao criar valores temporais
10. **Testes**: Atualizados todos os testes existentes e adicionados 6 novos testes para nature

### File List
**Novos Arquivos:**
- `src/main/java/br/com/lalurecf/domain/enums/ParameterNature.java`
- `src/main/resources/db/migration/V007__add_natureza_to_parametros_tributarios.sql`

**Arquivos Modificados:**
- `src/main/java/br/com/lalurecf/domain/model/TaxParameter.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/TaxParameterEntity.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/TaxParameterMapper.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/taxparameter/CreateTaxParameterRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/taxparameter/UpdateTaxParameterRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/taxparameter/TaxParameterResponse.java`
- `src/main/java/br/com/lalurecf/application/port/in/taxparameter/ListTaxParametersUseCase.java`
- `src/main/java/br/com/lalurecf/application/service/TaxParameterService.java`
- `src/main/java/br/com/lalurecf/application/service/CompanyService.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/TaxParameterController.java`
- `src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/TaxParameterControllerTest.java`
