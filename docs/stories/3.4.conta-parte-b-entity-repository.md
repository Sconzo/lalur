# Story 3.4: Entidade ContaDaParteB e Repository

## Status

**Draft** (2025-12-27)

---

## Story

**As a** desenvolvedor,
**I want** entidade ContaDaParteB relacionada a Company,
**so that** possamos persistir Contas da Parte B do LALUR com seus códigos e descrições.

---

## Acceptance Criteria

1. Entidade JPA `ContaDaParteBEntity` criada estendendo `BaseEntity`:
   - `@ManyToOne @JoinColumn(nullable=false) CompanyEntity company` (empresa dona do cadastro)
   - `@Column(nullable=false) String codigoDaContaB` (código da conta da Parte B - obrigatório)
   - `@Column(nullable=false, length=1000) String descricao` (descrição da conta - obrigatório)
   - `@Column(nullable=false) Integer fiscalYear` (ano fiscal, ex: 2024)

2. Constraint de unicidade: `@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"company_id", "codigo_da_conta_b", "fiscal_year"}))`
   - Garante que não existam códigos duplicados para mesma empresa + código + ano

3. Interface `ContaDaParteBRepositoryPort` criada em `application/port/out/`:
   - `ContaDaParteB save(ContaDaParteB conta)`
   - `Optional<ContaDaParteB> findById(Long id)`
   - `List<ContaDaParteB> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<ContaDaParteB> findByCompanyIdAndCodigoAndFiscalYear(Long companyId, String codigo, Integer fiscalYear)`
   - `Page<ContaDaParteB> findByCompanyId(Long companyId, Pageable pageable)`

4. Interface `ContaDaParteBJpaRepository` criada estendendo `JpaRepository<ContaDaParteBEntity, Long>`:
   - `List<ContaDaParteBEntity> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<ContaDaParteBEntity> findByCompanyIdAndCodigoDaContaBAndFiscalYear(Long companyId, String codigo, Integer fiscalYear)`

5. Classe `ContaDaParteBRepositoryAdapter` implementa `ContaDaParteBRepositoryPort`

6. Model `ContaDaParteB` (domain) criado em `domain/model/` como POJO puro

7. Mapper MapStruct `ContaDaParteBMapper` criado

8. Teste de integração valida:
   - Salvar conta da Parte B e recuperar por company + fiscalYear
   - Unique constraint funciona (duplicata lança exception)
   - Buscar conta por company + codigoDaContaB + fiscalYear
   - Soft delete funciona
   - Listagem paginada por empresa

---

## Tasks / Subtasks

- [ ] Criar entidade ContaDaParteBEntity (AC: 1, 2)
  - [ ] Criar entity estendendo BaseEntity
  - [ ] Adicionar relacionamento ManyToOne com CompanyEntity
  - [ ] Adicionar campos: codigoDaContaB, descricao, fiscalYear
  - [ ] Adicionar unique constraint (company_id, codigo_da_conta_b, fiscal_year)
  - [ ] Configurar índices para performance

- [ ] Criar domain model ContaDaParteB (AC: 6)
  - [ ] Criar POJO puro em `domain/model/`
  - [ ] Incluir todos campos da entidade

- [ ] Criar ContaDaParteBRepositoryPort (AC: 3)
  - [ ] Criar interface em `application/port/out/`
  - [ ] Adicionar métodos: save, findById, findByCompanyIdAndFiscalYear, etc.

- [ ] Criar ContaDaParteBJpaRepository (AC: 4)
  - [ ] Estender JpaRepository
  - [ ] Adicionar query methods customizados

- [ ] Criar ContaDaParteBRepositoryAdapter (AC: 5)
  - [ ] Implementar ContaDaParteBRepositoryPort
  - [ ] Injetar ContaDaParteBJpaRepository
  - [ ] Implementar mapeamento entity/domain

- [ ] Criar ContaDaParteBMapper (AC: 7)
  - [ ] Criar interface MapStruct
  - [ ] Mapear ContaDaParteBEntity ↔ ContaDaParteB

- [ ] Criar teste de integração (AC: 8)
  - [ ] Testar save e findByCompanyIdAndFiscalYear
  - [ ] Testar unique constraint
  - [ ] Testar findByCompanyIdAndCodigoDaContaBAndFiscalYear
  - [ ] Testar soft delete
  - [ ] Testar paginação

---

## Dev Notes

### Exemplo de Código

**ContaDaParteBEntity.java:**
```java
@Entity
@Table(
    name = "conta_da_parte_b",
    uniqueConstraints = @UniqueConstraint(columnNames = {"company_id", "codigo_da_conta_b", "fiscal_year"})
)
public class ContaDaParteBEntity extends BaseEntity {

    @ManyToOne
    @JoinColumn(name = "company_id", nullable = false)
    private CompanyEntity company;

    @Column(name = "codigo_da_conta_b", nullable = false)
    private String codigoDaContaB;

    @Column(name = "descricao", nullable = false, length = 1000)
    private String descricao;

    @Column(name = "fiscal_year", nullable = false)
    private Integer fiscalYear;

    // Getters and setters
}
```

### Contexto de Negócio

**Conta da Parte B do LALUR:**
- Códigos específicos usados na Parte B do Livro de Apuração do Lucro Real (LALUR)
- Cada empresa pode ter seus próprios códigos personalizados
- Códigos são vinculados a um ano fiscal específico
- Não há estrutura hierárquica - lista plana de códigos

### Padrões de Código

- **Nomenclatura**: seguir convenções Java (camelCase)
- **Validações**: constraints no banco + validações de negócio nos use cases
- **Testes**: usar TestContainers com PostgreSQL real

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
