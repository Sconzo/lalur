# Story 3.6: Entidade CodigoEnquadramentoLalur e Repository

## Status

**Draft** (2025-12-27)

---

## Story

**As a** desenvolvedor,
**I want** entidade CodigoEnquadramentoLalur relacionada a Company,
**so that** possamos persistir Códigos de Enquadramento do LALUR com seus códigos e históricos.

---

## Acceptance Criteria

1. Entidade JPA `CodigoEnquadramentoLalurEntity` criada estendendo `BaseEntity`:
   - `@ManyToOne @JoinColumn(nullable=false) CompanyEntity company` (empresa dona do cadastro)
   - `@Column(nullable=false) String codigoDeEnquadramento` (código de enquadramento - obrigatório)
   - `@Column(nullable=false, length=2000) String historico` (histórico/descrição - obrigatório)
   - `@Column(nullable=false) Integer fiscalYear` (ano fiscal, ex: 2024)

2. Constraint de unicidade: `@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"company_id", "codigo_de_enquadramento", "fiscal_year"}))`

3. Interface `CodigoEnquadramentoLalurRepositoryPort` criada em `application/port/out/`:
   - `CodigoEnquadramentoLalur save(CodigoEnquadramentoLalur codigo)`
   - `Optional<CodigoEnquadramentoLalur> findById(Long id)`
   - `List<CodigoEnquadramentoLalur> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<CodigoEnquadramentoLalur> findByCompanyIdAndCodigoAndFiscalYear(Long companyId, String codigo, Integer fiscalYear)`
   - `Page<CodigoEnquadramentoLalur> findByCompanyId(Long companyId, Pageable pageable)`

4. Interface `CodigoEnquadramentoLalurJpaRepository` criada estendendo `JpaRepository<CodigoEnquadramentoLalurEntity, Long>`:
   - `List<CodigoEnquadramentoLalurEntity> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `Optional<CodigoEnquadramentoLalurEntity> findByCompanyIdAndCodigoDeEnquadramentoAndFiscalYear(Long companyId, String codigo, Integer fiscalYear)`

5. Classe `CodigoEnquadramentoLalurRepositoryAdapter` implementa `CodigoEnquadramentoLalurRepositoryPort`

6. Model `CodigoEnquadramentoLalur` (domain) criado em `domain/model/` como POJO puro

7. Mapper MapStruct `CodigoEnquadramentoLalurMapper` criado

8. Teste de integração valida:
   - Salvar código e recuperar por company + fiscalYear
   - Unique constraint funciona
   - Buscar código por company + codigoDeEnquadramento + fiscalYear
   - Soft delete funciona
   - Listagem paginada por empresa

---

## Tasks / Subtasks

- [ ] Criar entidade CodigoEnquadramentoLalurEntity (AC: 1, 2)
  - [ ] Criar entity estendendo BaseEntity
  - [ ] Adicionar relacionamento ManyToOne com CompanyEntity
  - [ ] Adicionar campos: codigoDeEnquadramento, historico, fiscalYear
  - [ ] Adicionar unique constraint
  - [ ] Configurar índices

- [ ] Criar domain model CodigoEnquadramentoLalur (AC: 6)
  - [ ] Criar POJO puro em `domain/model/`

- [ ] Criar CodigoEnquadramentoLalurRepositoryPort (AC: 3)
  - [ ] Criar interface em `application/port/out/`
  - [ ] Adicionar métodos necessários

- [ ] Criar CodigoEnquadramentoLalurJpaRepository (AC: 4)
  - [ ] Estender JpaRepository
  - [ ] Adicionar query methods

- [ ] Criar CodigoEnquadramentoLalurRepositoryAdapter (AC: 5)
  - [ ] Implementar port
  - [ ] Injetar JpaRepository

- [ ] Criar CodigoEnquadramentoLalurMapper (AC: 7)
  - [ ] Interface MapStruct

- [ ] Criar teste de integração (AC: 8)
  - [ ] Testar save e find
  - [ ] Testar unique constraint
  - [ ] Testar soft delete
  - [ ] Testar paginação

---

## Dev Notes

### Exemplo de Código

**CodigoEnquadramentoLalurEntity.java:**
```java
@Entity
@Table(
    name = "codigo_enquadramento_lalur",
    uniqueConstraints = @UniqueConstraint(
        columnNames = {"company_id", "codigo_de_enquadramento", "fiscal_year"}
    )
)
public class CodigoEnquadramentoLalurEntity extends BaseEntity {

    @ManyToOne
    @JoinColumn(name = "company_id", nullable = false)
    private CompanyEntity company;

    @Column(name = "codigo_de_enquadramento", nullable = false)
    private String codigoDeEnquadramento;

    @Column(name = "historico", nullable = false, length = 2000)
    private String historico;

    @Column(name = "fiscal_year", nullable = false)
    private Integer fiscalYear;

    // Getters and setters
}
```

### Contexto de Negócio

**Código de Enquadramento LALUR:**
- Códigos usados para classificar lançamentos no LALUR
- Campo `historico` armazena descrição detalhada (até 2000 caracteres)
- Vinculado a empresa e ano fiscal
- Lista plana, sem hierarquia

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
