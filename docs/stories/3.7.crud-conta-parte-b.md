# Story 3.7: CRUD de Contas da Parte B (Manual)

**Como** CONTADOR,
**Eu quero** criar, listar, visualizar, editar e inativar Contas da Parte B manualmente,
**Para que** eu possa cadastrar contas específicas de e-Lalur/e-Lacs para apuração de IRPJ/CSLL.

## Acceptance Criteria

1. Controller `ContaParteBController` criado com endpoints:
   - `POST /api/v1/conta-parte-b` - criar conta (CONTADOR com header X-Company-Id)
   - `GET /api/v1/conta-parte-b` - listar contas com paginação (CONTADOR com header)
   - `GET /api/v1/conta-parte-b/{id}` - visualizar conta (CONTADOR com header)
   - `PUT /api/v1/conta-parte-b/{id}` - editar conta (CONTADOR com header)
   - `PATCH /api/v1/conta-parte-b/{id}/status` - alternar status (CONTADOR com header)
2. DTOs criados: `CreateContaParteBRequest`, `UpdateContaParteBRequest`, `ContaParteBResponse`
3. `CreateContaParteBRequest`:
   - `codigoConta` (obrigatório, String)
   - `descricao` (obrigatório, String, max 1000 chars)
   - `anoBase` (obrigatório, Integer)
   - `dataVigenciaInicio` (obrigatório, LocalDate)
   - `dataVigenciaFim` (opcional, LocalDate)
   - `tipoTributo` (obrigatório, enum: IRPJ/CSLL/AMBOS)
   - `saldoInicial` (obrigatório, BigDecimal)
   - `tipoSaldo` (obrigatório, enum: DEVEDOR/CREDOR)
4. `ContaParteBResponse`:
   - `id`, `codigoConta`, `descricao`, `anoBase`, `dataVigenciaInicio`, `dataVigenciaFim`, `tipoTributo`, `saldoInicial`, `tipoSaldo`, `status`, `createdAt`, `updatedAt`
5. Use cases implementados:
   - `CreateContaParteBUseCase`: valida company via `CompanyContext`, verifica unicidade, salva
   - `ListContaParteBUseCase`: retorna contas da empresa no contexto
   - `GetContaParteBUseCase`: retorna conta por ID
   - `UpdateContaParteBUseCase`: permite editar (exceto codigoConta e anoBase)
   - `ToggleContaParteBStatusUseCase`: alterna status
6. Validações:
   - codigoConta não pode ser vazio
   - descricao não pode ser vazia
   - anoBase deve ser >= 2000 e <= ano atual + 1
   - dataVigenciaInicio obrigatória
   - Se dataVigenciaFim fornecida, deve ser >= dataVigenciaInicio
   - saldoInicial >= 0
   - Combinação (company + codigoConta + anoBase) deve ser única
7. Listagem suporta:
   - Paginação: `?page=0&size=100&sort=codigoConta,asc`
   - Filtro por ano: `?anoBase=2024`
   - Filtro por tipo tributo: `?tipoTributo=IRPJ`
   - Busca: `?search=texto` (busca em codigoConta e descricao)
   - Filtro por status: `?include_inactive=true`
8. DTOs adicionais: `ToggleStatusRequest`, `ToggleStatusResponse` (reutilizados)
9. Teste valida:
   - CONTADOR consegue criar conta Parte B com todos campos
   - Código duplicado para mesma empresa/ano retorna 400
   - dataVigenciaFim < dataVigenciaInicio retorna 400
   - saldoInicial negativo retorna 400
   - CONTADOR sem header X-Company-Id recebe 400
   - Edição não permite mudar codigoConta ou anoBase
   - Toggle status funciona
   - Listagem com filtros funciona

## Dev Notes

### Endpoints REST

**POST /api/v1/conta-parte-b**
```json
{
  "codigoConta": "4.01.01",
  "descricao": "Adições - Despesas não dedutíveis",
  "anoBase": 2024,
  "dataVigenciaInicio": "2024-01-01",
  "dataVigenciaFim": null,
  "tipoTributo": "IRPJ",
  "saldoInicial": 0.00,
  "tipoSaldo": "DEVEDOR"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "codigoConta": "4.01.01",
  "descricao": "Adições - Despesas não dedutíveis",
  "anoBase": 2024,
  "dataVigenciaInicio": "2024-01-01",
  "dataVigenciaFim": null,
  "tipoTributo": "IRPJ",
  "saldoInicial": 0.00,
  "tipoSaldo": "DEVEDOR",
  "status": "ACTIVE",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

### Validações de Negócio

- **codigoConta**: não vazio
- **descricao**: não vazia, max 1000 chars
- **anoBase**: >= 2000 e <= (ano atual + 1)
- **dataVigenciaInicio**: obrigatória
- **dataVigenciaFim**: se fornecida, deve ser >= dataVigenciaInicio
- **saldoInicial**: >= 0
- **Unicidade**: (company_id + codigoConta + anoBase) deve ser única
- **Contexto**: CONTADOR precisa de header X-Company-Id

### Campos Imutáveis

Após criação, os seguintes campos NÃO podem ser editados:
- `codigoConta`
- `anoBase`

## Definition of Done

- [x] Controller criado com todos endpoints
- [x] DTOs criados e validados
- [x] Use cases implementados
- [x] Validações de negócio implementadas
- [x] Testes de integração criados e compilando
- [x] Documentação Swagger atualizada
- [ ] Code review aprovado
- [ ] Merge em develop

---

## Dev Agent Record

### Status
**Ready for Review** - Implementação e testes completos, aguardando code review

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- 3 DTOs criados com validações Bean Validation completas (CreateContaParteBRequest, UpdateContaParteBRequest, ContaParteBResponse)
- 5 Use Cases implementados (Create, List, Get, Update, ToggleStatus)
- ContaParteBService com todas validações de negócio (unicidade, vigência temporal, saldo >= 0)
- CompanyContext usado para vincular conta à empresa (header X-Company-Id)
- Controller com 5 endpoints REST documentados com Swagger (@PreAuthorize CONTADOR)
- Listagem com filtros (search, anoBase, tipoTributo, includeInactive) e paginação
- Campos imutáveis (codigoConta, anoBase) não presentes no UpdateRequest
- Testes de integração criados com 13 casos de teste cobrindo todos acceptance criteria
- Build compilou com sucesso (testes compilam corretamente)
- Correção de bug em Story 3.6 (test file usando Company domain incorreto)

### File List

**DTOs criados:**
- src/main/java/br/com/lalurecf/infrastructure/dto/contaparteb/CreateContaParteBRequest.java
- src/main/java/br/com/lalurecf/infrastructure/dto/contaparteb/UpdateContaParteBRequest.java
- src/main/java/br/com/lalurecf/infrastructure/dto/contaparteb/ContaParteBResponse.java

**Use Cases criados:**
- src/main/java/br/com/lalurecf/application/port/in/contaparteb/CreateContaParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/contaparteb/ListContaParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/contaparteb/GetContaParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/contaparteb/UpdateContaParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/contaparteb/ToggleContaParteBStatusUseCase.java

**Service criado:**
- src/main/java/br/com/lalurecf/application/service/ContaParteBService.java

**Mapper criado:**
- src/main/java/br/com/lalurecf/infrastructure/dto/mapper/ContaParteBDtoMapper.java

**Controller criado:**
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/ContaParteBController.java

**Testes criados:**
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/ContaParteBControllerTest.java

### Change Log
- 2026-01-08: Story 3.7 implementada - CRUD completo de Contas da Parte B com validações de negócio, filtros, autorização CONTADOR e testes de integração
- 2026-01-08: Testes de integração criados - 13 casos de teste cobrindo todos acceptance criteria (MockMvc + TestContainers)
- 2026-01-08: Bug fix Story 3.6 - Corrigido ContaParteBRepositoryAdapterTest para usar CompanyEntity ao invés de Company domain
