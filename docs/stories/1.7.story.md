# Story 1.7: Endpoint de Troca de Senha Obrigatória

## Status

**Ready for Review**

## Story

**Como** usuário,
**Eu quero** trocar minha senha quando obrigado (primeiro acesso ou reset por ADMIN),
**Para que** eu possa acessar o sistema com minha própria senha segura.

## Acceptance Criteria

1. Endpoint `POST /api/v1/auth/change-password` criado (autenticado)
2. DTO `ChangePasswordRequest`: `currentPassword` (obrigatório), `newPassword` (obrigatório, mín 8 caracteres)
3. DTO `ChangePasswordResponse`: `success` (boolean), `message`
4. Use case `ChangePasswordUseCase` implementado:
   - Valida senha atual do usuário autenticado
   - Valida nova senha (mínimo 8 caracteres, não pode ser igual à atual)
   - Faz hash BCrypt da nova senha
   - Atualiza senha e seta `mustChangePassword = false`
5. Response 200 OK com `{"success": true, "message": "Senha alterada com sucesso"}`
6. Response 400 Bad Request se senha atual incorreta: `{"success": false, "message": "Senha atual inválida"}`
7. Response 400 Bad Request se nova senha não atende requisitos
8. Teste valida troca de senha bem-sucedida atualiza `mustChangePassword` para false
9. Teste valida que senha atual incorreta é rejeitada
10. Teste valida que nova senha muito curta (< 8 chars) é rejeitada

## Tasks / Subtasks

- [x] **Task 1: Criar DTOs** (AC: 2, 3)
  - [x] `ChangePasswordRequest` com validações `@NotBlank`, `@Size(min=8)`
  - [x] `ChangePasswordResponse` com `success` e `message`

- [x] **Task 2: Criar Use Case e Service** (AC: 4)
  - [x] Interface `ChangePasswordUseCase` em `application/port/in`
  - [x] Implementação `ChangePasswordService` em `application/service`
  - [x] Injetar `UserRepositoryPort`, `PasswordEncoder`
  - [x] Obter email do usuário via `SecurityContext`
  - [x] Validar senha atual
  - [x] Validar nova senha (min 8 chars, diferente da atual)
  - [x] Atualizar senha e `mustChangePassword = false`

- [x] **Task 3: Criar Endpoint** (AC: 1, 5, 6, 7)
  - [x] Adicionar método em `AuthController`
  - [x] Anotar com `@PreAuthorize("isAuthenticated()")`
  - [x] Validar `@Valid ChangePasswordRequest`

- [x] **Task 4: Criar Exception Customizada**
  - [x] `InvalidCurrentPasswordException` para senha atual incorreta

- [x] **Task 5: Adicionar Exception Handler** (AC: 6)
  - [x] Handler para `InvalidCurrentPasswordException` → 400

- [x] **Task 6: Criar Testes** (AC: 8, 9, 10)
  - [x] Testar troca de senha bem-sucedida
  - [x] Testar senha atual incorreta
  - [x] Testar nova senha < 8 caracteres
  - [x] Validar que `mustChangePassword` muda para false

## Dev Notes

### Implementação ChangePasswordService

```java
@Service
@RequiredArgsConstructor
public class ChangePasswordService implements ChangePasswordUseCase {

    private final UserRepositoryPort userRepository;
    private final PasswordEncoder passwordEncoder;

    @Override
    @Transactional
    public ChangePasswordResponse changePassword(ChangePasswordRequest request) {
        String email = SecurityContextHolder.getContext().getAuthentication().getName();

        User user = userRepository.findByEmail(email)
            .orElseThrow(() -> new ResourceNotFoundException("Usuário não encontrado"));

        if (!passwordEncoder.matches(request.getCurrentPassword(), user.getPassword())) {
            throw new InvalidCurrentPasswordException("Senha atual inválida");
        }

        if (passwordEncoder.matches(request.getNewPassword(), user.getPassword())) {
            throw new BusinessRuleViolationException("Nova senha não pode ser igual à atual");
        }

        user.setPassword(passwordEncoder.encode(request.getNewPassword()));
        user.setMustChangePassword(false);
        userRepository.save(user);

        return ChangePasswordResponse.builder()
            .success(true)
            .message("Senha alterada com sucesso")
            .build();
    }
}
```

### Security Context Helper

Criar utility para obter usuário autenticado:

```java
package br.com.lalurecf.infrastructure.security;

import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;

@Component
public class SecurityContextHelper {

    public String getCurrentUserEmail() {
        return SecurityContextHolder.getContext().getAuthentication().getName();
    }
}
```

[Source: architecture/15-Segurança.md]

**Validação de Senha:**
- Mínimo 8 caracteres
- Nova senha != senha atual
- Hash BCrypt strength 12

### Testing

**Teste de Integração:**

```java
@DisplayName("ChangePasswordController - Testes de Integração")
class ChangePasswordIntegrationTest extends IntegrationTestBase {

    @Autowired
    private ChangePasswordUseCase changePasswordUseCase;

    @Autowired
    private UserRepositoryPort userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Test
    @DisplayName("Deve alterar senha com sucesso e setar mustChangePassword = false")
    void shouldChangePasswordSuccessfully() {
        // Arrange
        User user = createTestUser("test@test.com", "oldPassword123");
        authenticateUser(user);

        ChangePasswordRequest request = new ChangePasswordRequest(
            "oldPassword123",
            "newPassword123"
        );

        // Act
        ChangePasswordResponse response = changePasswordUseCase.changePassword(request);

        // Assert
        assertThat(response.getSuccess()).isTrue();
        User updated = userRepository.findByEmail("test@test.com").get();
        assertThat(updated.getMustChangePassword()).isFalse();
        assertThat(passwordEncoder.matches("newPassword123", updated.getPassword())).isTrue();
    }

    @Test
    @DisplayName("Deve rejeitar senha atual incorreta com 400")
    void shouldRejectWrongCurrentPassword() {
        // Arrange
        User user = createTestUser("test@test.com", "correctPassword");
        authenticateUser(user);

        ChangePasswordRequest request = new ChangePasswordRequest(
            "wrongPassword",
            "newPassword123"
        );

        // Act & Assert
        assertThatThrownBy(() -> changePasswordUseCase.changePassword(request))
            .isInstanceOf(InvalidCurrentPasswordException.class)
            .hasMessage("Senha atual inválida");
    }

    @Test
    @DisplayName("Deve rejeitar nova senha com menos de 8 caracteres")
    void shouldRejectShortPassword() {
        // Validation handled by @Size annotation - returns 400 Bad Request
        // Test via MockMvc to verify Bean Validation
    }
}
```

[Source: architecture/14-Estratégia-e-Padrões-de-Testes.md]

**Cobertura Esperada:** ≥70% (aplicação layer)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Story criada do Epic 01 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

N/A - Implementação realizada sem necessidade de debug logs.

### Completion Notes

Implementação completa da story 1.7 com todos os acceptance criteria atendidos:

- ✓ DTOs criados com validações Bean Validation apropriadas
- ✓ Use case e service implementados seguindo arquitetura hexagonal
- ✓ Endpoint REST criado com autenticação obrigatória via `@PreAuthorize`
- ✓ Exception customizada `InvalidCurrentPasswordException` criada
- ✓ Exception handlers adicionados ao `GlobalExceptionHandler` para retornar 400
- ✓ Testes de integração completos criados (8 cenários de teste)
- ✓ Código compila sem erros (0 violations Checkstyle)
- ✓ Segue padrões de código Google Java Style Guide
- ✓ Logging apropriado com SLF4J
- ✓ Transação configurada com `@Transactional`

**Nota sobre testes:** Os testes de integração foram criados e estão prontos, porém requerem Docker rodando para execução via TestContainers. O código foi validado via compilação (mvn clean compile) com sucesso.

### File List

**Novos arquivos criados:**
- `src/main/java/br/com/lalurecf/infrastructure/dto/auth/ChangePasswordRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/auth/ChangePasswordResponse.java`
- `src/main/java/br/com/lalurecf/application/port/in/ChangePasswordUseCase.java`
- `src/main/java/br/com/lalurecf/application/service/ChangePasswordService.java`
- `src/main/java/br/com/lalurecf/domain/exception/InvalidCurrentPasswordException.java`
- `src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/ChangePasswordIntegrationTest.java`

**Arquivos modificados:**
- `src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/AuthController.java` (adicionado endpoint /change-password)
- `src/main/java/br/com/lalurecf/infrastructure/exception/GlobalExceptionHandler.java` (adicionados handlers para InvalidCurrentPasswordException e BusinessRuleViolationException)

## QA Results

*Esta seção será preenchida pelo QA Agent após implementação.*
