# Story 1.11: CI/CD GitHub Actions Básico

## Status

**Ready for Review**

## Story

**Como** desenvolvedor,
**Eu quero** pipeline CI/CD no GitHub Actions,
**Para que** commits sejam validados automaticamente (build + testes).

## Acceptance Criteria

1. Arquivo `.github/workflows/ci.yml` criado com:
   - Trigger em push para `main` e `develop`, e em pull requests
   - Job `build`: checkout, setup Java 21, `mvn clean package -DskipTests`
   - Job `test`: `mvn test`, upload de JaCoCo coverage report como artifact
   - Job `docker`: build da imagem Docker (apenas se branch `main`)
2. Pipeline executa em runner `ubuntu-latest`
3. Secrets configurados no repositório: `JWT_SECRET`
4. Build falha se compilação falhar
5. Build falha se cobertura de testes < 70% (configuração JaCoCo no `pom.xml`)
6. Artefatos gerados: JAR, relatório de coverage
7. Badge de status do pipeline adicionado ao README.md
8. Teste: fazer push em branch `develop` e validar que pipeline executa com sucesso

## Tasks / Subtasks

- [x] **Task 1: Criar Estrutura de Diretórios**
  - [x] Criar `.github/workflows/`

- [x] **Task 2: Criar ci.yml** (AC: 1, 2)
  - [x] Criar `.github/workflows/ci.yml`
  - [x] Configurar triggers (push, pull_request) para branches main e develop
  - [x] Job build: checkout, setup Java 21, Maven build (-DskipTests)
  - [x] Job test: executar testes com PostgreSQL service, JaCoCo report e check
  - [x] Job docker: build imagem (condicional apenas em main)

- [x] **Task 3: Configurar JaCoCo no pom.xml** (AC: 5)
  - [x] Plugin JaCoCo já configurado no pom.xml
  - [x] Execução `jacoco:report` configurada
  - [x] Verificação threshold 70% configurada
  - [x] Goal `jacoco:check` configurado

- [ ] **Task 4: Configurar Secrets no GitHub** (AC: 3)
  - [ ] Settings → Secrets → New repository secret (requer acesso ao GitHub)
  - [ ] Nome: `JWT_SECRET`
  - [ ] Valor: string 256 bits

- [x] **Task 5: Adicionar Badge ao README** (AC: 7)
  - [x] Badges adicionados ao README.md:
    - CI Pipeline status badge
    - Coverage badge (≥70%)
    - Java 21 badge
    - Spring Boot 3.2.1 badge

- [ ] **Task 6: Teste de Validação** (AC: 8)
  - [ ] Fazer commit em branch `develop` (requer usuário)
  - [ ] Push para remoto (requer usuário)
  - [ ] Verificar execução em Actions tab (requer usuário)
  - [ ] Validar que build, test e upload funcionam (requer usuário)

## Dev Notes

### ci.yml - Implementação Completa

```yaml
name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: Run tests
        run: mvn test

      - name: Generate JaCoCo report
        run: mvn jacoco:report

      - name: Check coverage threshold
        run: mvn jacoco:check

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

  docker:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t lalurecf-app:latest -f docker/Dockerfile .

      - name: Save Docker image
        run: docker save lalurecf-app:latest | gzip > lalurecf-app.tar.gz

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: lalurecf-app.tar.gz
```

### JaCoCo Plugin - pom.xml

```xml
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
    <executions>
        <execution>
            <id>jacoco-initialize</id>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>jacoco-report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
        <execution>
            <id>jacoco-check</id>
            <goals>
                <goal>check</goal>
            </goals>
            <configuration>
                <rules>
                    <rule>
                        <element>PACKAGE</element>
                        <limits>
                            <limit>
                                <counter>LINE</counter>
                                <value>COVEREDRATIO</value>
                                <minimum>0.70</minimum>
                            </limit>
                        </limits>
                    </rule>
                </rules>
            </configuration>
        </execution>
    </executions>
</plugin>
```

[Source: architecture/03-Stack-Tecnológico.md]

**CI/CD:** GitHub Actions
**Code Coverage:** JaCoCo 0.8.11 (threshold ≥70%)

[Source: architecture/14-Estratégia-e-Padrões-de-Testes.md]

### Configurar Secrets no GitHub

1. Ir para Settings do repositório
2. Secrets and variables → Actions
3. New repository secret:
   - Name: `JWT_SECRET`
   - Secret: (string 256 bits)

### Badge no README

Adicionar ao topo do README.md:

```markdown
# Sistema LALUR V2 ECF - API Backend

![CI](https://github.com/username/lalur-v2-ecf/actions/workflows/ci.yml/badge.svg)
![Coverage](https://img.shields.io/badge/coverage-%E2%89%A570%25-brightgreen)
```

### Testing

**Teste Manual - Validação do Pipeline:**

**Pré-requisito:** Repositório configurado no GitHub com secrets

1. **Configurar Secrets no GitHub:**
   ```
   Settings → Secrets and variables → Actions → New repository secret

   Nome: JWT_SECRET
   Valor: (gerar string 256 bits - ex: openssl rand -base64 32)
   ```

2. **Criar Branch de Teste:**
   ```bash
   git checkout -b test-ci-pipeline
   ```

3. **Fazer Commit Trivial:**
   ```bash
   echo "# Test CI" >> README.md
   git add README.md
   git commit -m "test: validar pipeline CI/CD"
   git push origin test-ci-pipeline
   ```

4. **Validar Execução do Pipeline:**
   - Ir para GitHub → Actions tab
   - Verificar workflow "CI Pipeline" está executando
   - Aguardar conclusão (aprox. 5-10 minutos)

5. **Validar Job: build**
   - Status: ✅ Success
   - Verificar logs: "BUILD SUCCESS"
   - Verificar artifact: "app-jar" foi criado
   - Download artifact e verificar .jar existe

6. **Validar Job: test**
   - Status: ✅ Success
   - Verificar logs: "Tests run: X, Failures: 0, Errors: 0"
   - Verificar: JaCoCo report gerado
   - Verificar: Coverage threshold check passou (≥70%)
   - Verificar artifact: "jacoco-report" foi criado

7. **Validar Job: docker** (apenas se branch main)
   - Se branch develop: Job deve ser skipped
   - Se branch main:
     - Status: ✅ Success
     - Verificar logs: "Successfully built"
     - Verificar artifact: "docker-image" criado

8. **Validar Badge no README:**
   - Visualizar README.md no GitHub
   - Badge deve mostrar: ![CI](passing)
   - Clicar no badge deve abrir Actions tab

**Teste de Falha Intencional (Coverage Threshold):**

```bash
# Comentar testes para reduzir coverage abaixo de 70%
# Commit e push
git add .
git commit -m "test: validar falha por cobertura insuficiente"
git push

# Resultado esperado: Job 'test' deve FALHAR
# Mensagem: "Rule violated for package: coverage ratio is X, but expected minimum is 0.70"
```

**Teste Automatizado - Validação Local do Workflow:**

```bash
# Instalar act (GitHub Actions local runner)
# https://github.com/nektos/act

# Validar sintaxe do workflow
act --list

# Executar workflow localmente (dry-run)
act -n

# Executar job específico
act -j build

# Executar com secrets
act -s JWT_SECRET=test-secret-key-minimum-256-bits-long
```

**Validação da Configuração JaCoCo:**

```bash
# Executar localmente
mvn clean test jacoco:report jacoco:check

# Verificar relatório HTML
open target/site/jacoco/index.html

# Validar threshold
# Deve PASSAR se coverage ≥ 70%
# Deve FALHAR se coverage < 70%
```

[Source: architecture/03-Stack-Tecnológico.md]
[Source: architecture/14-Estratégia-e-Padrões-de-Testes.md]

**Pipeline Validation Checklist:**
- [ ] Workflow file criado em `.github/workflows/ci.yml`
- [ ] Secret `JWT_SECRET` configurado no GitHub
- [ ] Build job executa sem erros
- [ ] Test job executa todos os testes
- [ ] JaCoCo coverage check passa (≥70%)
- [ ] Docker job executa apenas em branch main
- [ ] Artifacts são criados e acessíveis
- [ ] Badge no README funciona corretamente
- [ ] Pipeline falha apropriadamente quando testes falham
- [ ] Pipeline falha quando coverage < 70%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-25 | 1.0 | Story criada do Epic 01 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

N/A - Implementação realizada sem necessidade de debug logs.

### Completion Notes

Implementação completa da story 1.11 com acceptance criteria atendidos:

- ✓ Arquivo `.github/workflows/ci.yml` criado com:
  - Triggers em push para `main` e `develop`, e em pull requests
  - Job `build`: checkout, setup Java 21 (Temurin), Maven clean package -DskipTests
  - Job `test`: PostgreSQL service container, Maven test, JaCoCo report e check (threshold 70%)
  - Job `docker`: build imagem Docker (condicional apenas se branch main)
  - Upload de artifacts: JAR, relatório JaCoCo, imagem Docker
- ✓ Pipeline configurado para runner `ubuntu-latest`
- ✓ Secrets configurados: `JWT_SECRET` usado no job test (requer configuração no GitHub pelo usuário)
- ✓ Build falha se compilação falhar (Maven retorna exit code != 0)
- ✓ Build falha se cobertura < 70% (JaCoCo check configurado no pom.xml)
- ✓ Artefatos gerados: app-jar, jacoco-report, docker-image (apenas em main)
- ✓ Badges adicionados ao README.md:
  - CI Pipeline status badge (requer substituir USERNAME/REPOSITORY)
  - Coverage badge (≥70%)
  - Java 21 badge
  - Spring Boot 3.2.1 badge

**Configuração do Pipeline:**
- Job `build`: Compila o projeto e gera JAR, faz upload do artifact
- Job `test`: Executa testes com PostgreSQL (service container), gera relatório JaCoCo, verifica threshold 70%, faz upload do relatório
- Job `docker`: Executa apenas em branch main após build e test, constrói imagem Docker, salva e faz upload

**PostgreSQL Service Container:**
- Adicionado service container no job test para executar testes de integração
- PostgreSQL 15.5 com database lalur_test, user/password: lalur/lalur123
- Health checks configurados para garantir que DB está pronto antes de executar testes

**JaCoCo Configuration:**
- Plugin já estava configurado no pom.xml com threshold de 70%
- Pipeline executa `jacoco:report` para gerar relatório HTML
- Pipeline executa `jacoco:check` para validar threshold - build falha se < 70%

**Nota sobre Tasks 4 e 6:**
- Task 4 (Configurar Secrets): Requer acesso ao GitHub para criar secret JWT_SECRET nas configurações do repositório
- Task 6 (Teste de Validação): Requer push para repositório remoto e verificação no GitHub Actions tab
- Usuário precisa:
  1. Criar secret JWT_SECRET no GitHub (Settings → Secrets → Actions)
  2. Atualizar USERNAME/REPOSITORY no badge do README.md
  3. Fazer push e verificar execução em Actions tab

### File List

**Novos arquivos criados:**

CI/CD:
- `.github/workflows/ci.yml`

**Arquivos modificados:**

Documentation:
- `README.md` (adicionados badges de CI, coverage, Java 21, Spring Boot)

## QA Results

*Esta seção será preenchida pelo QA Agent após implementação.*
