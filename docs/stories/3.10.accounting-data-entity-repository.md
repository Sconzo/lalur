# Story 3.10: Entidade AccountingData (Dados Contábeis Genéricos) e Repository

## Status

**Draft** (2025-12-27)

---

## Story

**As a** desenvolvedor,
**I want** entidade AccountingData relacionada a ChartOfAccount,
**so that** possamos persistir lançamentos contábeis genéricos (saldos, movimentações) por conta/competência vindos de sistemas ERP.

---

## Acceptance Criteria

1. Entidade JPA `AccountingDataEntity` criada estendendo `BaseEntity`:
   - `@ManyToOne @JoinColumn(nullable=false) ChartOfAccountEntity chartOfAccount` (conta contábil)
   - `@Column(nullable=false) LocalDate competencia` (data de competência, ex: 2024-01-31)
   - `@Column(precision=19, scale=2) BigDecimal debitAmount` (valor débito - opcional)
   - `@Column(precision=19, scale=2) BigDecimal creditAmount` (valor crédito - opcional)
   - `@Column(precision=19, scale=2) BigDecimal balance` (saldo final da conta naquela competência - calculado)
   - `@Column(length=500) String description` (descrição/histórico - opcional)

2. Interface `TemporalEntity` implementada (para Período Contábil):
   - `LocalDate getCompetencia()` retorna o campo `competencia`

3. Interface `AccountingDataRepositoryPort` criada:
   - `AccountingData save(AccountingData data)`
   - `Optional<AccountingData> findById(Long id)`
   - `List<AccountingData> findByChartOfAccountIdAndCompetencia(Long chartOfAccountId, LocalDate competencia)`
   - `List<AccountingData> findByCompanyIdAndFiscalYear(Long companyId, Integer fiscalYear)`
   - `void deleteById(Long id)`
   - `Page<AccountingData> findByChartOfAccountId(Long chartOfAccountId, Pageable pageable)`

4. Interface `AccountingDataJpaRepository` criada estendendo `JpaRepository<AccountingDataEntity, Long>`:
   - `@Query` customizadas para buscar por company (via join com ChartOfAccount)

5. Classe `AccountingDataRepositoryAdapter` implementa `AccountingDataRepositoryPort`

6. Model `AccountingData` (domain) criado como POJO puro

7. Mapper MapStruct `AccountingDataMapper` criado

8. Teste de integração valida:
   - Salvar dado contábil e recuperar por chartOfAccountId
   - Relacionamento ManyToOne com ChartOfAccount funciona
   - Campo competencia é persistido corretamente
   - Soft delete funciona
   - Query por company via join

---

## Tasks / Subtasks

- [ ] Criar entidade AccountingDataEntity (AC: 1, 2)
  - [ ] Criar entity estendendo BaseEntity
  - [ ] Relacionamento ManyToOne com ChartOfAccountEntity
  - [ ] Campos: competencia, debitAmount, creditAmount, balance, description
  - [ ] Implementar interface TemporalEntity

- [ ] Criar domain model AccountingData (AC: 6)
  - [ ] POJO puro em `domain/model/`

- [ ] Criar AccountingDataRepositoryPort (AC: 3)
  - [ ] Interface em `application/port/out/`
  - [ ] Métodos necessários

- [ ] Criar AccountingDataJpaRepository (AC: 4)
  - [ ] Estender JpaRepository
  - [ ] Query customizadas com join

- [ ] Criar AccountingDataRepositoryAdapter (AC: 5)
  - [ ] Implementar port

- [ ] Criar AccountingDataMapper (AC: 7)
  - [ ] Interface MapStruct

- [ ] Criar testes de integração (AC: 8)
  - [ ] Salvar e recuperar
  - [ ] Testar relacionamento ManyToOne
  - [ ] Testar campo competencia
  - [ ] Testar soft delete
  - [ ] Testar query por company

---

## Dev Notes

### Exemplo de Código

**AccountingDataEntity.java:**
```java
@Entity
@Table(name = "accounting_data")
public class AccountingDataEntity extends BaseEntity implements TemporalEntity {

    @ManyToOne
    @JoinColumn(name = "chart_of_account_id", nullable = false)
    private ChartOfAccountEntity chartOfAccount;

    @Column(name = "competencia", nullable = false)
    private LocalDate competencia;

    @Column(name = "debit_amount", precision = 19, scale = 2)
    private BigDecimal debitAmount;

    @Column(name = "credit_amount", precision = 19, scale = 2)
    private BigDecimal creditAmount;

    @Column(name = "balance", precision = 19, scale = 2)
    private BigDecimal balance;

    @Column(name = "description", length = 500)
    private String description;

    @Override
    public LocalDate getCompetencia() {
        return competencia;
    }

    // Getters and setters
}
```

**AccountingDataJpaRepository.java:**
```java
public interface AccountingDataJpaRepository extends JpaRepository<AccountingDataEntity, Long> {

    @Query("SELECT ad FROM AccountingDataEntity ad " +
           "JOIN ad.chartOfAccount coa " +
           "WHERE coa.company.id = :companyId " +
           "AND coa.fiscalYear = :fiscalYear " +
           "AND ad.status = 'ACTIVE'")
    List<AccountingDataEntity> findByCompanyIdAndFiscalYear(
        @Param("companyId") Long companyId,
        @Param("fiscalYear") Integer fiscalYear
    );

    List<AccountingDataEntity> findByChartOfAccountIdAndCompetencia(
        Long chartOfAccountId,
        LocalDate competencia
    );
}
```

### Contexto de Negócio

**Dados Contábeis Genéricos:**
- Representa lançamentos contábeis vindos de sistemas ERP
- Vinculado a uma conta contábil específica
- Competência: data de referência do lançamento (ex: 2024-01-31)
- Pode conter débito, crédito e/ou saldo
- Implementa TemporalEntity para validação de Período Contábil

### Interface TemporalEntity

```java
public interface TemporalEntity {
    LocalDate getCompetencia();
}
```

Esta interface é usada pelo `@EnforcePeriodoContabil` aspect para validar se a competência está dentro do período contábil permitido.

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
