# Story 2.8: Associação de Parâmetros Tributários a Empresas

## Status

**Draft**

---

## Story

**As a** ADMIN,
**I want** associar parâmetros tributários a uma empresa durante criação ou edição,
**so that** os cálculos tributários usem os parâmetros corretos para cada empresa.

**Nota:** Esta story foi modificada conforme [ADR-001](../architecture/adr-001-simplificacao-modelo-dados.md) - tabela associativa explícita com auditoria.

---

## Acceptance Criteria

1. **Criar nova entidade JPA `CompanyTaxParameterEntity`** (ADR-001 - tabela associativa explícita com auditoria):
   ```java
   @Entity
   @Table(name = "tb_empresa_parametros_tributarios",
          uniqueConstraints = @UniqueConstraint(columnNames = {"empresa_id", "parametro_tributario_id"}))
   class CompanyTaxParameterEntity {
       @Id @GeneratedValue(strategy = IDENTITY)
       Long id;

       @Column(name = "empresa_id", nullable = false)
       Long companyId;

       @Column(name = "parametro_tributario_id", nullable = false)
       Long taxParameterId;

       @Column(name = "criado_por")
       Long createdBy;  // ID do usuário que associou

       @Column(name = "criado_em")
       LocalDateTime createdAt;
   }
   ```

2. **Criar repository para associação:**
   - Interface `CompanyTaxParameterJpaRepository` estendendo `JpaRepository<CompanyTaxParameterEntity, Long>`
   - Métodos:
     - `List<CompanyTaxParameterEntity> findByCompanyId(Long companyId)`
     - `void deleteByCompanyIdAndTaxParameterId(Long companyId, Long taxParameterId)`
     - `void deleteAllByCompanyId(Long companyId)` (para substituir lista completa)

3. Endpoint `PUT /api/v1/companies/{id}/tax-parameters` criado (ADMIN only):
   - DTO `UpdateTaxParametersRequest`: `taxParameterIds` (lista de IDs)
   - DTO `UpdateTaxParametersResponse`: `success`, `message`, `taxParameters` (lista aplicada)
   - Protegido com `@PreAuthorize("hasRole('ADMIN')")`

4. Use case `UpdateCompanyTaxParametersUseCase` implementado:
   - Valida que todos IDs existem e estão ACTIVE
   - **Lógica de substituição (ADR-001):**
     1. Busca associações atuais: `findByCompanyId(companyId)`
     2. Deleta todas associações antigas: `deleteAllByCompanyId(companyId)`
     3. Cria novas associações com auditoria:
        - `createdBy` = ID do usuário autenticado (extraído do SecurityContext)
        - `createdAt` = timestamp atual
   - Retorna lista atualizada

5. Endpoint `GET /api/v1/companies/{id}/tax-parameters` lista parâmetros aplicados à empresa (ADMIN only):
   - Query deve fazer JOIN triplo:
     ```sql
     SELECT tp.* FROM tb_parametros_tributarios tp
     JOIN tb_empresa_parametros_tributarios ctp ON tp.id = ctp.parametro_tributario_id
     WHERE ctp.empresa_id = ? AND tp.status = 'ACTIVE'
     ```

6. Durante `CreateCompanyUseCase` (Story 2.3), parâmetros podem ser associados via `parametrosTributariosIds`:
   - Criar registros em `CompanyTaxParameterEntity` com auditoria

7. Validação: não permitir associar parâmetros INACTIVE

8. `CompanyResponse` (Story 2.3) inclui lista simplificada de parâmetros:
   - Cada item: `id`, `code`, `type`, `description`
   - **Novo (ADR-001):** Incluir `associatedAt` e `associatedBy` (email do usuário) para rastreabilidade

9. Teste valida:
   - ADMIN consegue associar parâmetros a empresa
   - Auditoria é registrada corretamente (`createdBy`, `createdAt`)
   - CONTADOR recebe 403 ao tentar associar parâmetros
   - IDs inválidos retornam 400 Bad Request
   - Parâmetros INACTIVE são rejeitados (400)
   - Listagem de parâmetros de empresa funciona com JOIN correto
   - Parâmetros são substituídos (não acumulados) em update
   - Unique constraint (empresa_id, parametro_tributario_id) previne duplicatas

---

## Tasks / Subtasks

- [ ] Criar Entidade CompanyTaxParameter (AC: 1)
  - [ ] Criar `CompanyTaxParameterEntity` em `infrastructure/adapter/out/persistence/entity/`
  - [ ] Adicionar `@Table(name="tb_empresa_parametros_tributarios")`
  - [ ] Adicionar UNIQUE constraint (empresa_id, parametro_tributario_id)
  - [ ] Adicionar campos de auditoria (createdBy, createdAt)
  - [ ] NÃO estender BaseEntity (sem soft delete)

- [ ] Criar Repository (AC: 2)
  - [ ] Criar `CompanyTaxParameterJpaRepository`
  - [ ] Adicionar método `findByCompanyId`
  - [ ] Adicionar método `deleteByCompanyIdAndTaxParameterId`
  - [ ] Adicionar método `deleteAllByCompanyId`

- [ ] Criar DTOs (AC: 3)
  - [ ] Criar `UpdateTaxParametersRequest`
  - [ ] Criar `UpdateTaxParametersResponse`

- [ ] Criar Use Case (AC: 4)
  - [ ] Implementar `UpdateCompanyTaxParametersUseCase`
  - [ ] Validar que todos parâmetros existem e estão ACTIVE
  - [ ] Implementar lógica de substituição
  - [ ] Obter userId do SecurityContext
  - [ ] Criar novas associações com auditoria

- [ ] Criar endpoints (AC: 3, 5)
  - [ ] Criar `PUT /api/v1/companies/{id}/tax-parameters`
  - [ ] Criar `GET /api/v1/companies/{id}/tax-parameters`
  - [ ] Adicionar `@PreAuthorize("hasRole('ADMIN')")`

- [ ] Integrar com CreateCompanyUseCase (AC: 6)
  - [ ] Modificar `CreateCompanyUseCase` para aceitar `parametrosTributariosIds`
  - [ ] Criar associações durante criação de empresa

- [ ] Atualizar CompanyResponse (AC: 8)
  - [ ] Incluir lista de parâmetros associados
  - [ ] Incluir `associatedAt` e `associatedBy`

- [ ] Criar testes de integração (AC: 9)
  - [ ] Testar associação de parâmetros (ADMIN)
  - [ ] Testar auditoria (createdBy, createdAt)
  - [ ] Testar CONTADOR recebe 403
  - [ ] Testar IDs inválidos (400)
  - [ ] Testar parâmetros INACTIVE rejeitados
  - [ ] Testar JOIN triplo na listagem
  - [ ] Testar substituição (não acumulação)
  - [ ] Testar unique constraint

---

## Dev Notes

### Mudanças do ADR-001
**Referência:** [ADR-001: Simplificação do Modelo de Dados](../architecture/adr-001-simplificacao-modelo-dados.md)

**Antes (ManyToMany automático):**
```java
@ManyToMany
@JoinTable(name = "company_tax_parameters")
private Set<TaxParameterEntity> taxParameters;
```

**Depois (Entidade explícita com auditoria):**
```java
@Entity
@Table(name = "tb_empresa_parametros_tributarios")
class CompanyTaxParameterEntity {
    @Id Long id;
    Long companyId;
    Long taxParameterId;
    Long createdBy;        // ✅ Auditoria
    LocalDateTime createdAt; // ✅ Auditoria
}
```

### Auditoria na Associação
- `createdBy`: ID do usuário que criou associação (do SecurityContext)
- `createdAt`: Timestamp da associação
- **SEM soft delete:** Associação é hard delete quando removida
- **Rastreabilidade:** Saber quem associou cada parâmetro

### Lógica de Substituição
**Quando ADMIN atualiza parâmetros:**
1. Delete todas associações antigas: `deleteAllByCompanyId(companyId)`
2. Crie novas associações com auditoria
3. **NÃO acumular:** Lista é substituída completamente

### Source Tree
```
src/main/java/br/com/lalurecf/
├── application/
│   ├── port/
│   │   └── in/
│   │       └── company/
│   │           └── UpdateCompanyTaxParametersUseCase.java
│   └── service/
│       └── CompanyService.java  # Adicionar método
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── CompanyController.java  # Adicionar endpoints
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── CompanyTaxParameterEntity.java
    │           └── repository/
    │               └── CompanyTaxParameterJpaRepository.java
    └── dto/
        └── company/
            ├── UpdateTaxParametersRequest.java
            └── UpdateTaxParametersResponse.java
```

### Query com JOIN Triplo
**Para listar parâmetros de uma empresa:**
```java
@Query("""
    SELECT tp FROM TaxParameterEntity tp
    JOIN CompanyTaxParameterEntity ctp ON tp.id = ctp.taxParameterId
    WHERE ctp.companyId = :companyId AND tp.status = 'ACTIVE'
""")
List<TaxParameterEntity> findActiveByCompanyId(@Param("companyId") Long companyId);
```

### SecurityContext para Auditoria
```java
Long userId = SecurityContextHelper.getCurrentUserId();
String userEmail = SecurityContextHelper.getCurrentUserEmail();
```

### Validações
1. **Parâmetros existem:** Todos IDs devem existir
2. **Parâmetros ACTIVE:** Não permitir associar INACTIVE
3. **Unique constraint:** (empresa_id, parametro_tributario_id)

### Padrões de Código
- **Transações:** `@Transactional` para delete + insert atômico
- **Auditoria:** SEMPRE registrar quem e quando associou

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
└── infrastructure/
    └── adapter/
        └── in/
            └── rest/
                └── CompanyControllerTest.java
```

#### Cenários Críticos
1. **Auditoria:** Validar createdBy e createdAt
2. **Substituição:** Nova lista substitui antiga (não acumula)
3. **Unique constraint:** Duplicata deve falhar
4. **JOIN triplo:** Listagem funciona corretamente
5. **Parâmetro INACTIVE:** Não pode ser associado

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 (modificada conforme ADR-001) | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante implementação*

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
*A ser preenchido durante implementação*

### File List
*A ser preenchido durante implementação*

---

## QA Results
*A ser preenchido após revisão de QA*
