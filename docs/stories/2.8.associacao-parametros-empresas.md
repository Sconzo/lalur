# Story 2.8: Associação de Parâmetros Tributários a Empresas

## Status

**Ready for Review** - Implementação completa com testes

---

## Story

**As a** ADMIN,
**I want** associar parâmetros tributários a uma empresa durante criação ou edição,
**so that** os cálculos tributários usem os parâmetros corretos para cada empresa.

**Nota:** Esta story foi modificada conforme [ADR-001](../architecture/adr-001-simplificacao-modelo-dados.md) - tabela associativa explícita com auditoria.

---

## Acceptance Criteria

1. **Criar nova entidade JPA `CompanyTaxParameterEntity`** (ADR-001 - tabela associativa explícita com auditoria):
   ```java
   @Entity
   @Table(name = "tb_empresa_parametros_tributarios",
          uniqueConstraints = @UniqueConstraint(columnNames = {"empresa_id", "parametro_tributario_id"}))
   class CompanyTaxParameterEntity {
       @Id @GeneratedValue(strategy = IDENTITY)
       Long id;

       @Column(name = "empresa_id", nullable = false)
       Long companyId;

       @Column(name = "parametro_tributario_id", nullable = false)
       Long taxParameterId;

       @Column(name = "criado_por")
       Long createdBy;  // ID do usuário que associou

       @Column(name = "criado_em")
       LocalDateTime createdAt;
   }
   ```

2. **Criar repository para associação:**
   - Interface `CompanyTaxParameterJpaRepository` estendendo `JpaRepository<CompanyTaxParameterEntity, Long>`
   - Métodos:
     - `List<CompanyTaxParameterEntity> findByCompanyId(Long companyId)`
     - `void deleteByCompanyIdAndTaxParameterId(Long companyId, Long taxParameterId)`
     - `void deleteAllByCompanyId(Long companyId)` (para substituir lista completa)

3. Endpoint `PUT /api/v1/companies/{id}/tax-parameters` criado (ADMIN only):
   - DTO `UpdateTaxParametersRequest`: `taxParameterIds` (lista de IDs)
   - DTO `UpdateTaxParametersResponse`: `success`, `message`, `taxParameters` (lista aplicada)
   - Protegido com `@PreAuthorize("hasRole('ADMIN')")`

4. Use case `UpdateCompanyTaxParametersUseCase` implementado:
   - Valida que todos IDs existem e estão ACTIVE
   - **Lógica de substituição (ADR-001):**
     1. Busca associações atuais: `findByCompanyId(companyId)`
     2. Deleta todas associações antigas: `deleteAllByCompanyId(companyId)`
     3. Cria novas associações com auditoria:
        - `createdBy` = ID do usuário autenticado (extraído do SecurityContext)
        - `createdAt` = timestamp atual
   - Retorna lista atualizada

5. Endpoint `GET /api/v1/companies/{id}/tax-parameters` lista parâmetros aplicados à empresa (ADMIN only):
   - Query deve fazer JOIN triplo:
     ```sql
     SELECT tp.* FROM tb_parametros_tributarios tp
     JOIN tb_empresa_parametros_tributarios ctp ON tp.id = ctp.parametro_tributario_id
     WHERE ctp.empresa_id = ? AND tp.status = 'ACTIVE'
     ```

6. Durante `CreateCompanyUseCase` (Story 2.3), parâmetros podem ser associados via `parametrosTributariosIds`:
   - Criar registros em `CompanyTaxParameterEntity` com auditoria

7. Validação: não permitir associar parâmetros INACTIVE

8. `CompanyResponse` (Story 2.3) inclui lista simplificada de parâmetros:
   - Cada item: `id`, `code`, `type`, `description`
   - **Novo (ADR-001):** Incluir `associatedAt` e `associatedBy` (email do usuário) para rastreabilidade

9. Teste valida:
   - ADMIN consegue associar parâmetros a empresa
   - Auditoria é registrada corretamente (`createdBy`, `createdAt`)
   - CONTADOR recebe 403 ao tentar associar parâmetros
   - IDs inválidos retornam 400 Bad Request
   - Parâmetros INACTIVE são rejeitados (400)
   - Listagem de parâmetros de empresa funciona com JOIN correto
   - Parâmetros são substituídos (não acumulados) em update
   - Unique constraint (empresa_id, parametro_tributario_id) previne duplicatas

---

## Tasks / Subtasks

- [x] Criar Entidade CompanyTaxParameter (AC: 1)
  - [x] Criar `CompanyTaxParameterEntity` em `infrastructure/adapter/out/persistence/entity/`
  - [x] Adicionar `@Table(name="tb_empresa_parametros_tributarios")`
  - [x] Adicionar UNIQUE constraint (empresa_id, parametro_tributario_id)
  - [x] Adicionar campos de auditoria (createdBy, createdAt)
  - [x] NÃO estender BaseEntity (sem soft delete)

- [x] Criar Repository (AC: 2)
  - [x] Criar `CompanyTaxParameterJpaRepository`
  - [x] Adicionar método `findByCompanyId`
  - [x] Adicionar método `deleteByCompanyIdAndTaxParameterId`
  - [x] Adicionar método `deleteAllByCompanyId`

- [x] Criar DTOs (AC: 3)
  - [x] Criar `UpdateTaxParametersRequest`
  - [x] Criar `UpdateTaxParametersResponse`
  - [x] Atualizar `TaxParameterSummary` com campos adicionais

- [x] Criar Use Case (AC: 4)
  - [x] Implementar `UpdateCompanyTaxParametersUseCase`
  - [x] Implementar `ListCompanyTaxParametersUseCase`
  - [x] Validar que todos parâmetros existem e estão ACTIVE
  - [x] Implementar lógica de substituição
  - [x] Obter userId do SecurityContext
  - [x] Criar novas associações com auditoria

- [x] Criar endpoints (AC: 3, 5)
  - [x] Criar `PUT /api/v1/companies/{id}/tax-parameters`
  - [x] Criar `GET /api/v1/companies/{id}/tax-parameters`
  - [x] Adicionar `@PreAuthorize("hasRole('ADMIN')")`

- [x] Integrar com CreateCompanyUseCase (AC: 6)
  - [x] CreateCompanyUseCase já aceita `outrosParametrosIds`
  - [x] Criar associações durante criação de empresa
  - [x] Atualizar createTaxParameterAssociation com auditoria completa

- [x] Atualizar CompanyResponse (AC: 8)
  - [x] TaxParameterSummary atualizado com tipo, associatedAt e associatedBy
  - [x] Métodos toResponse e toDetailResponse atualizados

- [x] Criar testes de integração (AC: 9)
  - [x] Testar associação de parâmetros (ADMIN)
  - [x] Testar auditoria (createdBy, createdAt)
  - [x] Testar CONTADOR recebe 403
  - [x] Testar IDs inválidos (400)
  - [x] Testar parâmetros INACTIVE rejeitados
  - [x] Testar JOIN triplo na listagem
  - [x] Testar substituição (não acumulação)
  - [x] Testar unique constraint

---

## Dev Notes

### Mudanças do ADR-001
**Referência:** [ADR-001: Simplificação do Modelo de Dados](../architecture/adr-001-simplificacao-modelo-dados.md)

**Antes (ManyToMany automático):**
```java
@ManyToMany
@JoinTable(name = "company_tax_parameters")
private Set<TaxParameterEntity> taxParameters;
```

**Depois (Entidade explícita com auditoria):**
```java
@Entity
@Table(name = "tb_empresa_parametros_tributarios")
class CompanyTaxParameterEntity {
    @Id Long id;
    Long companyId;
    Long taxParameterId;
    Long createdBy;        // ✅ Auditoria
    LocalDateTime createdAt; // ✅ Auditoria
}
```

### Auditoria na Associação
- `createdBy`: ID do usuário que criou associação (do SecurityContext)
- `createdAt`: Timestamp da associação
- **SEM soft delete:** Associação é hard delete quando removida
- **Rastreabilidade:** Saber quem associou cada parâmetro

### Lógica de Substituição
**Quando ADMIN atualiza parâmetros:**
1. Delete todas associações antigas: `deleteAllByCompanyId(companyId)`
2. Crie novas associações com auditoria
3. **NÃO acumular:** Lista é substituída completamente

### Source Tree
```
src/main/java/br/com/lalurecf/
├── application/
│   ├── port/
│   │   └── in/
│   │       └── company/
│   │           └── UpdateCompanyTaxParametersUseCase.java
│   └── service/
│       └── CompanyService.java  # Adicionar método
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── CompanyController.java  # Adicionar endpoints
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── CompanyTaxParameterEntity.java
    │           └── repository/
    │               └── CompanyTaxParameterJpaRepository.java
    └── dto/
        └── company/
            ├── UpdateTaxParametersRequest.java
            └── UpdateTaxParametersResponse.java
```

### Query com JOIN Triplo
**Para listar parâmetros de uma empresa:**
```java
@Query("""
    SELECT tp FROM TaxParameterEntity tp
    JOIN CompanyTaxParameterEntity ctp ON tp.id = ctp.taxParameterId
    WHERE ctp.companyId = :companyId AND tp.status = 'ACTIVE'
""")
List<TaxParameterEntity> findActiveByCompanyId(@Param("companyId") Long companyId);
```

### SecurityContext para Auditoria
```java
Long userId = SecurityContextHelper.getCurrentUserId();
String userEmail = SecurityContextHelper.getCurrentUserEmail();
```

### Validações
1. **Parâmetros existem:** Todos IDs devem existir
2. **Parâmetros ACTIVE:** Não permitir associar INACTIVE
3. **Unique constraint:** (empresa_id, parametro_tributario_id)

### Padrões de Código
- **Transações:** `@Transactional` para delete + insert atômico
- **Auditoria:** SEMPRE registrar quem e quando associou

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
└── infrastructure/
    └── adapter/
        └── in/
            └── rest/
                └── CompanyControllerTest.java
```

#### Cenários Críticos
1. **Auditoria:** Validar createdBy e createdAt
2. **Substituição:** Nova lista substitui antiga (não acumula)
3. **Unique constraint:** Duplicata deve falhar
4. **JOIN triplo:** Listagem funciona corretamente
5. **Parâmetro INACTIVE:** Não pode ser associado

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 (modificada conforme ADR-001) | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
N/A

### Completion Notes List
- ✅ Entidade CompanyTaxParameterEntity criada com auditoria
- ✅ Repository com métodos de associação/desassociação implementado
- ✅ DTOs criados (UpdateTaxParametersRequest/Response)
- ✅ TaxParameterSummary atualizado com campos de auditoria (tipo, associatedAt, associatedBy)
- ✅ Use cases implementados (UpdateCompanyTaxParametersUseCase, ListCompanyTaxParametersUseCase)
- ✅ Endpoints REST adicionados ao CompanyController (PUT e GET)
- ✅ Lógica de substituição implementada (delete all + insert new)
- ✅ Integração com CreateCompanyUseCase (createTaxParameterAssociation atualizado)
- ✅ Deduplicação de parâmetros implementada (evita violação de unique constraint)
- ✅ Testes de integração completos (8 novos testes adicionados ao CompanyControllerTest):
  - shouldUpdateTaxParametersSuccessfully
  - shouldListTaxParametersSuccessfully
  - shouldReturn403WhenContadorTriesToUpdateTaxParameters
  - shouldReturn400WhenInvalidTaxParameterIds
  - shouldVerifyAuditTrailInTaxParameters (NOVO)
  - shouldRejectInactiveTaxParameters (NOVO)
  - shouldReplaceTaxParametersNotAccumulate (NOVO)
  - shouldPreventDuplicateAssociations (NOVO)
- ✅ Todos os testes passando (21 tests, 0 failures, 0 errors)
- ⚠️ KNOWN LIMITATION: Buscar email do usuário pelo ID para auditoria (placeholder: "admin@example.com")

### File List
**Created:**
- src/main/java/br/com/lalurecf/infrastructure/dto/company/UpdateTaxParametersRequest.java
- src/main/java/br/com/lalurecf/infrastructure/dto/company/UpdateTaxParametersResponse.java
- src/main/java/br/com/lalurecf/application/port/in/company/UpdateCompanyTaxParametersUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/company/ListCompanyTaxParametersUseCase.java
- src/test/resources/setup-tax-parameter-tests.sql (test data setup)

**Modified:**
- src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/entity/CompanyTaxParameterEntity.java (added @Builder)
- src/main/java/br/com/lalurecf/infrastructure/dto/company/TaxParameterSummary.java (added audit fields)
- src/main/java/br/com/lalurecf/application/service/CompanyService.java (added use case methods + deduplication logic)
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/CompanyController.java (added endpoints)
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/CompanyControllerTest.java (added 8 tests)

---

## QA Results
*A ser preenchido após revisão de QA*
