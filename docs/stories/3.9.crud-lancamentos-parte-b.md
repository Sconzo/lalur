# Story 3.9: CRUD de Lançamentos da Parte B (Manual)

**Como** CONTADOR,
**Eu quero** criar, listar, visualizar, editar e inativar Lançamentos da Parte B manualmente,
**Para que** eu possa registrar ajustes fiscais (adições/exclusões) IRPJ/CSLL com fundamentação via parâmetros tributários.

## Acceptance Criteria

1. Controller `LancamentoParteBController` criado com endpoints CRUD completo
2. DTOs criados: `CreateLancamentoParteBRequest`, `UpdateLancamentoParteBRequest`, `LancamentoParteBResponse`
3. `CreateLancamentoParteBRequest` com campos:
   - mesReferencia, anoReferencia, tipoApuracao, tipoRelacionamento
   - contaContabilId, contaParteBId (nullable conforme tipoRelacionamento)
   - parametroTributarioId (obrigatório)
   - tipoAjuste, descricao, valor
4. Use cases implementados:
   - `CreateLancamentoParteBUseCase`: valida company, parametroTributario, FKs condicionais
   - `ListLancamentoParteBUseCase`: retorna lançamentos da empresa
   - `GetLancamentoParteBUseCase`: retorna por ID
   - `UpdateLancamentoParteBUseCase`: permite editar com revalidações
   - `ToggleLancamentoParteBStatusUseCase`: alterna status
5. Validações:
   - mesReferencia entre 1 e 12
   - anoReferencia >= 2000 e <= ano atual + 1
   - parametroTributarioId deve existir e estar ACTIVE
   - Validações condicionais de FKs conforme tipoRelacionamento
   - valor > 0
6. Listagem suporta filtros: anoReferencia, mesReferencia, tipoApuracao, tipoAjuste, status
7. Teste valida:
   - Criação com todos tipos de relacionamento
   - Validações de FK condicional funcionam
   - Rejeita parametroTributario inexistente ou INACTIVE
   - Rejeita contas de outra empresa
   - Filtros funcionam corretamente

## Technical Notes

- **Validação de FK condicional**: Implementar lógica customizada baseada em tipoRelacionamento
- **Fundamentação fiscal obrigatória**: parametroTributarioId sempre requerido
- **CompanyContext**: Validação de empresa via header X-Company-Id

## Definition of Done

- [x] Controller com todos endpoints
- [x] DTOs criados e validados
- [x] Use cases implementados
- [x] Validações condicionais implementadas
- [x] Documentação Swagger
- [x] Testes de integração
- [ ] Code review
- [ ] Merge em develop

---

## Dev Agent Record

### Status
**Ready for Review** - Implementação completa com validações condicionais de FK e testes de integração (20/20 testes passando), aguardando code review

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- 3 DTOs criados com validações Bean Validation completas (CreateLancamentoParteBRequest, UpdateLancamentoParteBRequest, LancamentoParteBResponse)
- 5 Use Cases implementados (Create, List, Get, Update, ToggleStatus)
- LancamentoParteBService com todas validações de negócio:
  * Validação de Company Context (header X-Company-Id obrigatório)
  * Validação de parâmetro tributário (existe e está ACTIVE)
  * Validações condicionais de FK baseadas em tipoRelacionamento:
    - CONTA_CONTABIL: requer contaContabilId, contaParteBId deve ser null
    - CONTA_PARTE_B: requer contaParteBId, contaContabilId deve ser null
    - AMBOS: requer ambas FKs
  * Validação de que contas pertencem à mesma empresa do contexto
  * Validação de mesReferencia (1-12) e anoReferencia (>= 2000, <= ano+1)
  * Validação de valor > 0
- LancamentoParteBDtoMapper para conversão domain → DTO
- Controller com 5 endpoints REST documentados com Swagger (@PreAuthorize CONTADOR)
- Listagem com filtros (anoReferencia, mesReferencia, tipoApuracao, tipoAjuste, includeInactive) e paginação
- 20 testes de integração implementados cobrindo todos cenários de validação
- Build e testes executaram com sucesso (20/20 passando)

### File List

**DTOs criados:**
- src/main/java/br/com/lalurecf/infrastructure/dto/lancamentoparteb/CreateLancamentoParteBRequest.java
- src/main/java/br/com/lalurecf/infrastructure/dto/lancamentoparteb/UpdateLancamentoParteBRequest.java
- src/main/java/br/com/lalurecf/infrastructure/dto/lancamentoparteb/LancamentoParteBResponse.java

**Use Cases criados:**
- src/main/java/br/com/lalurecf/application/port/in/lancamentoparteb/CreateLancamentoParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/lancamentoparteb/ListLancamentoParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/lancamentoparteb/GetLancamentoParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/lancamentoparteb/UpdateLancamentoParteBUseCase.java
- src/main/java/br/com/lalurecf/application/port/in/lancamentoparteb/ToggleLancamentoParteBStatusUseCase.java

**Service criado:**
- src/main/java/br/com/lalurecf/application/service/LancamentoParteBService.java

**Mapper criado:**
- src/main/java/br/com/lalurecf/infrastructure/dto/mapper/LancamentoParteBDtoMapper.java

**Controller criado:**
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoParteBController.java

**Testes criados:**
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoParteBControllerTest.java

### Change Log
- 2026-01-08: Story 3.9 implementada - CRUD completo de Lançamentos da Parte B com validações de FK condicionais, validação de parâmetro tributário, filtros e autorização CONTADOR
- 2026-01-08: 20 testes de integração adicionados cobrindo todos cenários (criação com 3 tipos de relacionamento, validações condicionais de FK, validação de parâmetro tributário, listagem com filtros, edição, toggle status)
