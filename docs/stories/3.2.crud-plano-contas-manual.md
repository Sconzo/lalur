# Story 3.2: CRUD de Plano de Contas (Manual)

## Status

**Ready for Review** - Implementação completa com testes de integração passando

---

**Como** CONTADOR,
**Eu quero** criar, listar, visualizar, editar e inativar contas contábeis manualmente com todos campos ECF-specific,
**Para que** eu possa cadastrar o plano de contas vinculando cada conta a uma Conta Referencial RFB oficial.

## Acceptance Criteria

Ver Epic 3 Story 3.2 para critérios completos. Principais pontos:

1. **Controller** `ChartOfAccountController` com endpoints CRUD completo
2. **DTOs** com campos ECF: contaReferencialId, classe, nivel, natureza, afetaResultado, dedutivel
3. **Use cases** com validação de contaReferencialId EXISTS e ACTIVE
4. **Listagem** com filtros por classe, natureza
5. **Validação**: nivel entre 1-5, contaReferencialId obrigatório

## Tasks / Subtasks

- [x] **Task 1: Criar DTOs** (AC: 2, 3, 4, 9, 10)
  - [x] CreateChartOfAccountRequest (10 campos ECF)
  - [x] UpdateChartOfAccountRequest (8 campos - exceto code, fiscalYear)
  - [x] ChartOfAccountResponse (15 campos + contaReferencialCodigo)
  - [x] ToggleStatusRequest
  - [x] ToggleStatusResponse

- [x] **Task 2: Criar Use Cases Port IN** (AC: 5)
  - [x] CreateChartOfAccountUseCase
  - [x] ListChartOfAccountsUseCase (com filtros)
  - [x] GetChartOfAccountUseCase
  - [x] UpdateChartOfAccountUseCase
  - [x] ToggleChartOfAccountStatusUseCase

- [x] **Task 3: Criar Service com validações** (AC: 5, 6, 8)
  - [x] ChartOfAccountService (implementa 5 Use Cases)
  - [x] Validação: code não vazio
  - [x] Validação: fiscalYear entre 2000 e ano atual + 1
  - [x] Validação: contaReferencialId existe e ACTIVE
  - [x] Validação: nivel entre 1-5
  - [x] Validação: unicidade (company + code + fiscalYear)
  - [x] Contexto de empresa obrigatório (CompanyContext)

- [x] **Task 4: Criar Controller REST** (AC: 1, 7, 8)
  - [x] POST /api/v1/chart-of-accounts (CONTADOR)
  - [x] GET /api/v1/chart-of-accounts (listagem com filtros)
  - [x] GET /api/v1/chart-of-accounts/{id}
  - [x] PUT /api/v1/chart-of-accounts/{id}
  - [x] PATCH /api/v1/chart-of-accounts/{id}/status

- [x] **Task 5: Criar DTOMapper**
  - [x] ChartOfAccountDtoMapper

- [x] **Task 6: Criar testes de integração** (AC: 11)
  - [x] 12 cenários de teste implementados e passando

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log
- Checkstyle fixes: ordem de imports e linhas longas (>100 chars)

### Completion Notes
- ✅ 5 DTOs criados com validações Jakarta Bean Validation
- ✅ 5 Use Cases Port IN criados
- ✅ Service implementado com todas validações ECF
- ✅ Controller REST com 5 endpoints protegidos (CONTADOR)
- ✅ DTOMapper criado
- ✅ Compilação bem-sucedida (0 erros, 0 violações checkstyle)
- ✅ 12 testes de integração criados cobrindo todos cenários de AC 11
- ✅ Todos os 21 testes passando (Tests run: 21, Failures: 0, Errors: 0)

### File List
**Criados:**
- `src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/CreateChartOfAccountRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/UpdateChartOfAccountRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/ChartOfAccountResponse.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/ToggleStatusRequest.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/chartofaccount/ToggleStatusResponse.java`
- `src/main/java/br/com/lalurecf/application/port/in/chartofaccount/CreateChartOfAccountUseCase.java`
- `src/main/java/br/com/lalurecf/application/port/in/chartofaccount/ListChartOfAccountsUseCase.java`
- `src/main/java/br/com/lalurecf/application/port/in/chartofaccount/GetChartOfAccountUseCase.java`
- `src/main/java/br/com/lalurecf/application/port/in/chartofaccount/UpdateChartOfAccountUseCase.java`
- `src/main/java/br/com/lalurecf/application/port/in/chartofaccount/ToggleChartOfAccountStatusUseCase.java`
- `src/main/java/br/com/lalurecf/application/service/ChartOfAccountService.java`
- `src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/ChartOfAccountController.java`
- `src/main/java/br/com/lalurecf/infrastructure/dto/mapper/ChartOfAccountDtoMapper.java`

**Testes:**
- `src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/ChartOfAccountControllerTest.java` (21 testes, 12 novos cenários)

### Change Log
- 2026-01-09: Testes de integração implementados e validados
  - 12 cenários de teste criados conforme AC 11
  - Correções no ChartOfAccountService:
    * Alterado ResourceNotFoundException para IllegalArgumentException quando ContaReferencial não existe (retorna 400 em vez de 404)
  - Correções nos testes:
    * Adicionado corpo de requisição com status nos endpoints de toggle (PATCH /status)
    * Corrigido CNPJ inválido no teste de row-level security
  - Todos os 21 testes passando com sucesso
  - Story 3.2 concluída e pronta para revisão
- 2026-01-07: Implementação backend completa do CRUD de Plano de Contas
  - 5 DTOs com campos ECF-specific
  - 5 Use Cases Port IN
  - Service com validações completas (company context, contaReferencial ACTIVE, unicidade, fiscal year, nivel)
  - Controller REST com 5 endpoints (POST, GET list, GET by ID, PUT, PATCH status)
  - Compilação e checkstyle validados (0 erros, 0 violações)

---

## Definition of Done

- [x] Controller criado
- [x] DTOs com campos ECF
- [x] Use cases + validações
- [x] Testes passando (21 testes, 0 falhas, 0 erros)
- [ ] Merge em develop

**Referência detalhada**: docs/epics/epic-03-plano-contas-dados-contabeis.md - Story 3.2
