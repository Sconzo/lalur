# Story 3.2: CRUD de Plano de Contas (Manual)

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** criar, listar, visualizar, editar e inativar contas contábeis manualmente,
**so that** eu possa cadastrar o plano de contas de uma empresa quando não tenho arquivo para importar.

---

## Acceptance Criteria

1. Controller `ChartOfAccountController` criado com endpoints:
   - `POST /api/v1/chart-of-accounts` - criar conta (CONTADOR com header X-Company-Id)
   - `GET /api/v1/chart-of-accounts` - listar contas com paginação (CONTADOR com header)
   - `GET /api/v1/chart-of-accounts/{id}` - visualizar conta (CONTADOR com header)
   - `PUT /api/v1/chart-of-accounts/{id}` - editar conta (CONTADOR com header)
   - `PATCH /api/v1/chart-of-accounts/{id}/status` - alternar status da conta (ativar/inativar, CONTADOR com header)

2. DTOs criados: `CreateChartOfAccountRequest`, `UpdateChartOfAccountRequest`, `ChartOfAccountResponse`

3. `CreateChartOfAccountRequest`:
   - `accountCode` (obrigatório)
   - `accountName` (obrigatório)
   - `fiscalYear` (obrigatório, inteiro, ex: 2024)
   - `accountType` (obrigatório, enum)
   - `openingBalance` (opcional, BigDecimal)

4. `ChartOfAccountResponse`:
   - `id`, `accountCode`, `accountName`, `fiscalYear`, `accountType`, `openingBalance`, `status`, `createdAt`, `updatedAt`

5. Use cases implementados:
   - `CreateChartOfAccountUseCase`: valida company via `CompanyContext`, verifica unicidade (company + code + year), salva
   - `ListChartOfAccountsUseCase`: retorna contas da empresa no contexto
   - `GetChartOfAccountUseCase`: retorna conta por ID (validando que pertence à empresa do contexto)
   - `UpdateChartOfAccountUseCase`: permite editar (exceto accountCode e fiscalYear)
   - `ToggleChartOfAccountStatusUseCase`: alterna status entre ACTIVE e INACTIVE

6. Validações no `CreateChartOfAccountUseCase`:
   - Account code não pode ser vazio ou conter apenas espaços
   - Fiscal year deve ser >= 2000 e <= ano atual + 1
   - Combinação (company + accountCode + fiscalYear) deve ser única

7. Listagem suporta:
   - Paginação: `?page=0&size=100&sort=accountCode,asc`
   - Filtro por ano: `?fiscalYear=2024`
   - Filtro por tipo: `?accountType=ATIVO`
   - Busca: `?search=Caixa` (busca em accountCode e accountName)
   - Filtro por status: `?include_inactive=true` (padrão: apenas ACTIVE)

8. Contexto de empresa obrigatório:
   - CONTADOR deve enviar header `X-Company-Id`
   - Endpoints retornam apenas contas da empresa selecionada
   - ADMIN pode usar header ou passar `?companyId={id}` como query param

9. DTO adicional `ToggleStatusRequest`:
   - `status` (obrigatório, enum: ACTIVE ou INACTIVE)

10. DTO `ToggleStatusResponse`:
    - `success` (boolean), `message`, `newStatus`

11. Teste valida:
    - CONTADOR consegue criar conta no contexto da empresa selecionada
    - Código duplicado para mesma empresa/ano retorna 400 Bad Request
    - CONTADOR sem header X-Company-Id recebe 400
    - Listagem retorna apenas contas da empresa no contexto
    - Edição não permite mudar accountCode ou fiscalYear
    - Toggle status: ACTIVE → INACTIVE funciona
    - Toggle status: INACTIVE → ACTIVE funciona
    - Listagem com include_inactive=true retorna contas inativas

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3, 4, 9, 10)
  - [ ] CreateChartOfAccountRequest
  - [ ] UpdateChartOfAccountRequest
  - [ ] ChartOfAccountResponse
  - [ ] ToggleStatusRequest (se não existir)
  - [ ] ToggleStatusResponse (se não existir)

- [ ] Criar use cases (AC: 5)
  - [ ] CreateChartOfAccountUseCase com validações (AC: 6)
  - [ ] ListChartOfAccountsUseCase com filtros (AC: 7)
  - [ ] GetChartOfAccountUseCase
  - [ ] UpdateChartOfAccountUseCase (não permite editar accountCode/fiscalYear)
  - [ ] ToggleChartOfAccountStatusUseCase

- [ ] Criar controller (AC: 1)
  - [ ] POST /api/v1/chart-of-accounts
  - [ ] GET /api/v1/chart-of-accounts (paginação + filtros)
  - [ ] GET /api/v1/chart-of-accounts/{id}
  - [ ] PUT /api/v1/chart-of-accounts/{id}
  - [ ] PATCH /api/v1/chart-of-accounts/{id}/status

- [ ] Implementar contexto de empresa (AC: 8)
  - [ ] Validar header X-Company-Id
  - [ ] CompanyContext para CONTADOR
  - [ ] Query param companyId para ADMIN

- [ ] Criar testes de integração (AC: 11)
  - [ ] Teste: CONTADOR cria conta com sucesso
  - [ ] Teste: código duplicado retorna 400
  - [ ] Teste: CONTADOR sem header recebe 400
  - [ ] Teste: listagem filtra por empresa
  - [ ] Teste: edição não permite mudar accountCode/fiscalYear
  - [ ] Teste: toggle status ACTIVE → INACTIVE
  - [ ] Teste: toggle status INACTIVE → ACTIVE
  - [ ] Teste: listagem com include_inactive=true

---

## Dev Notes

### Endpoints REST

**POST /api/v1/chart-of-accounts**
```json
{
  "accountCode": "1.1.01.001",
  "accountName": "Caixa",
  "fiscalYear": 2024,
  "accountType": "ATIVO",
  "openingBalance": 5000.00
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "accountCode": "1.1.01.001",
  "accountName": "Caixa",
  "fiscalYear": 2024,
  "accountType": "ATIVO",
  "openingBalance": 5000.00,
  "status": "ACTIVE",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

**GET /api/v1/chart-of-accounts?fiscalYear=2024&accountType=ATIVO&page=0&size=20**
```json
{
  "content": [
    {
      "id": 1,
      "accountCode": "1.1.01.001",
      "accountName": "Caixa",
      "fiscalYear": 2024,
      "accountType": "ATIVO",
      "openingBalance": 5000.00,
      "status": "ACTIVE"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

### Validações de Negócio

- **accountCode**: não vazio, sem apenas espaços
- **fiscalYear**: >= 2000 e <= (ano atual + 1)
- **Unicidade**: (company_id + accountCode + fiscalYear) deve ser única
- **Contexto**: CONTADOR precisa de header X-Company-Id

### Filtros Suportados

- `?fiscalYear=2024` - filtrar por ano fiscal
- `?accountType=ATIVO` - filtrar por tipo de conta
- `?search=Caixa` - buscar em accountCode e accountName
- `?include_inactive=true` - incluir contas inativas
- `?page=0&size=100&sort=accountCode,asc` - paginação e ordenação

### Segurança

- **CONTADOR**: requer header `X-Company-Id`, acessa apenas contas da empresa selecionada
- **ADMIN**: pode usar header ou query param `?companyId={id}`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
