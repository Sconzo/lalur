# Story 3.14: Testes de Integração End-to-End do Epic 3

## Status

**Draft** (2025-12-27)

---

## Story

**As a** desenvolvedor,
**I want** testes de integração que validem fluxos completos do Epic 3,
**so that** tenhamos confiança de que todas funcionalidades de plano de contas e dados contábeis fiscais estão integradas.

---

## Acceptance Criteria

1. **Teste de integração: Fluxo completo - Importação Plano de Contas**
   - CONTADOR seleciona empresa
   - Importa plano de contas via CSV (100 contas)
   - Valida que todas 100 contas foram criadas
   - Tenta reimportar mesmo arquivo → contas duplicadas são ignoradas

2. **Teste de integração: Fluxo completo - Conta da Parte B**
   - CONTADOR cria empresa
   - Cria manualmente 5 Contas da Parte B
   - Lista todas contas → deve retornar 5 registros
   - Edita descrição de 1 conta
   - Valida que edição foi persistida
   - Inativa 1 conta
   - Lista sem include_inactive → deve retornar 4 registros
   - Lista com include_inactive=true → deve retornar 5 registros

3. **Teste de integração: Fluxo completo - Código de Enquadramento LALUR**
   - CONTADOR cria empresa
   - Cria manualmente 3 Códigos de Enquadramento
   - Valida que 3 registros foram criados
   - Edita histórico de 1 código
   - Valida que edição foi persistida
   - Toggle status de 1 código para INACTIVE
   - Lista sem include_inactive → deve retornar 2 registros

4. **Teste de integração: Fluxo completo - Linha de Lucro Presumido**
   - CONTADOR cria empresa
   - Importa plano de contas (100 contas)
   - Cria manualmente 3 linhas de lucro presumido, cada uma com contas associadas
   - Valida que 3 linhas foram criadas
   - Valida que ordem das contas em cada linha está correta
   - Edita linha 1: adiciona 2 novas contas
   - Valida que linha 1 agora tem contas adicionais
   - Lista linhas → deve retornar 3 registros com contas associadas

5. **Teste de integração: Fluxo completo - Dados Contábeis Genéricos**
   - CONTADOR cria empresa com Período Contábil = 2024-01-01
   - Importa plano de contas (50 contas)
   - Importa dados contábeis genéricos (500 lançamentos, competência 2024-01 a 2024-12)
   - Valida que 500 lançamentos foram criados
   - Exporta dados contábeis → arquivo gerado deve ter 500 linhas + header
   - Round-trip: reimporta arquivo exportado → deve funcionar sem erros

6. **Teste de integração: Validação de Período Contábil (Dados Genéricos)**
   - Empresa com Período Contábil = 2024-06-01
   - Importa plano de contas
   - Importa dados contábeis com competências mistas (2024-05, 2024-06, 2024-07)
   - Validar que lançamentos de 2024-05 foram rejeitados
   - Validar que lançamentos de 2024-06 e 2024-07 foram aceitos
   - Tentar editar lançamento de 2024-06 → deve falhar (400)
   - ADMIN atualiza Período Contábil para 2024-05-01
   - Tentar editar lançamento de 2024-06 novamente → deve funcionar

7. **Teste de integração: Dry Run de Importações**
   - CONTADOR chama importação de plano de contas com dryRun=true
   - Valida que preview é retornado
   - Valida que nenhuma conta foi persistida no banco
   - Chama importação sem dryRun
   - Valida que contas foram persistidas
   - CONTADOR chama importação de dados contábeis genéricos com dryRun=true
   - Valida preview e ausência de persistência

8. **Teste de integração: Erros de Importação**
   - Importa plano de contas com accountType inválido
   - Valida que relatório de erros é retornado
   - Valida que linhas válidas foram processadas
   - Importa dados contábeis genéricos com accountCode inexistente
   - Valida que erro específico é registrado para cada linha problemática

9. **Teste de integração: Contexto de Empresa**
   - ADMIN cria empresa1 e empresa2
   - CONTADOR seleciona empresa1
   - Importa Plano de Contas e Dados Genéricos para empresa1
   - Cria Conta da Parte B, Código de Enquadramento e Linha de Lucro Presumido para empresa1
   - CONTADOR seleciona empresa2
   - Lista todos cadastros → deve retornar vazio (empresa2 não tem dados)
   - Importa e cria mesmos dados para empresa2
   - Lista cadastros → deve retornar apenas dados da empresa2

10. **Teste de integração: Validação de Relacionamento Linha-Conta**
    - CONTADOR cria empresa
    - Importa plano de contas
    - Tenta criar linha de lucro presumido com chartOfAccountId de outra empresa → deve retornar 400
    - Tenta criar linha com chartOfAccountId inexistente → deve retornar 400
    - Cria linha válida com 5 contas
    - Inativa 1 conta do plano de contas
    - Busca linha → linha ainda contém referência à conta inativa (não há cascade de inativação)

11. Todos testes usam TestContainers com PostgreSQL real

12. Todos testes limpam dados após execução

---

## Tasks / Subtasks

- [ ] Configurar TestContainers (AC: 11)
  - [ ] Verificar IntegrationTestBase
  - [ ] PostgreSQL 15.5

- [ ] Criar teste: Importação Plano de Contas (AC: 1)
  - [ ] Importar 100 contas
  - [ ] Validar criação
  - [ ] Reimportar (duplicatas)

- [ ] Criar teste: Conta da Parte B (AC: 2)
  - [ ] Criar 5 contas
  - [ ] Editar descrição
  - [ ] Inativar conta
  - [ ] Listar com/sem include_inactive

- [ ] Criar teste: Código de Enquadramento LALUR (AC: 3)
  - [ ] Criar 3 códigos
  - [ ] Editar histórico
  - [ ] Toggle status

- [ ] Criar teste: Linha de Lucro Presumido (AC: 4)
  - [ ] Criar 3 linhas com contas
  - [ ] Validar ordem das contas
  - [ ] Editar linha (adicionar contas)

- [ ] Criar teste: Dados Contábeis Genéricos (AC: 5)
  - [ ] Importar 500 lançamentos
  - [ ] Exportar para CSV
  - [ ] Round-trip (reimportar)

- [ ] Criar teste: Período Contábil (AC: 6)
  - [ ] Importar com competências mistas
  - [ ] Validar rejeição de datas antigas
  - [ ] Tentar editar dado antigo
  - [ ] Atualizar período e retentar

- [ ] Criar teste: Dry Run (AC: 7)
  - [ ] Dry run de plano de contas
  - [ ] Dry run de dados contábeis

- [ ] Criar teste: Erros de Importação (AC: 8)
  - [ ] accountType inválido
  - [ ] accountCode inexistente

- [ ] Criar teste: Contexto de Empresa (AC: 9)
  - [ ] Importar para empresa1
  - [ ] Selecionar empresa2
  - [ ] Validar isolamento

- [ ] Criar teste: Relacionamento Linha-Conta (AC: 10)
  - [ ] Conta de outra empresa → 400
  - [ ] Conta inexistente → 400
  - [ ] Inativar conta não afeta linha

---

## Dev Notes

### Estrutura dos Testes

```
src/test/java/br/com/lalurecf/integration/
├── Epic03E2ETest.java (testes agregados)
├── ChartOfAccountImportIntegrationTest.java (AC: 1)
├── ContaDaParteBWorkflowIntegrationTest.java (AC: 2)
├── CodigoEnquadramentoLalurWorkflowIntegrationTest.java (AC: 3)
├── LinhaLucroPresumidoWorkflowIntegrationTest.java (AC: 4)
├── AccountingDataWorkflowIntegrationTest.java (AC: 5)
├── PeriodoContabilAccountingDataIntegrationTest.java (AC: 6)
├── DryRunImportIntegrationTest.java (AC: 7)
├── ImportErrorHandlingIntegrationTest.java (AC: 8)
├── CompanyContextIsolationIntegrationTest.java (AC: 9)
└── LinhaContaRelationshipIntegrationTest.java (AC: 10)
```

### Exemplo de Teste E2E

**Epic03E2ETest.java:**
```java
@DisplayName("Epic 03 - Testes E2E")
@AutoConfigureMockMvc
class Epic03E2ETest extends IntegrationTestBase {

    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private JwtTokenProvider jwtTokenProvider;

    private String contadorToken;

    @BeforeEach
    void setUp() {
        contadorToken = jwtTokenProvider.generateAccessToken(
            "contador@example.com",
            UserRole.CONTADOR
        );
    }

    @Test
    @DisplayName("E2E: Importação completa de Plano de Contas")
    void shouldImportChartOfAccountsCompletely() throws Exception {
        // Criar CSV com 100 contas
        String csv = generateChartOfAccountsCsv(100);
        MockMultipartFile file = new MockMultipartFile(
            "file",
            "chart-of-accounts.csv",
            "text/csv",
            csv.getBytes(StandardCharsets.UTF_8)
        );

        // Importar
        mockMvc.perform(multipart("/api/v1/chart-of-accounts/import")
                .file(file)
                .header("Authorization", "Bearer " + contadorToken)
                .header("X-Company-Id", companyId)
                .param("fiscalYear", "2024"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.processedLines", equalTo(100)))
            .andExpect(jsonPath("$.skippedLines", equalTo(0)));

        // Validar que foram criadas
        mockMvc.perform(get("/api/v1/chart-of-accounts")
                .header("Authorization", "Bearer " + contadorToken)
                .header("X-Company-Id", companyId)
                .param("fiscalYear", "2024")
                .param("size", "200"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.totalElements", equalTo(100)));

        // Reimportar (duplicatas devem ser ignoradas)
        mockMvc.perform(multipart("/api/v1/chart-of-accounts/import")
                .file(file)
                .header("Authorization", "Bearer " + contadorToken)
                .header("X-Company-Id", companyId)
                .param("fiscalYear", "2024"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.skippedLines", equalTo(100)));
    }

    private String generateChartOfAccountsCsv(int count) {
        StringBuilder csv = new StringBuilder();
        csv.append("accountCode;accountName;accountType;openingBalance\n");
        for (int i = 1; i <= count; i++) {
            csv.append(String.format("1.1.%02d.%03d;Conta %d;ATIVO;1000.00\n", i / 100, i % 100, i));
        }
        return csv.toString();
    }
}
```

### Coverage Target

- **Epic 3**: ≥75% coverage
- **Fluxos críticos**: 100% cobertos

### Padrões de Código

- **Nomenclatura**: `shouldDoSomethingWhenCondition()`
- **AAA Pattern**: Arrange-Act-Assert
- **Assertions**: AssertJ

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
