# Story 3.12: Exportação de Lançamentos Contábeis para CSV

**Como** CONTADOR,
**Eu quero** exportar lançamentos contábeis para arquivo CSV,
**Para que** eu possa fazer backup, análises externas ou compartilhar com outros sistemas.

## Acceptance Criteria

Ver Epic 3 Story 3.12 para critérios completos. Principais pontos:

1. **Endpoint** `GET /api/v1/lancamento-contabil/export`
2. **Query params**: `fiscalYear` (obrigatório), `dataInicio` e `dataFim` (opcionais, para filtro de range)
3. **Formato CSV**: Separador `;`, encoding UTF-8, ordenação por data ASC
4. **Header**: `contaDebitoCode;contaDebitoName;contaCreditoCode;contaCreditoName;data;valor;historico;numeroDocumento`
5. **Números**: formato `1000.00` (ponto decimal, 2 casas)
6. **Datas**: formato ISO 8601 (YYYY-MM-DD)
7. **Validações**:
   - fiscalYear obrigatório
   - Se dataInicio fornecido, dataFim também obrigatório
   - dataFim >= dataInicio
8. **Response**: 200 OK com arquivo CSV, 400 Bad Request se validações falharem, 404 Not Found se nenhum lançamento encontrado

## Definition of Done

- [x] Endpoint GET /api/v1/lancamento-contabil/export implementado
- [x] Use case port criado
- [x] Service com geração CSV e filtros
- [x] Header Content-Disposition configurado
- [x] Validações de range de data
- [x] Formato de números com ponto decimal (Locale.US)
- [x] Testes passando (13/13 - 8 importação + 5 exportação)
- [ ] Code review
- [ ] Merge em develop

**Referência detalhada**: docs/epics/epic-03-plano-contas-dados-contabeis.md - Story 3.12

---

## Dev Agent Record

### Status
**Ready for Review** - Implementação completa de exportação CSV com filtros de data, formato padronizado e validações (13/13 testes passando)

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- Use case port `ExportLancamentoContabilUseCase` criado
- Service `ExportLancamentoContabilService` implementado com:
  * Busca de lançamentos por empresa e ano fiscal
  * Filtro opcional por range de data (dataInicio/dataFim)
  * Geração de CSV usando Apache Commons CSV
  * Ordenação por data ASC
  * Formato de números com Locale.US (ponto decimal)
  * Validações: dataInicio requer dataFim, dataFim >= dataInicio
- Controller `LancamentoContabilController` atualizado com endpoint GET /export
  * Header Content-Disposition: `attachment; filename="lancamentos-contabeis-{companyId}-{fiscalYear}.csv"`
  * Content-Type: `text/csv; charset=UTF-8`
- Domain model `LancamentoContabil` atualizado:
  * Adicionados campos: contaDebitoCode, contaDebitoName, contaCreditoCode, contaCreditoName
- Mapper `LancamentoContabilMapper` atualizado:
  * Mapeamento de códigos e nomes das contas para facilitar exportação
- 5 testes de integração adicionados cobrindo:
  * Exportação bem-sucedida com conteúdo CSV correto
  * Filtro por range de data funciona
  * Erro 400 quando dataInicio sem dataFim
  * Erro 400 quando dataFim < dataInicio
  * Erro 404 quando nenhum lançamento encontrado
- Build e testes executaram com sucesso (13/13 passando - 8 importação + 5 exportação)

### File List

**Use case port:**
- src/main/java/br/com/lalurecf/application/port/in/ExportLancamentoContabilUseCase.java

**Service:**
- src/main/java/br/com/lalurecf/application/service/ExportLancamentoContabilService.java

**Controller (atualizado):**
- src/main/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoContabilController.java

**Domain model (atualizado):**
- src/main/java/br/com/lalurecf/domain/model/LancamentoContabil.java

**Mapper (atualizado):**
- src/main/java/br/com/lalurecf/infrastructure/adapter/out/persistence/mapper/LancamentoContabilMapper.java

**Testes (atualizado):**
- src/test/java/br/com/lalurecf/infrastructure/adapter/in/rest/LancamentoContabilControllerTest.java

### Change Log
- 2026-01-08: Story 3.12 implementada - Exportação de Lançamentos Contábeis para CSV com filtros de data, formato padronizado com ponto decimal e 5 novos testes de integração (total: 13/13 passando)
