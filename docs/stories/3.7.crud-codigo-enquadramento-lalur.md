# Story 3.7: CRUD de Código de Enquadramento LALUR (Manual)

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** criar, listar, visualizar, editar e inativar Códigos de Enquadramento LALUR manualmente,
**so that** eu possa cadastrar os códigos de enquadramento fiscal de uma empresa.

---

## Acceptance Criteria

1. Controller `CodigoEnquadramentoLalurController` criado com endpoints:
   - `POST /api/v1/codigo-enquadramento-lalur` - criar código (CONTADOR com header X-Company-Id)
   - `GET /api/v1/codigo-enquadramento-lalur` - listar códigos com paginação (CONTADOR com header)
   - `GET /api/v1/codigo-enquadramento-lalur/{id}` - visualizar código (CONTADOR com header)
   - `PUT /api/v1/codigo-enquadramento-lalur/{id}` - editar código (CONTADOR com header)
   - `PATCH /api/v1/codigo-enquadramento-lalur/{id}/status` - alternar status (ativar/inativar, CONTADOR com header)

2. DTOs criados: `CreateCodigoEnquadramentoLalurRequest`, `UpdateCodigoEnquadramentoLalurRequest`, `CodigoEnquadramentoLalurResponse`

3. `CreateCodigoEnquadramentoLalurRequest`:
   - `codigoDeEnquadramento` (obrigatório, String)
   - `historico` (obrigatório, String, max 2000 chars)
   - `fiscalYear` (obrigatório, Integer)

4. `CodigoEnquadramentoLalurResponse`:
   - `id`, `codigoDeEnquadramento`, `historico`, `fiscalYear`, `status`, `createdAt`, `updatedAt`

5. Use cases implementados:
   - `CreateCodigoEnquadramentoLalurUseCase`: valida company via `CompanyContext`, verifica unicidade, salva
   - `ListCodigoEnquadramentoLalurUseCase`: retorna códigos da empresa no contexto
   - `GetCodigoEnquadramentoLalurUseCase`: retorna código por ID
   - `UpdateCodigoEnquadramentoLalurUseCase`: permite editar (exceto codigoDeEnquadramento e fiscalYear)
   - `ToggleCodigoEnquadramentoLalurStatusUseCase`: alterna status entre ACTIVE e INACTIVE

6. Validações:
   - codigoDeEnquadramento não pode ser vazio ou conter apenas espaços
   - historico não pode ser vazio
   - fiscalYear deve ser >= 2000 e <= ano atual + 1
   - Combinação (company + codigoDeEnquadramento + fiscalYear) deve ser única

7. Listagem suporta:
   - Paginação: `?page=0&size=100&sort=codigoDeEnquadramento,asc`
   - Filtro por ano: `?fiscalYear=2024`
   - Busca: `?search=texto` (busca em codigoDeEnquadramento e historico)
   - Filtro por status: `?include_inactive=true` (padrão: apenas ACTIVE)

8. DTOs adicionais: `ToggleStatusRequest`, `ToggleStatusResponse` (reutilizados)

9. Teste valida:
   - CONTADOR consegue criar código de enquadramento
   - Código duplicado para mesma empresa/ano retorna 400
   - CONTADOR sem header X-Company-Id recebe 400
   - Edição não permite mudar codigoDeEnquadramento ou fiscalYear
   - Toggle status funciona corretamente
   - Listagem com filtros funciona

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3, 4, 8)
  - [ ] CreateCodigoEnquadramentoLalurRequest
  - [ ] UpdateCodigoEnquadramentoLalurRequest
  - [ ] CodigoEnquadramentoLalurResponse

- [ ] Criar use cases (AC: 5, 6)
  - [ ] CreateCodigoEnquadramentoLalurUseCase
  - [ ] ListCodigoEnquadramentoLalurUseCase
  - [ ] GetCodigoEnquadramentoLalurUseCase
  - [ ] UpdateCodigoEnquadramentoLalurUseCase
  - [ ] ToggleCodigoEnquadramentoLalurStatusUseCase

- [ ] Criar controller (AC: 1)
  - [ ] Implementar todos endpoints
  - [ ] Validar header X-Company-Id

- [ ] Criar testes de integração (AC: 9)
  - [ ] Teste: CONTADOR cria código
  - [ ] Teste: duplicata retorna 400
  - [ ] Teste: sem header recebe 400
  - [ ] Teste: edição não permite mudar campos chave
  - [ ] Teste: toggle status
  - [ ] Teste: listagem com filtros

---

## Dev Notes

### Endpoints REST

**POST /api/v1/codigo-enquadramento-lalur**
```json
{
  "codigoDeEnquadramento": "E-001",
  "historico": "Lucro da Exploração - Lucro presumido ou arbitrado no regime de caixa",
  "fiscalYear": 2024
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "codigoDeEnquadramento": "E-001",
  "historico": "Lucro da Exploração - Lucro presumido ou arbitrado no regime de caixa",
  "fiscalYear": 2024,
  "status": "ACTIVE",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

### Validações de Negócio

- **codigoDeEnquadramento**: não vazio, sem apenas espaços
- **historico**: não vazio, max 2000 chars
- **fiscalYear**: >= 2000 e <= (ano atual + 1)
- **Unicidade**: (company_id + codigoDeEnquadramento + fiscalYear)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
