# Story 2.5: Período Contábil e Bloqueio Temporal

## Status

**Draft**

---

## Story

**As a** ADMIN,
**I want** definir e editar o Período Contábil de uma empresa,
**so that** dados com competência anterior ao Período Contábil fiquem bloqueados para edição.

---

## Acceptance Criteria

1. Endpoint `PUT /api/v1/companies/{id}/periodo-contabil` criado (ADMIN only):
   - DTO `UpdatePeriodoContabilRequest`: `novoPeriodoContabil` (obrigatório, formato ISO 8601)
   - DTO `UpdatePeriodoContabilResponse`: `success`, `message`, `periodoContabilAnterior`, `periodoContabilNovo`

2. Use case `UpdatePeriodoContabilUseCase` implementado:
   - Valida que nova data não é no futuro
   - Valida que nova data é posterior à data atual (não pode retroagir)
   - Registra alteração em log de auditoria dedicado
   - Atualiza campo `periodoContabil` da empresa

3. Entidade de auditoria `PeriodoContabilAuditEntity` criada:
   - `companyId`, `periodoContabilAnterior`, `periodoContabilNovo`, `changedBy` (email), `changedAt` (timestamp)
   - Não extends BaseEntity (não tem soft delete)

4. Repository `PeriodoContabilAuditRepository` criado para persistir logs

5. Endpoint `GET /api/v1/companies/{id}/periodo-contabil/audit` lista histórico de alterações (ADMIN only)

6. Implementação do bloqueio temporal:
   - Interface `TemporalEntity` criada com método `LocalDate getCompetencia()`
   - Entidades com competência implementam `TemporalEntity`
   - Annotation customizada `@EnforcePeriodoContabil` criada
   - Aspect `PeriodoContabilAspect` intercepta operações de update/delete:
     - Verifica se entidade implementa `TemporalEntity`
     - Compara `entity.getCompetencia()` com `company.getPeriodoContabil()`
     - Se `competencia < periodoContabil`, lança `PeriodoContabilViolationException`

7. Exception `PeriodoContabilViolationException` criada:
   - Mensagem: "Não é possível editar dados com competência anterior ao Período Contábil ({data})"
   - HTTP 400 Bad Request

8. Validação em endpoints de edição:
   - Endpoints que editam dados com competência chamam validação antes de salvar
   - Operações de leitura sempre permitidas (modo read-only)

9. Teste valida:
   - ADMIN consegue atualizar Período Contábil
   - CONTADOR recebe 403 ao tentar atualizar Período Contábil
   - Nova data não pode ser no futuro (400)
   - Nova data não pode retroagir (400)
   - Histórico de alterações é registrado corretamente
   - Tentativa de editar dado com competência < Período Contábil retorna 400
   - Leitura de dados antigos sempre permitida

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 1)
  - [ ] Criar `UpdatePeriodoContabilRequest`
  - [ ] Criar `UpdatePeriodoContabilResponse`

- [ ] Criar entidade de auditoria (AC: 3, 4)
  - [ ] Criar `PeriodoContabilAuditEntity` (sem BaseEntity)
  - [ ] Criar `PeriodoContabilAuditRepository`
  - [ ] Adicionar campos de auditoria

- [ ] Criar Use Case (AC: 2)
  - [ ] Implementar `UpdatePeriodoContabilUseCase`
  - [ ] Validar data não é futuro
  - [ ] Validar data não retroage
  - [ ] Registrar em auditoria
  - [ ] Atualizar empresa

- [ ] Criar endpoints (AC: 1, 5)
  - [ ] Criar `PUT /api/v1/companies/{id}/periodo-contabil`
  - [ ] Criar `GET /api/v1/companies/{id}/periodo-contabil/audit`
  - [ ] Adicionar `@PreAuthorize("hasRole('ADMIN')")`

- [ ] Implementar bloqueio temporal (AC: 6, 7)
  - [ ] Criar interface `TemporalEntity`
  - [ ] Criar annotation `@EnforcePeriodoContabil`
  - [ ] Criar aspect `PeriodoContabilAspect`
  - [ ] Implementar lógica de validação no aspect
  - [ ] Criar exception `PeriodoContabilViolationException`

- [ ] Integrar validação em endpoints (AC: 8)
  - [ ] Documentar pattern para endpoints futuros
  - [ ] (Implementação real será nas stories de movimentos fiscais)

- [ ] Criar testes (AC: 9)
  - [ ] Testar atualização de período (ADMIN)
  - [ ] Testar CONTADOR recebe 403
  - [ ] Testar validação de data futura
  - [ ] Testar validação de retroação
  - [ ] Testar registro de auditoria
  - [ ] Testar bloqueio de edição
  - [ ] Testar leitura sempre permitida

---

## Dev Notes

### Auditoria de Período Contábil
**Separada de BaseEntity:**
- Não tem soft delete (log permanente)
- Registra `changedBy` (email do usuário logado)
- Registra `changedAt` (timestamp da alteração)

### Spring AOP para Bloqueio Temporal
**Pattern usando Aspect:**
```java
@Aspect
@Component
public class PeriodoContabilAspect {

    @Around("@annotation(EnforcePeriodoContabil)")
    public Object enforce(ProceedingJoinPoint joinPoint) throws Throwable {
        Object entity = joinPoint.getArgs()[0];

        if (entity instanceof TemporalEntity) {
            LocalDate competencia = ((TemporalEntity) entity).getCompetencia();
            LocalDate periodoContabil = getCurrentCompanyPeriodoContabil();

            if (competencia.isBefore(periodoContabil)) {
                throw new PeriodoContabilViolationException(periodoContabil);
            }
        }

        return joinPoint.proceed();
    }
}
```

### TemporalEntity Interface
```java
public interface TemporalEntity {
    LocalDate getCompetencia();
}
```

### Source Tree
```
src/main/java/br/com/lalurecf/
├── domain/
│   ├── model/
│   │   └── TemporalEntity.java  # Interface
│   └── exception/
│       └── PeriodoContabilViolationException.java
├── application/
│   ├── port/
│   │   └── in/
│   │       └── company/
│   │           └── UpdatePeriodoContabilUseCase.java
│   └── service/
│       └── CompanyService.java  # Adicionar método
└── infrastructure/
    ├── adapter/
    │   ├── in/
    │   │   └── rest/
    │   │       └── CompanyController.java  # Adicionar endpoints
    │   └── out/
    │       └── persistence/
    │           ├── entity/
    │           │   └── PeriodoContabilAuditEntity.java
    │           └── repository/
    │               └── PeriodoContabilAuditJpaRepository.java
    ├── aspect/
    │   ├── EnforcePeriodoContabil.java  # Annotation
    │   └── PeriodoContabilAspect.java   # Aspect
    └── dto/
        └── company/
            ├── UpdatePeriodoContabilRequest.java
            └── UpdatePeriodoContabilResponse.java
```

### Validações de Negócio
1. **Data futura:** `periodoContabil.isAfter(LocalDate.now())` → 400
2. **Retroação:** `novoPeriodo.isBefore(periodoAtual)` → 400
3. **Edição bloqueada:** `competencia.isBefore(periodoContabil)` → 400

### Padrões de Código
- **AOP:** Usar Spring AOP para cross-cutting concern
- **Exceptions:** Domain exception traduzida para HTTP 400
- **Auditoria:** `SecurityContextHelper` para obter usuário logado

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
├── infrastructure/
│   ├── adapter/
│   │   └── in/
│   │       └── rest/
│   │           └── CompanyControllerTest.java
│   └── aspect/
│       └── PeriodoContabilAspectTest.java
```

#### Cenários Críticos
1. **Auditoria:** Validar que todas alterações são registradas
2. **Bloqueio:** Edição de competência antiga deve falhar
3. **Leitura:** Dados antigos sempre acessíveis (read-only)
4. **Usuário logado:** `changedBy` deve conter email correto

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante implementação*

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
*A ser preenchido durante implementação*

### File List
*A ser preenchido durante implementação*

---

## QA Results
*A ser preenchido após revisão de QA*
