# Story 3.13: CRUD de Dados Contábeis Genéricos (Manual)

## Status

**Draft** (2025-12-27)

---

## Story

**As a** CONTADOR,
**I want** criar, visualizar, editar e inativar dados contábeis genéricos manualmente,
**so that** eu possa fazer ajustes pontuais sem precisar reimportar arquivo completo.

---

## Acceptance Criteria

1. Controller `AccountingDataController` criado com endpoints:
   - `POST /api/v1/accounting-data` - criar dado contábil (CONTADOR com header)
   - `GET /api/v1/accounting-data` - listar dados com paginação (CONTADOR com header)
   - `GET /api/v1/accounting-data/{id}` - visualizar dado (CONTADOR com header)
   - `PUT /api/v1/accounting-data/{id}` - editar dado (CONTADOR com header)
   - `PATCH /api/v1/accounting-data/{id}/status` - alternar status do dado (ativar/inativar, CONTADOR com header)

2. DTOs criados: `CreateAccountingDataRequest`, `UpdateAccountingDataRequest`, `AccountingDataResponse`

3. `CreateAccountingDataRequest`:
   - `chartOfAccountId` (obrigatório)
   - `competencia` (obrigatório, LocalDate)
   - `debitAmount` (opcional, BigDecimal)
   - `creditAmount` (opcional, BigDecimal)
   - `balance` (opcional, BigDecimal)
   - `description` (opcional, String max 500 chars)

4. `AccountingDataResponse`:
   - `id`, `chartOfAccountId`, `accountCode`, `accountName`, `competencia`, `debitAmount`, `creditAmount`, `balance`, `description`, `status`, `createdAt`, `updatedAt`

5. Use cases implementados:
   - `CreateAccountingDataUseCase`: valida que chartOfAccount pertence à empresa do contexto, valida Período Contábil, salva
   - `ListAccountingDataUseCase`: retorna dados da empresa no contexto
   - `GetAccountingDataUseCase`: retorna dado por ID
   - `UpdateAccountingDataUseCase`: valida Período Contábil antes de permitir edição
   - `ToggleAccountingDataStatusUseCase`: alterna status entre ACTIVE e INACTIVE (também valida Período Contábil)

6. Validações:
   - chartOfAccountId deve existir e pertencer à empresa do contexto
   - competencia >= company.periodoContabil
   - debitAmount, creditAmount, balance >= 0 (se fornecidos)

7. Listagem suporta:
   - Paginação: `?page=0&size=100`
   - Filtro por conta: `?chartOfAccountId={id}`
   - Filtro por competência: `?competencia=2024-01-31`
   - Filtro por range: `?competenciaInicio=2024-01-01&competenciaFim=2024-12-31`
   - Ordenação: `?sort=competencia,desc`

8. Annotation `@EnforcePeriodoContabil` aplicada em UpdateAccountingDataUseCase e ToggleAccountingDataStatusUseCase

9. DTO adicional para toggle status: `ToggleStatusRequest` e `ToggleStatusResponse` (reutilizados)

10. Teste valida:
    - CONTADOR consegue criar dado contábil
    - Tentativa de criar com competência < Período Contábil retorna 400
    - Tentativa de editar dado antigo (competência < Período Contábil) retorna 400
    - Tentativa de inativar dado antigo (competência < Período Contábil) retorna 400
    - Toggle status: ACTIVE → INACTIVE funciona
    - Toggle status: INACTIVE → ACTIVE funciona
    - Listagem com filtros funciona corretamente

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 2, 3, 4, 9)
  - [ ] CreateAccountingDataRequest
  - [ ] UpdateAccountingDataRequest
  - [ ] AccountingDataResponse

- [ ] Criar use cases (AC: 5, 6, 8)
  - [ ] CreateAccountingDataUseCase com validação de Período Contábil
  - [ ] ListAccountingDataUseCase com filtros (AC: 7)
  - [ ] GetAccountingDataUseCase
  - [ ] UpdateAccountingDataUseCase com @EnforcePeriodoContabil
  - [ ] ToggleAccountingDataStatusUseCase com @EnforcePeriodoContabil

- [ ] Criar controller (AC: 1)
  - [ ] POST /api/v1/accounting-data
  - [ ] GET /api/v1/accounting-data (com filtros)
  - [ ] GET /api/v1/accounting-data/{id}
  - [ ] PUT /api/v1/accounting-data/{id}
  - [ ] PATCH /api/v1/accounting-data/{id}/status

- [ ] Criar testes de integração (AC: 10)
  - [ ] Teste: criar dado contábil
  - [ ] Teste: competência < Período Contábil retorna 400 (create)
  - [ ] Teste: editar dado antigo retorna 400
  - [ ] Teste: inativar dado antigo retorna 400
  - [ ] Teste: toggle status ACTIVE → INACTIVE
  - [ ] Teste: toggle status INACTIVE → ACTIVE
  - [ ] Teste: listagem com filtros

---

## Dev Notes

### Endpoints REST

**POST /api/v1/accounting-data**
```json
{
  "chartOfAccountId": 101,
  "competencia": "2024-01-31",
  "debitAmount": 1000.00,
  "creditAmount": 500.00,
  "balance": 5500.00,
  "description": "Lançamento Janeiro - Caixa"
}
```

**Response 201 Created:**
```json
{
  "id": 1,
  "chartOfAccountId": 101,
  "accountCode": "1.1.01.001",
  "accountName": "Caixa",
  "competencia": "2024-01-31",
  "debitAmount": 1000.00,
  "creditAmount": 500.00,
  "balance": 5500.00,
  "description": "Lançamento Janeiro - Caixa",
  "status": "ACTIVE",
  "createdAt": "2024-01-15T10:00:00Z",
  "updatedAt": "2024-01-15T10:00:00Z"
}
```

**GET /api/v1/accounting-data?chartOfAccountId=101&competenciaInicio=2024-01-01&competenciaFim=2024-12-31&page=0&size=20**
```json
{
  "content": [
    {
      "id": 1,
      "chartOfAccountId": 101,
      "accountCode": "1.1.01.001",
      "accountName": "Caixa",
      "competencia": "2024-01-31",
      "debitAmount": 1000.00,
      "creditAmount": 500.00,
      "balance": 5500.00,
      "description": "Lançamento Janeiro - Caixa",
      "status": "ACTIVE"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

### Validação de Período Contábil

**Exemplo de validação no CreateAccountingDataUseCase:**
```java
@Service
public class CreateAccountingDataUseCase {

    public AccountingDataResponse execute(CreateAccountingDataRequest request, Long companyId) {
        // Buscar empresa
        Company company = companyRepository.findById(companyId)
            .orElseThrow(() -> new NotFoundException("Company not found"));

        // Validar chartOfAccount pertence à empresa
        ChartOfAccount account = chartOfAccountRepository.findById(request.getChartOfAccountId())
            .orElseThrow(() -> new NotFoundException("Chart of account not found"));

        if (!account.getCompanyId().equals(companyId)) {
            throw new ValidationException("Chart of account does not belong to the company");
        }

        // Validar Período Contábil
        if (request.getCompetencia().isBefore(company.getPeriodoContabil())) {
            throw new PeriodoContabilViolationException(
                String.format("Competência %s is before Período Contábil %s",
                    request.getCompetencia(), company.getPeriodoContabil())
            );
        }

        // Criar e salvar
        AccountingData data = AccountingData.builder()
            .chartOfAccountId(request.getChartOfAccountId())
            .competencia(request.getCompetencia())
            .debitAmount(request.getDebitAmount())
            .creditAmount(request.getCreditAmount())
            .balance(request.getBalance())
            .description(request.getDescription())
            .status(Status.ACTIVE)
            .build();

        AccountingData saved = accountingDataRepository.save(data);
        return mapper.toResponse(saved);
    }
}
```

**Anotação @EnforcePeriodoContabil:**
```java
@Service
public class UpdateAccountingDataUseCase {

    @EnforcePeriodoContabil
    public AccountingDataResponse execute(Long id, UpdateAccountingDataRequest request) {
        AccountingData data = accountingDataRepository.findById(id)
            .orElseThrow(() -> new NotFoundException("Accounting data not found"));

        // O aspect já validou que competencia >= periodoContabil

        // Atualizar campos
        data.setDebitAmount(request.getDebitAmount());
        data.setCreditAmount(request.getCreditAmount());
        data.setBalance(request.getBalance());
        data.setDescription(request.getDescription());

        AccountingData updated = accountingDataRepository.save(data);
        return mapper.toResponse(updated);
    }
}
```

### Filtros Suportados

- `?chartOfAccountId={id}` - filtrar por conta contábil
- `?competencia=2024-01-31` - filtrar por competência exata
- `?competenciaInicio=2024-01-01&competenciaFim=2024-12-31` - filtrar por range
- `?page=0&size=100&sort=competencia,desc` - paginação e ordenação

### Validações de Negócio

- **chartOfAccountId**: deve existir e pertencer à empresa do contexto
- **competencia**: >= company.periodoContabil
- **debitAmount, creditAmount, balance**: >= 0 (se fornecidos)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-27 | 1.0 | Story criada a partir do Epic 3 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante desenvolvimento*

### Debug Log References
*A ser preenchido durante desenvolvimento*

### Completion Notes List
*A ser preenchido durante desenvolvimento*

### File List
*A ser preenchido durante desenvolvimento*

---

## QA Results
*A ser preenchido após revisão de QA*
