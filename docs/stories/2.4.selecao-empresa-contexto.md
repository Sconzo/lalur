# Story 2.4: Seleção de Empresa (Contexto CONTADOR e ADMIN)

## Status

**Draft**

---

## Story

**As a** CONTADOR ou ADMIN,
**I want** selecionar uma empresa em um dropdown para trabalhar,
**so that** todas minhas operações sejam feitas no contexto da empresa selecionada (obrigatório para CONTADOR, opcional para ADMIN).

---

## Acceptance Criteria

1. Endpoint `GET /api/v1/companies/my-companies` criado (autenticado):
   - Retorna lista de todas empresas ACTIVE (disponível para ADMIN e CONTADOR)
   - DTO `CompanyListItemResponse`: `id`, `cnpj` (formatado), `razaoSocial`

2. Endpoint `POST /api/v1/companies/select-company` criado (autenticado):
   - DTO `SelectCompanyRequest`: `companyId` (obrigatório)
   - DTO `SelectCompanyResponse`: `success`, `companyId`, `companyName`, `message`
   - Disponível para ADMIN e CONTADOR

3. Use case `SelectCompanyUseCase` implementado:
   - Valida que empresa existe e está ACTIVE
   - Retorna confirmação de seleção

4. Implementação do contexto via **header `X-Company-Id`**:
   - Usuário (ADMIN ou CONTADOR) pode enviar `X-Company-Id: {id}` em requisições após seleção
   - Classe `CompanyContextFilter` (implements Filter) criada:
     - Extrai `X-Company-Id` do header (se presente)
     - Valida que empresa existe e está ACTIVE
     - Armazena no `ThreadLocal` (`CompanyContext.setCurrentCompanyId(id)`)
     - Limpa ThreadLocal após request (`finally` block)

5. Classe utilitária `CompanyContext` criada:
   - `static void setCurrentCompanyId(Long id)`
   - `static Long getCurrentCompanyId()`
   - `static void clear()`
   - Usa `ThreadLocal<Long>` internamente

6. Validação automática em repositories:
   - Repositories de entidades relacionadas a empresas filtram automaticamente por `CompanyContext.getCurrentCompanyId()` quando header está presente
   - Exemplo: `ChartOfAccountRepository.findAll()` retorna apenas contas da empresa no contexto

7. Comportamento por role:
   - **CONTADOR**: `X-Company-Id` é **obrigatório** para acessar recursos de empresa (dados contábeis, plano de contas, etc.)
   - **ADMIN**: `X-Company-Id` é **opcional** - pode usar o header (dropdown) ou acessar via path param nos endpoints de CRUD

8. Response 404 Not Found se empresa no header não existe ou está INACTIVE

9. Response 400 Bad Request se `X-Company-Id` ausente e usuário é CONTADOR tentando acessar recurso de empresa

10. Endpoint `GET /api/v1/companies/current-company` retorna empresa selecionada atualmente (autenticado, se header presente)

11. Teste valida:
    - CONTADOR e ADMIN conseguem listar todas empresas ACTIVE via `/my-companies`
    - CONTADOR consegue selecionar qualquer empresa ACTIVE
    - ADMIN consegue selecionar qualquer empresa ACTIVE
    - Tentativa de selecionar empresa INACTIVE retorna 404
    - Tentativa de selecionar empresa inexistente retorna 404
    - Header `X-Company-Id` é validado em requisições subsequentes
    - ThreadLocal é limpo corretamente após cada request
    - CONTADOR é bloqueado de acessar recursos sem header (400)
    - ADMIN pode usar header ou acessar via path param

---

## Tasks / Subtasks

- [ ] Criar DTOs (AC: 1, 2)
  - [ ] Criar `CompanyListItemResponse`
  - [ ] Criar `SelectCompanyRequest`
  - [ ] Criar `SelectCompanyResponse`

- [ ] Criar Use Case (AC: 3)
  - [ ] Implementar `SelectCompanyUseCase`
  - [ ] Validar empresa existe e está ACTIVE
  - [ ] Retornar dados de confirmação

- [ ] Criar endpoints (AC: 1, 2, 10)
  - [ ] Criar `GET /api/v1/companies/my-companies`
  - [ ] Criar `POST /api/v1/companies/select-company`
  - [ ] Criar `GET /api/v1/companies/current-company`
  - [ ] Adicionar autenticação (não requer ADMIN)

- [ ] Implementar CompanyContext com ThreadLocal (AC: 5)
  - [ ] Criar classe `CompanyContext` em `infrastructure/security/`
  - [ ] Implementar `setCurrentCompanyId(Long id)`
  - [ ] Implementar `getCurrentCompanyId()` retornando `Long`
  - [ ] Implementar `clear()` para limpar ThreadLocal
  - [ ] Usar `ThreadLocal<Long>` internamente

- [ ] Implementar CompanyContextFilter (AC: 4)
  - [ ] Criar classe `CompanyContextFilter` implements `Filter`
  - [ ] Extrair header `X-Company-Id` da request
  - [ ] Validar empresa existe e está ACTIVE
  - [ ] Armazenar no `CompanyContext`
  - [ ] Limpar ThreadLocal no `finally` block

- [ ] Implementar validação por role (AC: 7, 8, 9)
  - [ ] CONTADOR: validar presença de header em recursos de empresa
  - [ ] ADMIN: header opcional
  - [ ] Retornar 400 se CONTADOR sem header
  - [ ] Retornar 404 se empresa não existe/INACTIVE

- [ ] Adaptar repositories para usar contexto (AC: 6)
  - [ ] Documentar pattern para repositories futuros
  - [ ] (Implementação real será em stories de plano de contas, etc.)

- [ ] Criar testes de integração (AC: 11)
  - [ ] Testar listagem de empresas (ADMIN e CONTADOR)
  - [ ] Testar seleção de empresa ACTIVE
  - [ ] Testar seleção de empresa INACTIVE (404)
  - [ ] Testar seleção de empresa inexistente (404)
  - [ ] Testar validação de header em requests
  - [ ] Testar limpeza de ThreadLocal
  - [ ] Testar bloqueio de CONTADOR sem header (400)
  - [ ] Testar ADMIN pode usar header ou path param

---

## Dev Notes

### CompanyContext Pattern
**Thread-safe context usando ThreadLocal:**
```java
public class CompanyContext {
    private static final ThreadLocal<Long> currentCompanyId = new ThreadLocal<>();

    public static void setCurrentCompanyId(Long companyId) {
        currentCompanyId.set(companyId);
    }

    public static Long getCurrentCompanyId() {
        return currentCompanyId.get();
    }

    public static void clear() {
        currentCompanyId.remove();
    }
}
```

### CompanyContextFilter Pattern
```java
@Component
@Order(Ordered.HIGHEST_PRECEDENCE + 10)
public class CompanyContextFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
        try {
            HttpServletRequest httpRequest = (HttpServletRequest) request;
            String companyIdHeader = httpRequest.getHeader("X-Company-Id");

            if (companyIdHeader != null) {
                Long companyId = Long.parseLong(companyIdHeader);
                // Validar empresa existe e está ACTIVE
                CompanyContext.setCurrentCompanyId(companyId);
            }

            chain.doFilter(request, response);
        } finally {
            CompanyContext.clear();  // CRÍTICO: sempre limpar
        }
    }
}
```

### Source Tree
```
src/main/java/br/com/lalurecf/
├── application/
│   ├── port/
│   │   └── in/
│   │       └── company/
│   │           └── SelectCompanyUseCase.java
│   └── service/
│       └── CompanyService.java  # Adicionar método selectCompany
├── infrastructure/
│   ├── adapter/
│   │   └── in/
│   │       └── rest/
│   │           └── CompanyController.java  # Adicionar endpoints
│   ├── dto/
│   │   └── company/
│   │       ├── CompanyListItemResponse.java
│   │       ├── SelectCompanyRequest.java
│   │       └── SelectCompanyResponse.java
│   └── security/
│       ├── CompanyContext.java           # ThreadLocal context
│       └── CompanyContextFilter.java     # Servlet Filter
```

### Security Considerations
- ThreadLocal **DEVE** ser limpo no `finally` para evitar memory leaks
- Validar empresa existe antes de armazenar no contexto
- Empresa INACTIVE não pode ser selecionada
- Filter deve ter order correto (após Spring Security, antes de business logic)

### Comportamento por Role
| Role | Header X-Company-Id | Comportamento |
|------|---------------------|---------------|
| CONTADOR | **Obrigatório** | 400 Bad Request se ausente ao acessar recursos de empresa |
| ADMIN | **Opcional** | Pode usar header OU path param (ex: `/companies/{id}/...`) |

### Testing

#### Test Location
```
src/test/java/br/com/lalurecf/
├── infrastructure/
│   ├── adapter/
│   │   └── in/
│   │       └── rest/
│   │           └── CompanyControllerTest.java
│   └── security/
│       ├── CompanyContextTest.java
│       └── CompanyContextFilterTest.java
```

#### Cenários Críticos de Teste
1. **ThreadLocal Cleanup:** Validar que contexto é limpo após request
2. **CONTADOR sem header:** Deve receber 400 ao acessar recursos de empresa
3. **Empresa INACTIVE:** Não pode ser selecionada (404)
4. **Concurrent Requests:** ThreadLocal deve isolar contextos por thread

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-17 | 1.0 | Story criada a partir do Epic 2 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
*A ser preenchido durante implementação*

### Debug Log References
*A ser preenchido durante implementação*

### Completion Notes List
*A ser preenchido durante implementação*

### File List
*A ser preenchido durante implementação*

---

## QA Results
*A ser preenchido após revisão de QA*
